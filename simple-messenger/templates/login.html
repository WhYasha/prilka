{% extends "base.html" %}
{% block title %}Login â€“ Simple Messenger{% endblock %}

{% block body %}
<div class="auth-page">
  <div class="auth-card">
    <div class="auth-logo">ðŸ’¬</div>
    <h1 class="auth-title">Simple Messenger</h1>
    <p class="auth-subtitle">Sign in to your account</p>

    <div id="error-msg" class="alert alert-error hidden"></div>

    <form id="login-form" novalidate>
      <div class="form-group">
        <label for="username">Username</label>
        <input id="username" name="username" type="text"
               autocomplete="username" placeholder="your_username"
               minlength="3" maxlength="32" required />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" name="password" type="password"
               autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
               minlength="6" maxlength="128" required />
      </div>
      <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
        Sign in
      </button>
    </form>

    <p class="auth-footer">
      No account? <a href="/register">Register</a>
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById("login-form");
  const errorEl = document.getElementById("error-msg");
  const submitBtn = document.getElementById("submit-btn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.classList.add("hidden");
    submitBtn.disabled = true;
    submitBtn.textContent = "Signing inâ€¦";

    const body = {
      username: document.getElementById("username").value.trim(),
      password: document.getElementById("password").value,
    };

    try {
      const res = await fetch("/web-api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (res.ok) {
        if (data.cpp_token) localStorage.setItem("cpp_token", data.cpp_token);
        window.location.href = "/app";
      } else {
        errorEl.textContent = data.error || "Login failed.";
        errorEl.classList.remove("hidden");
      }
    } catch {
      errorEl.textContent = "Network error. Please try again.";
      errorEl.classList.remove("hidden");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Sign in";
    }
  });
</script>
{% endblock %}
