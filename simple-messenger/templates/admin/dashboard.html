{% extends "admin_base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="admin-page-title">Dashboard</h1>

<div class="admin-stats-grid">
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.total_users }}</div>
    <div class="stat-label">Total Users</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.dau }}</div>
    <div class="stat-label">Active Today (DAU)</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.wau }}</div>
    <div class="stat-label">Active This Week (WAU)</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.total_chats }}</div>
    <div class="stat-label">Total Chats</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.total_messages }}</div>
    <div class="stat-label">Total Messages</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.messages_today }}</div>
    <div class="stat-label">Messages Today</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.new_users_today }}</div>
    <div class="stat-label">New Users Today</div>
  </div>
  <div class="admin-stat-card">
    <div class="stat-value">{{ stats.blocked_users }}</div>
    <div class="stat-label">Blocked Users</div>
  </div>
</div>

{% if stats.chats_by_type %}
<div class="admin-detail-card">
  <h2>Chats by Type</h2>
  <div class="admin-stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));">
    {% for row in stats.chats_by_type %}
    <div class="admin-stat-card">
      <div class="stat-value">{{ row.cnt }}</div>
      <div class="stat-label">{{ row.type }}</div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% macro bar_chart(title, data, color) %}
<div class="admin-chart-section">
  <h3>{{ title }} (last 14 days)</h3>
  {% if data %}
  {% set max_val = data | map(attribute='cnt') | max %}
  <div class="bar-chart">
    {% for row in data %}
    <div class="bar-row">
      <span class="bar-label">{{ row.day.strftime('%m/%d') if row.day is not string else row.day }}</span>
      <div class="bar-fill" style="width: {{ (row.cnt / max_val * 400) | int if max_val > 0 else 2 }}px; background: {{ color }};"></div>
      <span class="bar-value">{{ row.cnt }}</span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p style="color: var(--admin-text-light);">No data yet.</p>
  {% endif %}
</div>
{% endmacro %}

{{ bar_chart("New Users per Day", stats.users_per_day, "#27ae60") }}
{{ bar_chart("Messages per Day", stats.messages_per_day, "#3498db") }}

{% endblock %}
