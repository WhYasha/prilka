{% extends "admin_base.html" %}
{% block title %}Support{% endblock %}

{% block content %}
<h1 class="admin-page-title">Support Messaging</h1>

<!-- Send message form -->
<div class="admin-support-form">
  <h2>Send Support Message</h2>
  <p style="font-size: 13px; color: var(--admin-text-light); margin-bottom: 12px;">
    Messages are sent as user "BH Support" and prefixed with [SUPPORT].
  </p>
  <form method="POST" action="{{ url_for('admin.support_send') }}">

    <label for="target_user_id">Send to User (direct message)</label>
    <select id="target_user_id" name="target_user_id">
      <option value="">-- Select user --</option>
      {% for u in all_users %}
      <option value="{{ u.id }}">{{ u.username }} ({{ u.display_name or u.username }})</option>
      {% endfor %}
    </select>

    <label for="chat_id">Or send to Chat ID</label>
    <input type="text" id="chat_id" name="chat_id" placeholder="Chat ID (e.g. 5)" style="max-width:200px;" />

    <label for="content">Message</label>
    <textarea id="content" name="content" placeholder="Type your support message..." required></textarea>

    <button type="submit" class="btn btn-primary">Send Message</button>
  </form>
</div>

<!-- Chats with support user -->
{% if chats %}
<h2 class="section-title">Chats with BH Support</h2>
<div class="admin-table-wrap">
  <table class="admin-table">
    <thead>
      <tr><th>Chat ID</th><th>Type</th><th>Name</th><th>Members</th></tr>
    </thead>
    <tbody>
      {% for c in chats %}
      <tr>
        <td><a href="{{ url_for('admin.message_list', chat_id=c.id) }}">{{ c.id }}</a></td>
        <td><span class="badge badge-{{ c.type }}">{{ c.type }}</span></td>
        <td>{{ c.name or c.title or 'DM' }}</td>
        <td>{{ c.member_count }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Recent support messages -->
{% if recent_messages %}
<h2 class="section-title">Recent Support Messages</h2>
<div class="admin-table-wrap">
  <table class="admin-table">
    <thead>
      <tr><th>ID</th><th>Chat</th><th>Content</th><th>Sent</th></tr>
    </thead>
    <tbody>
      {% for m in recent_messages %}
      <tr>
        <td>{{ m.id }}</td>
        <td>
          <a href="{{ url_for('admin.message_list', chat_id=m.chat_id) }}">
            {{ m.chat_name or 'Chat #' ~ m.chat_id }}
          </a>
          <span class="badge badge-{{ m.chat_type }}">{{ m.chat_type }}</span>
        </td>
        <td class="msg-content">{{ (m.content or '')[:120] }}</td>
        <td style="white-space:nowrap;">{{ m.created_at.strftime('%Y-%m-%d %H:%M:%S') if m.created_at else '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p style="color: var(--admin-text-light); margin-top: 24px;">No support messages sent yet.</p>
{% endif %}

{% endblock %}
