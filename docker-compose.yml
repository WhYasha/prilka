# ============================================================
# Messenger – Docker Compose (development)
# Start everything: docker compose up --build -d
# ============================================================

networks:
  messenger_net:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
  prometheus_data:
  grafana_data:
  flask_data:         # persists Flask's SQLite DB across container rebuilds

services:

  # ──────────────────────────────────────────────────────────
  # PostgreSQL 16
  # ──────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTGRES_DB:-messenger}
      POSTGRES_USER:     ${POSTGRES_USER:-messenger}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme_postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"   # dev only – overridden to [] in docker-compose.prod.yml
    networks:
      - messenger_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-messenger} -d ${POSTGRES_DB:-messenger}"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ──────────────────────────────────────────────────────────
  # Redis 7
  # ──────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme_redis}
      --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - messenger_net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme_redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────
  # MinIO (S3-compatible local object storage)
  # Console UI: http://localhost:9001
  # ──────────────────────────────────────────────────────────
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER:     ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-changeme_minio}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # MinIO Console
    networks:
      - messenger_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ──────────────────────────────────────────────────────────
  # MinIO bucket initializer (runs once, then exits)
  # Creates all per-purpose buckets and seeds sticker SVGs.
  # ──────────────────────────────────────────────────────────
  minio_init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - messenger_net
    restart: "no"
    environment:
      MC_HOST_local: "http://${MINIO_ROOT_USER:-minioadmin}:${MINIO_ROOT_PASSWORD:-changeme_minio}@minio:9000"
    volumes:
      - ./infra/minio/stickers:/stickers:ro
    entrypoint: >-
      /bin/sh -c "
      mc mb --ignore-existing local/${MINIO_AVATARS_BUCKET:-bh-avatars} &&
      mc mb --ignore-existing local/${MINIO_UPLOADS_BUCKET:-bh-uploads} &&
      mc mb --ignore-existing local/${MINIO_STICKERS_BUCKET:-bh-stickers} &&
      mc mb --ignore-existing local/${MINIO_TESTS_BUCKET:-bh-test-artifacts} &&
      mc anonymous set none local/${MINIO_AVATARS_BUCKET:-bh-avatars} &&
      mc anonymous set none local/${MINIO_UPLOADS_BUCKET:-bh-uploads} &&
      mc anonymous set none local/${MINIO_STICKERS_BUCKET:-bh-stickers} &&
      mc anonymous set none local/${MINIO_TESTS_BUCKET:-bh-test-artifacts} &&
      mc cp /stickers/s01.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s01.svg &&
      mc cp /stickers/s02.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s02.svg &&
      mc cp /stickers/s03.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s03.svg &&
      mc cp /stickers/s04.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s04.svg &&
      mc cp /stickers/s05.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s05.svg &&
      mc cp /stickers/s06.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s06.svg &&
      mc cp /stickers/s07.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s07.svg &&
      mc cp /stickers/s08.svg local/${MINIO_STICKERS_BUCKET:-bh-stickers}/stickers/s08.svg &&
      echo 'MinIO buckets and stickers ready.'
      "

  # ──────────────────────────────────────────────────────────
  # Flyway – database migrations
  # Runs once and exits; api_cpp depends on it completing.
  # ──────────────────────────────────────────────────────────
  flyway:
    image: flyway/flyway:10-alpine
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - messenger_net
    restart: "no"
    command: >
      -url=jdbc:postgresql://postgres:5432/${POSTGRES_DB:-messenger}
      -user=${POSTGRES_USER:-messenger}
      -password=${POSTGRES_PASSWORD:-changeme_postgres}
      -locations=filesystem:/flyway/sql
      -connectRetries=10
      migrate
    volumes:
      - ./migrations:/flyway/sql:ro

  # ──────────────────────────────────────────────────────────
  # C++ API (Drogon) — main backend
  # REST + WebSocket at :8080
  # ──────────────────────────────────────────────────────────
  api_cpp:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
      minio_init:
        condition: service_completed_successfully
    environment:
      DB_HOST:                postgres
      DB_PORT:                5432
      DB_NAME:                ${POSTGRES_DB:-messenger}
      DB_USER:                ${POSTGRES_USER:-messenger}
      DB_PASS:                ${POSTGRES_PASSWORD:-changeme_postgres}
      REDIS_HOST:             redis
      REDIS_PORT:             6379
      REDIS_PASS:             ${REDIS_PASSWORD:-changeme_redis}
      MINIO_ENDPOINT:         minio:9000
      MINIO_ACCESS_KEY:       ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY:       ${MINIO_ROOT_PASSWORD:-changeme_minio}
      MINIO_AVATARS_BUCKET:   ${MINIO_AVATARS_BUCKET:-bh-avatars}
      MINIO_UPLOADS_BUCKET:   ${MINIO_UPLOADS_BUCKET:-bh-uploads}
      MINIO_STICKERS_BUCKET:  ${MINIO_STICKERS_BUCKET:-bh-stickers}
      MINIO_PRESIGN_TTL:      ${MINIO_PRESIGN_TTL:-900}
      MINIO_PUBLIC_URL:       ${MINIO_PUBLIC_URL:-http://localhost:9000}
      JWT_SECRET:             ${JWT_SECRET:-change-me-in-production}
      JWT_ACCESS_TTL:         ${JWT_ACCESS_TTL:-3600}
      JWT_REFRESH_TTL:        ${JWT_REFRESH_TTL:-604800}
      MAX_FILE_SIZE_MB:       ${MAX_FILE_SIZE_MB:-50}
      API_THREADS:            ${API_THREADS:-0}
      API_PORT:               ${API_PORT:-8080}
    ports:
      - "8080:8080"
    networks:
      - messenger_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────
  # Legacy Flask messenger (existing frontend, kept for UI)
  # Serves the SPA at http://localhost:5000
  # Uses PostgreSQL via psycopg2 (see simple-messenger/README)
  # TODO: migrate frontend to call api_cpp directly
  # ──────────────────────────────────────────────────────────
  api_legacy:
    build:
      context: ./simple-messenger
      dockerfile: Dockerfile.legacy
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
      minio_init:
        condition: service_completed_successfully
    environment:
      DATABASE_URL:           "postgresql://${POSTGRES_USER:-messenger}:${POSTGRES_PASSWORD:-changeme_postgres}@postgres:5432/${POSTGRES_DB:-messenger}"
      SECRET_KEY:             ${JWT_SECRET:-change-me-in-production}
      MINIO_ENDPOINT:         minio:9000
      MINIO_ACCESS_KEY:       ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY:       ${MINIO_ROOT_PASSWORD:-changeme_minio}
      MINIO_AVATARS_BUCKET:   ${MINIO_AVATARS_BUCKET:-bh-avatars}
      MINIO_STICKERS_BUCKET:  ${MINIO_STICKERS_BUCKET:-bh-stickers}
      MINIO_PRESIGN_TTL:      ${MINIO_PRESIGN_TTL:-900}
      MINIO_PUBLIC_URL:       ${MINIO_PUBLIC_URL:-http://localhost:9000}
      REDIS_HOST:             redis
      REDIS_PORT:             6379
      REDIS_PASSWORD:         ${REDIS_PASSWORD:-changeme_redis}
      CPP_API_URL:            "http://api_cpp:8080"
      DB_PATH:                /app/data/messenger.db
    volumes:
      - flask_data:/app/data
    ports:
      - "5000:5000"
    networks:
      - messenger_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────
  # Prometheus
  # UI: http://localhost:9090
  # ──────────────────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v2.51.0
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - messenger_net

  # ──────────────────────────────────────────────────────────
  # Grafana
  # UI: http://localhost:3000  (admin / admin by default)
  # ──────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:10.4.0
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER:     ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP:     "false"
      GF_INSTALL_PLUGINS:         ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      - messenger_net
    depends_on:
      - prometheus

  # ──────────────────────────────────────────────────────────
  # cAdvisor – container metrics
  # NOTE: disabled on Windows Docker Desktop (requires Linux cgroups).
  # Uncomment on a Linux host / Linux CI runner.
  # ──────────────────────────────────────────────────────────
  # cadvisor:
  #   image: gcr.io/cadvisor/cadvisor:v0.49.1
  #   restart: unless-stopped
  #   privileged: true
  #   volumes:
  #     - /:/rootfs:ro
  #     - /var/run:/var/run:rw
  #     - /sys:/sys:ro
  #     - /var/lib/docker:/var/lib/docker:ro
  #   ports:
  #     - "8081:8080"
  #   networks:
  #     - messenger_net
  #   command:
  #     - "--housekeeping_interval=15s"
  #     - "--docker_only=true"
