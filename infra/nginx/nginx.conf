# ============================================================
# Nginx – Messenger reverse proxy (HTTP only)
# TODO: when a domain is available:
#   1. Add a server block on port 443 with ssl_certificate / ssl_certificate_key
#   2. Add `return 301 https://$host$request_uri;` in the port-80 block
#   3. Remove the plain-HTTP server block (or keep for redirect)
# ============================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid       /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout 65;
    server_tokens   off;

    # ── Logging ────────────────────────────────────────────────────────────────
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
    access_log /var/log/nginx/access.log main;

    # ── Gzip ───────────────────────────────────────────────────────────────────
    gzip on;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml image/svg+xml;
    gzip_min_length 1024;

    # ── Proxy defaults ─────────────────────────────────────────────────────────
    proxy_http_version      1.1;
    proxy_set_header        Host              $host;
    proxy_set_header        X-Real-IP         $remote_addr;
    proxy_set_header        X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
    proxy_read_timeout      60s;
    proxy_connect_timeout   10s;
    proxy_send_timeout      60s;

    # ── WebSocket upgrade map ──────────────────────────────────────────────────
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ── Rate limiting ──────────────────────────────────────────────────────────
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

    # ==========================================================================
    # Main server – HTTP :80
    # ==========================================================================
    server {
        listen 80;
        server_name _;          # matches any IP; replace with real domain later

        client_max_body_size 60m;

        # ── Health (nginx-level, for Docker healthcheck) ─────────────────────
        location = /health {
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }

        # ── Static downloads (Windows / macOS installers) ────────────────────
        # Files live in infra/nginx/downloads/{windows,macos}/
        # Upload: scp installer.exe deploy@<SERVER_IP>:/opt/messenger/repo/infra/nginx/downloads/windows/
        location /downloads/ {
            root /usr/share/nginx/html;
            autoindex off;
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        # ── REST API (C++ Drogon backend) ─────────────────────────────────────
        location /api/ {
            limit_req zone=api_limit burst=60 nodelay;
            proxy_pass http://api_cpp:8080;
        }

        # ── WebSocket endpoint ────────────────────────────────────────────────
        location /ws {
            proxy_pass http://api_cpp:8080;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_read_timeout  3600s;   # long-lived WS connections
            proxy_send_timeout  3600s;
        }

        # ── Grafana (sub-path mode) ───────────────────────────────────────────
        # Restrict to your IP: uncomment and set YOUR_ADMIN_IP
        # allow YOUR_ADMIN_IP;
        # deny all;
        location /grafana/ {
            proxy_pass http://grafana:3000/;
            proxy_set_header Host $host;
        }

        # ── MinIO S3 API ──────────────────────────────────────────────────────
        location /minio/ {
            # Restrict to internal / known IPs in production
            # allow 10.0.0.0/8;
            # deny all;
            proxy_pass http://minio:9000/;
            proxy_set_header Host $host;
            # Required for large uploads
            client_max_body_size 0;
            proxy_request_buffering off;
        }

        # ── MinIO Console ─────────────────────────────────────────────────────
        location /minio-console/ {
            proxy_pass http://minio:9001/;
            proxy_set_header Host              $host;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
            # Restrict access in production (remove comment):
            # allow YOUR_ADMIN_IP;
            # deny all;
        }

        # ── Frontend (Legacy Flask SPA) ───────────────────────────────────────
        location / {
            proxy_pass http://api_legacy:5000;
        }
    }
}
