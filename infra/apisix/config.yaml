# ============================================================
# APISIX – Server Configuration (Standalone / YAML mode)
# No etcd required — routes defined in apisix.yaml
# ============================================================

apisix:
  node_listen:
    - port: 9080          # HTTP  (mapped to host :80 in docker-compose.prod.yml)

  ssl:
    listen:
      - port: 9443        # HTTPS (mapped to host :443)
    # Certs are injected into apisix.yaml by inject-certs.sh at deploy time
    ssl_trusted_certificate: /etc/ssl/certs/ca-certificates.crt

  enable_http2: true

  enable_control: true
  control:
    ip: "0.0.0.0"
    port: 9092

deployment:
  role: data_plane
  role_data_plane:
    config_provider: yaml

nginx_config:
  http:
    client_max_body_size: 60m
    keepalive_timeout: 65s
    gzip: "on"
    gzip_types: "text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml"
    gzip_min_length: 1024

  http_server_configuration_snippet: |
    proxy_http_version 1.1;

    # WebSocket bypass — APISIX enable_websocket is unreliable in 3.15.
    # Prefix-match location takes priority over APISIX's catch-all location /.
    location = /ws {
        set $ws_backend api_cpp;
        resolver 127.0.0.11 valid=30s;
        rewrite ^/ws/?$ /ws break;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://$ws_backend:8080;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

plugin_attr:
  prometheus:
    export_addr:
      ip: "0.0.0.0"
      port: 9091

plugins:
  - proxy-rewrite
  - redirect
  - limit-req
  - cors
  - real-ip
  - response-rewrite
  - proxy-mirror
  - serverless-pre-function
  - serverless-post-function
