# ============================================================
# Messenger – Docker Compose PRODUCTION override
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================================
# All secrets must live in /opt/messenger/env/.env (chmod 600)
# OR be managed via HashiCorp Vault (Phase 2+).
# This file is safe to commit – it contains no secrets.
# ============================================================

networks:
  messenger_net:
    driver: bridge

services:

  # ── Close dev ports; traffic enters only through APISIX ────────────────────
  postgres:
    ports: !reset []              # clear dev port mapping

  minio:
    ports: !reset []              # APISIX proxies minio-console.behappy.rest -> :9001
    environment:
      MINIO_BROWSER_REDIRECT_URL: "https://minio-console.behappy.rest/"

  api_cpp:
    ports: !reset []              # clear dev port mapping; only APISIX exposes 80/443
    restart: always
    environment:
      API_THREADS:     "0"        # auto = nproc
      MINIO_PUBLIC_URL: "https://behappy.rest/minio"

  prometheus:
    ports: !reset []              # clear dev port mapping
    restart: always

  grafana:
    ports: !reset []              # clear dev port mapping
    restart: always
    environment:
      GF_SERVER_ROOT_URL:            "https://grafana.behappy.rest/"
      GF_SERVER_SERVE_FROM_SUB_PATH: "false"

  # ── cAdvisor – enabled on Linux hosts ────────────────────────────────────────
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    restart: always
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
    networks:
      - messenger_net
    command:
      - "--housekeeping_interval=15s"
      - "--docker_only=true"

  # ── APISIX reverse proxy (replaces nginx) ──────────────────────────────────
  apisix:
    restart: always
    user: root              # Required to read Let's Encrypt certs (same as nginx)
    ports: !override
      - "80:9080"
      - "443:9443"
    volumes: !override
      - ./infra/apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      - ./infra/apisix/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./infra/nginx/downloads:/usr/share/nginx/html/downloads:ro
      - /opt/messenger/certbot-webroot:/var/www/certbot:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:9080/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ── Vault – production overrides ────────────────────────────────────────────
  vault:
    ports: !override
      - "127.0.0.1:8200:8200"    # localhost only — needed by deploy-time Vault Agent
    restart: always

  # ── Consul – production overrides ───────────────────────────────────────────
  consul:
    ports: !override
      - "127.0.0.1:8500:8500"    # localhost only — needed by Nomad + admin
      - "127.0.0.1:8600:8600/udp"
    restart: always

  # ── Nomad – enabled in production (Phase 4) ────────────────────────────────
  # Uncomment when ready to migrate to Nomad orchestration.
  # nomad:
  #   image: hashicorp/nomad:1.7
  #   restart: always
  #   cap_add:
  #     - SYS_ADMIN
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - nomad_data:/nomad/data
  #     - ./infra/nomad/config.hcl:/nomad/config.hcl:ro
  #   command: nomad agent -config=/nomad/config.hcl
  #   networks:
  #     - messenger_net
  #   depends_on:
  #     - consul
  #     - vault

  # ── nginx (DEPRECATED – replaced by APISIX) ────────────────────────────────
  # Kept commented out for rollback reference. Remove after APISIX is stable.
  # nginx:
  #   image: nginx:1.27-alpine
  #   restart: always
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./infra/nginx/downloads:/usr/share/nginx/html/downloads:ro
  #     - /etc/letsencrypt:/etc/letsencrypt:ro
  #     - /opt/messenger/certbot-webroot:/var/www/certbot:ro
  #   networks:
  #     - messenger_net
  #   depends_on:
  #     - api_cpp
  #     - grafana
  #     - minio
  #   healthcheck:
  #     test: ["CMD", "wget", "-qO-", "http://127.0.0.1/health"]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 5
