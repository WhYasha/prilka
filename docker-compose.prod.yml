# ============================================================
# Messenger – Docker Compose PRODUCTION override
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================================
# All secrets must live in /opt/messenger/env/.env (chmod 600).
# This file is safe to commit – it contains no secrets.
# ============================================================

networks:
  messenger_net:
    driver: bridge

services:

  # ── Close dev ports; traffic enters only through nginx ──────────────────────
  postgres:
    ports: !reset []              # clear dev port mapping

  minio:
    ports: !reset []              # nginx proxies /minio-console -> :9001
    environment:
      MINIO_BROWSER_REDIRECT_URL: "https://behappy.rest/minio-console/"

  api_legacy:
    ports: !reset []              # clear dev port mapping; nginx proxies /admin

  api_cpp:
    ports: !reset []              # clear dev port mapping; only nginx exposes 80/443
    restart: always
    environment:
      API_THREADS:     "0"        # auto = nproc
      MINIO_PUBLIC_URL: "https://behappy.rest/minio"

  prometheus:
    ports: !reset []              # clear dev port mapping
    restart: always

  grafana:
    ports: !reset []              # clear dev port mapping
    restart: always
    environment:
      GF_SERVER_ROOT_URL: "https://behappy.rest/grafana/"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"

  # ── cAdvisor – enabled on Linux hosts ────────────────────────────────────────
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    restart: always
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
    networks:
      - messenger_net
    command:
      - "--housekeeping_interval=15s"
      - "--docker_only=true"

  # ── Nginx reverse proxy ───────────────────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infra/nginx/downloads:/usr/share/nginx/html/downloads:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /opt/messenger/certbot-webroot:/var/www/certbot:ro
    networks:
      - messenger_net
    depends_on:
      - api_cpp
      - grafana
      - minio
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1/health"]
      interval: 15s
      timeout: 5s
      retries: 5
