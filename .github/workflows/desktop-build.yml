name: Desktop Build & Publish

on:
  push:
    tags:
      - 'v*'              # Build on version tags: v0.1.0, v1.0.0, etc.
  workflow_dispatch:        # Manual trigger from GitHub UI
    inputs:
      publish:
        description: 'Publish artifacts to server'
        type: boolean
        default: false

# Cancel in-progress runs for the same ref
concurrency:
  group: desktop-${{ github.ref }}
  cancel-in-progress: true

env:
  FRONTEND_DIR: frontend

jobs:
  # ── Build Windows installer ─────────────────────────────────────────────────
  build-windows:
    name: Build Windows (NSIS)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.FRONTEND_DIR }}/src-tauri/target
          key: rust-windows-${{ hashFiles('frontend/src-tauri/Cargo.lock') }}
          restore-keys: rust-windows-

      - name: Install npm dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build Vue frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build

      - name: Build Tauri
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npx tauri build

      - name: Prepare artifacts
        shell: pwsh
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          $version = (Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version
          $nsis = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis" -Filter "*.exe" | Select-Object -First 1

          New-Item -ItemType Directory -Force -Path "dist-desktop/windows" | Out-Null

          Copy-Item $nsis.FullName "dist-desktop/windows/MessengerSetup.exe"
          Copy-Item $nsis.FullName "dist-desktop/windows/MessengerSetup-${version}.exe"

          $hash = (Get-FileHash "dist-desktop/windows/MessengerSetup.exe" -Algorithm SHA256).Hash.ToLower()
          "$hash  MessengerSetup.exe" | Out-File -Encoding ascii "dist-desktop/windows/MessengerSetup.exe.sha256"

          @{
              version = $version
              date    = (Get-Date -Format "yyyy-MM-dd")
              url     = "https://behappy.rest/downloads/windows/MessengerSetup.exe"
              sha256  = $hash
          } | ConvertTo-Json | Out-File -Encoding utf8 "dist-desktop/windows/latest.json"

          Write-Host "Artifact: $($nsis.FullName)"
          Write-Host "Size: $([math]::Round($nsis.Length / 1MB, 2)) MB"
          Write-Host "SHA256: $hash"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ${{ env.FRONTEND_DIR }}/dist-desktop/windows/
          retention-days: 30

  # ── Build macOS DMG ─────────────────────────────────────────────────────────
  build-macos:
    name: Build macOS (DMG)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.FRONTEND_DIR }}/src-tauri/target
          key: rust-macos-${{ hashFiles('frontend/src-tauri/Cargo.lock') }}
          restore-keys: rust-macos-

      - name: Install npm dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build Vue frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build

      - name: Build Tauri
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npx tauri build

      - name: Prepare artifacts
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          VERSION=$(node -e "console.log(require('./src-tauri/tauri.conf.json').version)")
          DMG=$(find src-tauri/target/release/bundle/dmg -name "*.dmg" | head -1)

          mkdir -p dist-desktop/macos

          cp "$DMG" dist-desktop/macos/Messenger.dmg
          cp "$DMG" "dist-desktop/macos/Messenger-${VERSION}.dmg"

          HASH=$(shasum -a 256 dist-desktop/macos/Messenger.dmg | awk '{print $1}')
          echo "$HASH  Messenger.dmg" > dist-desktop/macos/Messenger.dmg.sha256

          cat > dist-desktop/macos/latest.json <<EOF
          {
            "version": "${VERSION}",
            "date": "$(date +%Y-%m-%d)",
            "url": "https://behappy.rest/downloads/macos/Messenger.dmg",
            "sha256": "${HASH}"
          }
          EOF

          echo "Artifact: $DMG"
          echo "Size: $(du -h dist-desktop/macos/Messenger.dmg | awk '{print $1}')"
          echo "SHA256: $HASH"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: ${{ env.FRONTEND_DIR }}/dist-desktop/macos/
          retention-days: 30

  # ── Publish to server ───────────────────────────────────────────────────────
  publish:
    name: Publish to Server
    needs: [build-windows, build-macos]
    runs-on: [self-hosted, linux, x64]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: artifacts/windows

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: artifacts/macos

      - name: Deploy to server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: behappy.rest
          DEPLOY_USER: deploy
          DEPLOY_PATH: /opt/messenger/repo/infra/nginx/downloads
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/deploy_key"

          echo "==> Uploading Windows installer..."
          scp $SSH_OPTS artifacts/windows/* "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/windows/"

          echo "==> Uploading macOS installer..."
          scp $SSH_OPTS artifacts/macos/* "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/macos/"

          echo "==> Verifying..."
          ssh $SSH_OPTS "${DEPLOY_USER}@${DEPLOY_HOST}" "ls -lh ${DEPLOY_PATH}/windows/ ${DEPLOY_PATH}/macos/"

          echo "==> Done! Installers published."
