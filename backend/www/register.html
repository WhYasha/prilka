<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Register – Simple Messenger</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body data-theme="light">
<div class="auth-page">
  <div class="auth-card">
    <div class="auth-logo">&#128172;</div>
    <h1 class="auth-title">Simple Messenger</h1>
    <p class="auth-subtitle">Create a new account</p>

    <div id="error-msg" class="alert alert-error hidden"></div>

    <form id="register-form" novalidate>
      <div class="form-group">
        <label for="username">Username</label>
        <input id="username" name="username" type="text"
               autocomplete="username" placeholder="choose_a_username"
               minlength="3" maxlength="32" required />
        <span class="form-hint">3–32 chars, letters/digits/- _</span>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" name="email" type="email"
               autocomplete="email" placeholder="you@example.com"
               maxlength="128" required />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" name="password" type="password"
               autocomplete="new-password" placeholder="at least 6 characters"
               minlength="6" maxlength="128" required />
      </div>
      <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
        Create account
      </button>
    </form>

    <p class="auth-footer">
      Already have an account? <a href="/login">Sign in</a>
    </p>
  </div>
</div>
<script>
  // Apply saved theme
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.setAttribute("data-theme", savedTheme);

  const form      = document.getElementById("register-form");
  const errorEl   = document.getElementById("error-msg");
  const submitBtn = document.getElementById("submit-btn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.classList.add("hidden");
    submitBtn.disabled = true;
    submitBtn.textContent = "Creating…";

    const body = {
      username: document.getElementById("username").value.trim(),
      email:    document.getElementById("email").value.trim(),
      password: document.getElementById("password").value,
    };

    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (res.ok) {
        // Auto-login after registration
        const loginRes = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: body.username, password: body.password }),
        });
        if (loginRes.ok) {
          const loginData = await loginRes.json();
          localStorage.setItem("access_token", loginData.access_token);
          if (loginData.refresh_token) localStorage.setItem("refresh_token", loginData.refresh_token);
        }
        window.location.href = "/app";
      } else {
        errorEl.textContent = data.error || "Registration failed.";
        errorEl.classList.remove("hidden");
      }
    } catch {
      errorEl.textContent = "Network error. Please try again.";
      errorEl.classList.remove("hidden");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Create account";
    }
  });
</script>
</body>
</html>
