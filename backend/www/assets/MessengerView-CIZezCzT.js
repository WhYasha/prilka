import{k as O,l as ce,r as k,m as L,n as se,u as Y,d as I,o as y,c as w,w as j,p as W,g as E,a as e,b as x,f as ne,t as M,e as F,v as V,F as H,q as K,s as A,x as P,y as le,z as oe,A as G,B as ke,C as Q,D as ue,E as re,G as te,j as pe,H as ve,I as we,J as Ce,K as $e,L as Se}from"./index-GTORmK_T.js";import{_ as q,l as xe,c as Me,r as Te}from"./invites-CfLTYYx3.js";async function Ue(){const{data:t}=await O.get("/chats");return t}async function De(t){const{data:o}=await O.get(`/chats/${t}`);return o}async function Ne(t){const{data:o}=await O.get(`/chats/by-name/${encodeURIComponent(t)}`);return o}async function ae(t){const{data:o}=await O.post("/chats",t);return o}async function Le(t){await O.post(`/chats/${t}/favorite`)}async function Pe(t){await O.delete(`/chats/${t}/favorite`)}async function Oe(t,o){await O.post(`/chats/${t}/mute`,{})}async function Fe(t){await O.delete(`/chats/${t}/mute`)}async function Ie(t){await O.delete(`/chats/${t}/leave`)}async function Re(t){await O.post(`/chats/${t}/read`)}const J=ce("chats",()=>{const t=k([]),o=k(null),i=k({}),r=k(new Set),n=L(()=>t.value.find(a=>a.id===o.value)??null),f=L(()=>[...t.value].sort((a,h)=>{if(a.is_favorite&&!h.is_favorite)return-1;if(!a.is_favorite&&h.is_favorite)return 1;const S=a.last_at||a.updated_at||"";return(h.last_at||h.updated_at||"").localeCompare(S)}));async function u(){try{t.value=await Ue()}catch(a){console.error("Failed to load chats",a)}}function m(a){if(o.value=a,a!==null){const h=t.value.find(S=>S.id===a);h&&h.unread_count>0&&(h.unread_count=0,Re(a).catch(()=>{}))}}async function _(a){const h=t.value.find(S=>S.id===a);if(h)try{h.is_favorite?await Pe(a):await Le(a),h.is_favorite=!h.is_favorite}catch(S){throw console.error("Failed to toggle favorite",S),S}}async function c(a){const h=t.value.find(S=>S.id===a);if(h)try{h.is_muted?await Fe(a):await Oe(a),h.is_muted=!h.is_muted}catch(S){throw console.error("Failed to toggle mute",S),S}}async function d(a){await Ie(a),t.value=t.value.filter(h=>h.id!==a),o.value===a&&(o.value=null)}function s(a,h,S){const R=t.value.find(z=>z.id===a);R&&(R.last_message=h,R.last_at=S)}function p(a){const h=t.value.find(S=>S.id===a);h&&(h.unread_count=(h.unread_count||0)+1)}function b(a,h,S){i.value[a]||(i.value[a]={});const R=i.value[a][h];R&&clearTimeout(R.timer);const z=setTimeout(()=>{C(a,h)},3e3);i.value[a][h]={username:S,timer:z}}function C(a,h){if(i.value[a]){const S=i.value[a][h];S&&(clearTimeout(S.timer),delete i.value[a][h])}}function $(a){const h=i.value[a];return h?Object.values(h).map(S=>S.username):[]}function U(a){r.value=new Set([...r.value,a])}function T(a){const h=new Set(r.value);h.delete(a),r.value=h}function D(a){return r.value.has(a)}return{chats:t,activeChatId:o,activeChat:n,sortedChats:f,typingUsers:i,loadChats:u,setActiveChat:m,toggleFavorite:_,toggleMute:c,leave:d,updateChatLastMessage:s,incrementUnread:p,setTyping:b,clearTyping:C,getTypingUsernames:$,onlineUsers:r,setUserOnline:U,setUserOffline:T,isUserOnline:D}});async function Be(){const{data:t}=await O.get("/settings");return t}async function Ee(t){await O.put("/settings",t)}const de=ce("settings",()=>{const t=k(localStorage.getItem("theme")||"light"),o=k(!0),i=k("en");function r(u){t.value=u,document.body.setAttribute("data-theme",u),localStorage.setItem("theme",u)}async function n(){try{const u=await Be();r(u.theme||"light"),o.value=u.notifications_enabled,i.value=u.language||"en"}catch(u){console.error("Failed to load settings",u)}}async function f(u){await Ee(u),u.theme&&r(u.theme),u.notifications_enabled!==void 0&&(o.value=u.notifications_enabled),u.language&&(i.value=u.language)}return document.body.setAttribute("data-theme",t.value),{theme:t,notificationsEnabled:o,language:i,applyTheme:r,loadSettings:n,saveSettings:f}});async function ie(t,o){const{data:i}=await O.get(`/chats/${t}/messages`,{params:o});return i}async function Ve(t,o){const{data:i}=await O.post(`/chats/${t}/messages`,o);return i}const he=ce("messages",()=>{const t=k({}),o=k({}),i=k(null);async function r(c){i.value=c;try{const d=await ie(c,{limit:50});t.value[c]=d,d.length>0&&(o.value[c]=Math.max(...d.map(s=>s.id)))}catch(d){throw console.error("Failed to load messages",d),d}finally{i.value=null}}async function n(c){const d=o.value[c]||0;if(d===0)return[];try{const s=await ie(c,{after_id:d,limit:50});if(s.length>0){t.value[c]||(t.value[c]=[]);const p=new Set(t.value[c].map(C=>C.id)),b=s.filter(C=>!p.has(C.id));t.value[c].push(...b),o.value[c]=Math.max(...s.map(C=>C.id))}return s}catch(s){return console.error("Failed to load newer messages",s),[]}}async function f(c){const d=t.value[c];if(!d||d.length===0)return[];const s=d[0];if(!s)return[];try{const p=await ie(c,{before:s.created_at,limit:50});if(p.length>0){const b=new Set(d.map($=>$.id)),C=p.filter($=>!b.has($.id));t.value[c]=[...C,...d]}return p}catch(p){return console.error("Failed to load older messages",p),[]}}async function u(c,d,s="text",p){const b=await Ve(c,{content:d,type:s,...p});return t.value[c]||(t.value[c]=[]),t.value[c].push(b),o.value[c]=Math.max(o.value[c]||0,b.id),b}function m(c,d){t.value[c]||(t.value[c]=[]),t.value[c].find(p=>p.id===d.id)||(t.value[c].push(d),o.value[c]=Math.max(o.value[c]||0,d.id))}function _(c){return t.value[c]||[]}return{messagesByChat:t,lastMsgId:o,loadingChat:i,loadMessages:r,loadNewer:n,loadOlder:f,sendMessage:u,pushMessage:m,getMessages:_}});function Ae(t,o,i){if(!document.hidden||t.sender_id===i.user?.id||!de().notificationsEnabled||!("Notification"in window)||Notification.permission!=="granted"||o.chats.find(_=>_.id===t.chat_id)?.is_muted)return;const f=t.sender_display_name||t.sender_username||"Someone",u=t.message_type==="text"?t.content?.length>100?t.content.substring(0,100)+"...":t.content:`sent a ${t.message_type==="sticker"?"sticker":t.message_type==="voice"?"voice message":"file"}`,m=new Notification(f,{body:u,tag:`chat-${t.chat_id}`,silent:!1});m.onclick=()=>{window.focus(),o.setActiveChat(t.chat_id),m.close()},setTimeout(()=>m.close(),5e3)}function We(){const t=k(!1);let o=null,i=null,r=null,n=1e3,f=!1;function u(){const $=localStorage.getItem("access_token");return $?`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?token=${encodeURIComponent($)}`:null}function m(){if(o&&(o.readyState===WebSocket.OPEN||o.readyState===WebSocket.CONNECTING))return;const $=u();$&&(f=!1,o=new WebSocket($),o.onopen=()=>{t.value=!0,n=1e3;const U=localStorage.getItem("access_token");U&&o.send(JSON.stringify({type:"auth",token:U}));const T=J();for(const D of T.chats)o.send(JSON.stringify({type:"subscribe",chat_id:D.id}));c()},o.onmessage=U=>{try{const T=JSON.parse(U.data);_(T)}catch{}},o.onclose=()=>{t.value=!1,d(),f||s()},o.onerror=()=>{})}function _($){const U=he(),T=J(),D=Y();switch($.type){case"message":{const a=$;U.pushMessage(a.chat_id,a),T.updateChatLastMessage(a.chat_id,a.content||(a.message_type==="sticker"?"Sticker":"Attachment"),a.created_at),a.chat_id!==T.activeChatId&&a.sender_id!==D.user?.id&&T.incrementUnread(a.chat_id),T.clearTyping(a.chat_id,a.sender_id),Ae(a,T,D);break}case"typing":{const a=$.chat_id,h=$.user_id;if(h!==D.user?.id){const S=$.username||"Someone";T.setTyping(a,h,S)}break}case"pong":break;case"presence":{const a=$.user_id,h=$.status;h==="online"?T.setUserOnline(a):h==="offline"&&T.setUserOffline(a);break}}}function c(){d(),r=setInterval(()=>{o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"ping"}))},25e3)}function d(){r&&(clearInterval(r),r=null)}function s(){i||(i=setTimeout(()=>{i=null,m(),n=Math.min(n*2,3e4)},n))}function p($){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"subscribe",chat_id:$}))}function b($){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"typing",chat_id:$}))}function C(){f=!0,d(),i&&(clearTimeout(i),i=null),o&&(o.close(),o=null),t.value=!1}return se(()=>{C()}),{connected:t,connect:m,disconnect:C,subscribeToChat:p,sendTyping:b}}async function ze(t){const{data:o}=await O.get(`/users/${t}`);return o}async function ge(t){const{data:o}=await O.get(`/users/by-username/${encodeURIComponent(t)}`);return o}async function me(t){const{data:o}=await O.get("/users/search",{params:{q:t}});return o}async function He(t,o){const{data:i}=await O.put(`/users/${t}`,o);return i}async function Ge(t){const{data:o}=await O.put("/users/me/avatar",{file_id:t});return o}async function Je(){const{data:t}=await O.get("/stickers");return t}const je={class:"chat-item-info"},qe={class:"chat-item-top"},Ze={class:"chat-item-name"},Ke={key:0,class:"ci-channel"},Ye={key:1,class:"ci-group"},Qe={key:2,class:"mute-icon",title:"Muted"},Xe={key:0,class:"unread-badge"},et={class:"chat-item-time"},tt={class:"chat-item-preview"},nt=["title"],fe=I({__name:"ChatListItem",props:{chat:{},active:{type:Boolean}},emits:["select","toggleFavorite","contextmenu"],setup(t,{emit:o}){const i=t,r=J(),n=L(()=>i.chat.type!=="direct"||!i.chat.other_user_id?null:r.isUserOnline(i.chat.other_user_id)||null),f=o,u=L(()=>{const _=i.chat;return _.type==="channel"||_.type==="group"?_.title||_.name||"Untitled":_.other_display_name||_.other_username||_.title||_.name||"Chat"});function m(_){if(!_)return"";const c=new Date(_.endsWith("Z")?_:_+"Z"),d=new Date;return c.toDateString()===d.toDateString()?c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):c.toLocaleDateString([],{month:"short",day:"numeric"})}return(_,c)=>(y(),w("div",{class:W(["chat-item",{active:t.active}]),onClick:c[1]||(c[1]=d=>f("select")),onContextmenu:c[2]||(c[2]=j(d=>f("contextmenu",d),["prevent"]))},[E(q,{name:u.value,url:t.chat.other_avatar_url,size:"sm",online:n.value},null,8,["name","url","online"]),e("div",je,[e("div",qe,[e("span",Ze,[t.chat.type==="channel"?(y(),w("span",Ke)):t.chat.type==="group"?(y(),w("span",Ye)):x("",!0),ne(" "+M(u.value)+" ",1),t.chat.is_muted?(y(),w("span",Qe,"ðŸ””")):x("",!0)]),t.chat.unread_count>0?(y(),w("span",Xe,M(t.chat.unread_count>99?"99+":t.chat.unread_count),1)):x("",!0),e("span",et,M(m(t.chat.last_at||t.chat.updated_at)),1)]),e("div",tt,M(t.chat.last_message||""),1)]),e("button",{class:W(["star-btn",{"star-active":t.chat.is_favorite}]),title:t.chat.is_favorite?"Unstar":"Star",onClick:c[0]||(c[0]=j(d=>f("toggleFavorite"),["stop"]))},"â˜…",10,nt)],34))}}),at={class:"sidebar"},st={class:"sidebar-header"},ot={class:"search-wrap"},it={class:"chat-list"},lt={key:0,class:"empty-state-small"},rt={key:0,class:"chat-section-label"},ct={key:1,class:"chat-section-label"},ut=I({__name:"Sidebar",emits:["openDrawer","openNewChat","selectChat"],setup(t,{emit:o}){const i=o,r=J(),n=k(""),f=L(()=>{const s=n.value.toLowerCase();return s?r.sortedChats.filter(p=>{const b=_(p).toLowerCase(),C=(p.other_username||"").toLowerCase();return b.includes(s)||C.includes(s)}):r.sortedChats}),u=L(()=>f.value.filter(s=>s.is_favorite)),m=L(()=>f.value.filter(s=>!s.is_favorite));function _(s){return s.type==="channel"||s.type==="group"?s.title||s.name||"Untitled":s.other_display_name||s.other_username||s.title||s.name||"Chat"}const c=k(null);le("contextChatId",c);function d(s,p){s.preventDefault(),c.value=p,window.dispatchEvent(new CustomEvent("show-context-menu",{detail:{x:s.clientX,y:s.clientY,chatId:p}}))}return(s,p)=>(y(),w("aside",at,[e("header",st,[e("button",{class:"icon-btn","aria-label":"Menu",onClick:p[0]||(p[0]=b=>i("openDrawer"))},"â˜°"),e("div",ot,[F(e("input",{"onUpdate:modelValue":p[1]||(p[1]=b=>n.value=b),class:"search-input",type:"search",placeholder:"Search chats..."},null,512),[[V,n.value]])]),e("button",{class:"icon-btn","aria-label":"New chat",title:"New chat",onClick:p[2]||(p[2]=b=>i("openNewChat"))},"âœŽ")]),e("div",it,[f.value.length===0?(y(),w("div",lt,[...p[3]||(p[3]=[ne(" No conversations yet.",-1),e("br",null,null,-1),ne("Click âœŽ to start one. ",-1)])])):(y(),w(H,{key:1},[u.value.length>0?(y(),w("div",rt,"Starred")):x("",!0),(y(!0),w(H,null,K(u.value,b=>(y(),A(fe,{key:b.id,chat:b,active:b.id===P(r).activeChatId,onSelect:C=>i("selectChat",b.id),onToggleFavorite:C=>P(r).toggleFavorite(b.id),onContextmenu:C=>d(C,b.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128)),u.value.length>0&&m.value.length>0?(y(),w("div",ct," All chats ")):x("",!0),(y(!0),w(H,null,K(m.value,b=>(y(),A(fe,{key:b.id,chat:b,active:b.id===P(r).activeChatId,onSelect:C=>i("selectChat",b.id),onToggleFavorite:C=>P(r).toggleFavorite(b.id),onContextmenu:C=>d(C,b.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128))],64))])]))}});function dt(){const t=k(!1),o=k(0);let i=null,r=[],n=null;async function f(){if(!navigator.mediaDevices?.getUserMedia)throw new Error("MediaDevices not supported");const d=await navigator.mediaDevices.getUserMedia({audio:!0});r=[],o.value=0,i=new MediaRecorder(d),i.ondataavailable=s=>{s.data.size&&r.push(s.data)},i.start(),t.value=!0,n=setInterval(()=>{o.value++},1e3)}function u(){return new Promise((d,s)=>{if(!i||i.state!=="recording"){s(new Error("Not recording"));return}i.onstop=()=>{i?.stream&&i.stream.getTracks().forEach(U=>U.stop()),_(),t.value=!1;const p=i?.mimeType||"audio/webm",b=p.includes("ogg")?"ogg":"webm",C=new Blob(r,{type:p}),$=new File([C],`voice.${b}`,{type:p});d($)},i.stop()})}function m(){i&&i.state==="recording"&&(i.onstop=()=>{i?.stream&&i.stream.getTracks().forEach(d=>d.stop())},i.stop()),_(),t.value=!1,o.value=0}function _(){n&&(clearInterval(n),n=null)}function c(d){const s=Math.floor(d/60),p=d%60;return`${s}:${String(p).padStart(2,"0")}`}return{isRecording:t,seconds:o,startRecording:f,stopRecording:u,cancelRecording:m,formatTime:c}}async function ye(t){const o=new FormData;o.append("file",t);const{data:i}=await O.post("/files",o);return i}const vt={class:"chat-header"},mt={class:"chat-header-name"},ft=I({__name:"ChatHeader",emits:["back","openUserProfile"],setup(t,{emit:o}){const i=o,r=J(),n=L(()=>r.activeChat),f=L(()=>{const s=n.value;return s?s.type==="channel"||s.type==="group"?s.title||s.name||"Untitled":s.other_display_name||s.other_username||s.title||s.name||"Chat":"---"}),u=L(()=>n.value?r.getTypingUsernames(n.value.id):[]),m=L(()=>u.value.length>0),_=L(()=>{const s=n.value;return!s||s.type!=="direct"||!s.other_user_id?!1:r.isUserOnline(s.other_user_id)}),c=L(()=>{if(u.value.length===1)return`${u.value[0]} is typing...`;if(u.value.length>1)return`${u.value.length} people typing...`;const s=n.value;return s?s.type==="channel"?"Channel":s.type==="group"?"Group":_.value?"online":s.other_username?"@"+s.other_username:"":""});function d(){n.value?.type==="direct"&&n.value.other_username&&i("openUserProfile",n.value.other_username)}return(s,p)=>(y(),w("header",vt,[e("button",{class:"icon-btn back-btn","aria-label":"Back",onClick:p[0]||(p[0]=b=>i("back"))},"â†"),E(q,{class:"chat-header-avatar",name:f.value,url:n.value?.other_avatar_url,online:_.value,onClick:d},null,8,["name","url","online"]),e("div",{class:"chat-header-info",onClick:d},[e("div",mt,M(f.value),1),e("div",{class:W(["chat-header-sub",{"typing-text":m.value,"online-text":_.value&&!m.value}])},M(c.value),3)])]))}}),be=(t,o)=>{const i=t.__vccOpts||t;for(const[r,n]of o)i[r]=n;return i},pt={},ht={class:"admin-badge",title:"Admin"};function gt(t,o){return y(),w("span",ht,"âœ“")}const _e=be(pt,[["render",gt]]),yt={key:0,class:"msg-sender-name"},bt={key:1,class:"msg-bubble sticker-bubble"},_t=["src","alt"],kt={key:2,class:"msg-bubble"},wt={class:"voice-player"},Ct=["src"],$t={key:0,class:"voice-dur"},St=["innerHTML"],xt={class:"msg-time"},Mt=I({__name:"MessageBubble",props:{message:{},isMine:{type:Boolean}},emits:["mentionClick"],setup(t,{emit:o}){const i=t,r=o,n=oe("stickers",k([])),f=L(()=>{if(i.message.sticker_url)return i.message.sticker_url;if(i.message.sticker_id){const s=n.value.find(p=>p.id===i.message.sticker_id);if(s)return s.url}return""}),u=L(()=>i.message.attachment_url||""),m=L(()=>_(i.message.content||"").replace(/@(\w{1,30})/g,`<span class="mention" data-u="$1" onclick="window.dispatchEvent(new CustomEvent('mention-click', {detail:'$1'}))">@$1</span>`));function _(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function c(s){if(!s)return"";const p=new Date(s.endsWith("Z")?s:s+"Z"),b=new Date;return p.toDateString()===b.toDateString()?p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p.toLocaleDateString([],{month:"short",day:"numeric"})}function d(s){const p=Math.floor(s/60),b=s%60;return`${p}:${String(b).padStart(2,"0")}`}return typeof window<"u"&&window.addEventListener("mention-click",(s=>{r("mentionClick",s.detail)})),(s,p)=>(y(),w("div",{class:W(["msg-row",t.isMine?"mine":"theirs"])},[!t.isMine&&t.message.message_type!=="sticker"?(y(),w("div",yt,[ne(M(t.message.sender_display_name||t.message.sender_username)+" ",1),t.message.sender_is_admin?(y(),A(_e,{key:0})):x("",!0)])):x("",!0),t.message.message_type==="sticker"?(y(),w("div",bt,[e("img",{class:"sticker-img",src:f.value,alt:t.message.sticker_label||"sticker"},null,8,_t)])):t.message.message_type==="voice"?(y(),w("div",kt,[e("div",wt,[e("audio",{controls:"",src:u.value},null,8,Ct),t.message.duration_seconds?(y(),w("span",$t,M(d(t.message.duration_seconds)),1)):x("",!0)])])):(y(),w("div",{key:3,class:"msg-bubble",innerHTML:m.value},null,8,St)),e("div",xt,M(c(t.message.created_at)),1)],2))}}),Tt={class:"composer"},Ut=["onKeydown"],Dt=I({__name:"Composer",props:{stickerPickerOpen:{type:Boolean}},emits:["send","toggleStickers","startRecording","typing"],setup(t,{expose:o,emit:i}){const r=i,n=k(""),f=k(null);let u=0;function m(){const d=n.value.trim();d&&(r("send",d),n.value="",c())}function _(){c();const d=Date.now();d-u>2e3&&n.value.trim().length>0&&(u=d,r("typing"))}function c(){const d=f.value;d&&(d.style.height="auto",d.style.height=Math.min(d.scrollHeight,120)+"px")}return G(()=>{f.value?.focus()}),o({focus:()=>f.value?.focus()}),(d,s)=>(y(),w("div",Tt,[e("button",{class:"icon-btn composer-btn","aria-label":"Stickers",title:"Stickers",onClick:s[0]||(s[0]=p=>r("toggleStickers"))},"ðŸŒ"),F(e("textarea",{ref_key:"inputRef",ref:f,"onUpdate:modelValue":s[1]||(s[1]=p=>n.value=p),class:"composer-input",placeholder:"Message...",rows:"1",maxlength:"4000",onKeydown:ke(j(m,["exact","prevent"]),["enter"]),onInput:_},null,40,Ut),[[V,n.value]]),e("button",{class:"icon-btn composer-btn record-btn","aria-label":"Voice message",title:"Record voice",onClick:s[2]||(s[2]=p=>r("startRecording"))},"ðŸŽ¤"),e("button",{class:"icon-btn composer-btn send-btn","aria-label":"Send",title:"Send",onClick:m},"âž¤")]))}}),Nt={class:"sticker-grid"},Lt=["title","onClick"],Pt=["src","alt"],Ot={key:0,class:"empty-state-small",style:{color:"var(--text-muted)"}},Ft=I({__name:"StickerPicker",emits:["select"],setup(t,{emit:o}){const i=o,r=oe("stickers",k([])),n=L(()=>r.value);return(f,u)=>(y(),w("div",Nt,[(y(!0),w(H,null,K(n.value,m=>(y(),w("button",{key:m.id,class:"sticker-btn",title:m.label,onClick:_=>i("select",m.id)},[e("img",{src:m.url,alt:m.label},null,8,Pt)],8,Lt))),128)),n.value.length===0?(y(),w("div",Ot," No stickers available ")):x("",!0)]))}}),It={},Rt={class:"msgs-loading"};function Bt(t,o){return y(),w("div",Rt,"Loading...")}const Et=be(It,[["render",Bt]]),Vt={class:"invite-manage",style:{padding:"0 1rem .5rem"}},At={class:"invite-link-wrap"},Wt=["value"],zt=I({__name:"InviteSection",props:{chatId:{}},setup(t){const o=t,{showToast:i}=Q(),r=k("Loading..."),n=k("");async function f(){try{const _=await xe(o.chatId);if(_.length>0){const c=_[0];n.value=c.token,r.value=`${window.location.origin}/join/${c.token}`}else{const c=await Me(o.chatId);n.value=c.token,r.value=`${window.location.origin}/join/${c.token}`}}catch{r.value="Failed to generate invite"}}function u(){r.value&&navigator.clipboard&&navigator.clipboard.writeText(r.value).then(()=>i("Link copied!"))}async function m(){if(n.value)try{await Te(n.value),i("Invite revoked"),await f()}catch{i("Failed to revoke invite")}}return G(f),(_,c)=>(y(),w("div",Vt,[c[0]||(c[0]=e("div",{class:"invite-manage-title"},"Invite Link",-1)),e("div",At,[e("input",{class:"form-input invite-link-input",value:r.value,type:"text",readonly:""},null,8,Wt),e("button",{class:"btn btn-sm btn-outline",title:"Copy link",onClick:u}," ðŸ“‹ ")]),e("button",{class:"btn btn-sm btn-ghost btn-danger",onClick:m}," Revoke link ")]))}}),Ht={class:"chat-panel"},Gt={key:0,class:"empty-chat"},Jt={key:1,class:"chat-view"},jt={key:0,class:"channel-readonly-bar"},qt={key:0,class:"date-sep"},Zt={key:1,class:"sticker-picker"},Kt={key:3,class:"recording-bar"},Yt={class:"rec-time"},Qt=I({__name:"ChatPanel",emits:["back","openUserProfile"],setup(t,{emit:o}){const i=o,r=Y(),n=J(),f=he(),{showToast:u}=Q(),m=dt(),_=oe("stickers",k([])),c=oe("sendTyping",()=>{}),d=k(null),s=k(!1),p=k(!1),b=k("member"),C=k(!1);let $=null;const U=L(()=>n.activeChat?.type==="channel"&&b.value==="member"),T=L(()=>n.activeChatId?f.getMessages(n.activeChatId):[]),D=L(()=>{const v=[];let l="";for(const g of T.value){const B=a(g.created_at);B!==l&&(v.push({type:"date",label:B}),l=B),v.push({type:"msg",msg:g})}return v});function a(v){if(!v)return"";const l=new Date(v.endsWith("Z")?v:v+"Z"),g=new Date;if(l.toDateString()===g.toDateString())return"Today";const B=new Date(g);return B.setDate(g.getDate()-1),l.toDateString()===B.toDateString()?"Yesterday":l.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})}ue(()=>n.activeChatId,async v=>{if(s.value=!1,b.value="member",C.value=!1,$&&(clearInterval($),$=null),!v)return;await f.loadMessages(v),await te(),h();const l=n.activeChat;if(l&&(l.type==="channel"||l.type==="group"))try{const g=await De(v);b.value=g.my_role||"member",C.value=b.value==="owner"||b.value==="admin"}catch{}$=setInterval(()=>{n.activeChatId===v&&f.loadNewer(v).then(g=>{g.length>0&&S()})},2500)});function h(){d.value&&(d.value.scrollTop=d.value.scrollHeight)}function S(){if(!d.value)return;const v=d.value;v.scrollHeight-v.scrollTop-v.clientHeight<80&&te(()=>{v.scrollTop=v.scrollHeight})}function R(){n.activeChatId&&c(n.activeChatId)}async function z(v){if(!(!n.activeChatId||!v.trim()))try{const l=await f.sendMessage(n.activeChatId,v.trim(),"text");r.user&&(l.sender_id=r.user.id,l.sender_username=r.user.username,l.sender_display_name=r.user.display_name),await te(),h(),n.loadChats()}catch{u("Failed to send message")}}async function X(v){if(n.activeChatId){s.value=!1;try{const l=await f.sendMessage(n.activeChatId,"","sticker",{sticker_id:v}),g=_.value.find(B=>B.id===v);g&&(l.sticker_url=g.url,l.sticker_label=g.label),await te(),h(),n.loadChats()}catch{u("Failed to send sticker")}}}async function ee(){try{await m.startRecording(),p.value=!0;const v=await m.stopRecording();p.value=!1,await N(v)}catch{p.value=!1,u("Microphone access denied")}}function Z(){m.cancelRecording(),p.value=!1}async function N(v){if(n.activeChatId)try{const l=await ye(v);await f.sendMessage(n.activeChatId,"","voice",{file_id:l.id,duration_seconds:m.seconds.value}),await f.loadMessages(n.activeChatId),await te(),h(),n.loadChats()}catch{u("Failed to upload voice message")}}return(v,l)=>(y(),w("main",Ht,[P(n).activeChatId?(y(),w("div",Jt,[E(ft,{onBack:l[0]||(l[0]=g=>i("back")),onOpenUserProfile:l[1]||(l[1]=g=>i("openUserProfile",g))}),U.value?(y(),w("div",jt,[...l[5]||(l[5]=[e("span",{class:"readonly-icon"},"ðŸ”’",-1),e("span",{class:"readonly-text"},"Only admins can send messages in this channel.",-1)])])):x("",!0),e("div",{ref_key:"msgListRef",ref:d,class:"msg-list"},[P(f).loadingChat===P(n).activeChatId?(y(),A(Et,{key:0})):(y(!0),w(H,{key:1},K(D.value,g=>(y(),w(H,{key:g.type==="date"?"date-"+g.label:"msg-"+g.msg.id},[g.type==="date"?(y(),w("div",qt,[e("span",null,M(g.label),1)])):(y(),A(Mt,{key:1,message:g.msg,"is-mine":g.msg.sender_id===P(r).user?.id,onMentionClick:l[2]||(l[2]=B=>i("openUserProfile",B))},null,8,["message","is-mine"]))],64))),128))],512),s.value?(y(),w("div",Zt,[E(Ft,{onSelect:X})])):x("",!0),U.value?x("",!0):F((y(),A(Dt,{key:2,"sticker-picker-open":s.value,onSend:z,onToggleStickers:l[3]||(l[3]=g=>s.value=!s.value),onStartRecording:ee,onTyping:R},null,8,["sticker-picker-open"])),[[re,!p.value]]),p.value?(y(),w("div",Kt,[l[6]||(l[6]=e("span",{class:"rec-dot"},null,-1)),e("span",Yt,M(P(m).formatTime(P(m).seconds.value)),1),l[7]||(l[7]=e("span",{class:"rec-label"},"Recording... tap mic to stop",-1)),e("button",{class:"icon-btn rec-cancel",title:"Cancel",onClick:Z},"âœ•")])):x("",!0),C.value?(y(),A(zt,{key:4,"chat-id":P(n).activeChatId},null,8,["chat-id"])):x("",!0)])):(y(),w("div",Gt,[...l[4]||(l[4]=[e("div",{class:"empty-chat-icon"},"ðŸ’¬",-1),e("div",{class:"empty-chat-text"},"Select a chat to start messaging",-1)])]))]))}}),Xt={class:"drawer-header"},en={class:"drawer-avatar-wrap"},tn={class:"drawer-user-info"},nn={class:"drawer-display-name"},an={class:"drawer-username"},sn={class:"drawer-nav"},on=I({__name:"Drawer",props:{open:{type:Boolean}},emits:["close","openProfile","openDownload"],setup(t,{emit:o}){const i=o,r=pe(),n=Y();function f(){n.logout(),r.push("/login")}return(u,m)=>(y(),w("div",{class:W(["drawer",{open:t.open}])},[e("div",Xt,[e("button",{class:"icon-btn","aria-label":"Close menu",onClick:m[0]||(m[0]=_=>i("close"))},"âœ•"),m[3]||(m[3]=e("span",{class:"drawer-title"},"Menu",-1))]),e("div",en,[E(q,{name:P(n).user?.display_name||P(n).user?.username||"?",url:P(n).user?.avatar_url,size:"lg"},null,8,["name","url"]),e("div",tn,[e("div",nn,M(P(n).user?.display_name||P(n).user?.username||"---"),1),e("div",an,"@"+M(P(n).user?.username||"---"),1)])]),e("nav",sn,[e("button",{class:"drawer-nav-item",onClick:m[1]||(m[1]=_=>i("openProfile"))}," Profile & Settings "),e("button",{class:"drawer-nav-item",onClick:m[2]||(m[2]=_=>i("openDownload"))}," Download App "),e("button",{class:"drawer-nav-item",onClick:f}," Log out ")]),m[4]||(m[4]=e("div",{class:"drawer-footer"},"Simple Messenger v2",-1))],2))}}),ln={class:"modal"},rn={class:"modal-header"},cn={class:"modal-body"},un={key:0,class:"chat-type-cards"},dn={key:1,class:"new-chat-form"},vn={class:"user-pick-list"},mn={key:0,class:"empty-state-small"},fn={key:1,class:"empty-state-small"},pn=["onClick"],hn={class:"user-pick-name"},gn={class:"user-pick-handle"},yn={key:2,class:"new-chat-form"},bn={class:"form-group"},_n={class:"form-group"},kn={class:"form-group"},wn={class:"user-pick-list"},Cn=["onClick"],$n={class:"user-pick-name"},Sn={class:"user-pick-handle"},xn={class:"modal-actions"},Mn=["disabled"],Tn={key:3,class:"new-chat-form"},Un={class:"form-group"},Dn={class:"form-group"},Nn={class:"form-group"},Ln={class:"modal-actions"},Pn=["disabled"],On=I({__name:"NewChatModal",emits:["close","chatCreated"],setup(t,{emit:o}){const i=o,r=Y(),{showToast:n}=Q(),f=k("select"),u=k(!1),m=k(""),_=k([]),c=k(!1);let d=null;const s=k(""),p=k(""),b=k(""),C=k([]),$=k(new Set);let U=null;const T=k(""),D=k(""),a=k("");G(()=>{h("")});async function h(v){c.value=!0;try{const l=await me(v);_.value=l.filter(g=>g.id!==r.user?.id)}catch{_.value=[]}finally{c.value=!1}}function S(){d&&clearTimeout(d),d=setTimeout(()=>h(m.value),300)}async function R(v){try{C.value=await me(v)}catch{C.value=[]}}function z(){U&&clearTimeout(U),U=setTimeout(()=>R(b.value),300)}function X(v){$.value.has(v)?$.value.delete(v):$.value.add(v)}async function ee(v){u.value=!0;try{const l=await ae({type:"direct",member_ids:[v]});i("chatCreated",l.id)}catch{n("Failed to start conversation")}finally{u.value=!1}}async function Z(){if(!s.value.trim()){n("Group name is required");return}u.value=!0;try{const v=await ae({type:"group",title:s.value.trim(),description:p.value.trim(),member_ids:Array.from($.value)});n("Group created!"),i("chatCreated",v.id)}catch{n("Failed to create group")}finally{u.value=!1}}async function N(){if(!T.value.trim()){n("Channel name is required");return}u.value=!0;try{const v=await ae({type:"channel",title:T.value.trim(),description:a.value.trim(),public_name:D.value.trim()||void 0,member_ids:[]});n("Channel created!"),i("chatCreated",v.id)}catch{n("Failed to create channel")}finally{u.value=!1}}return(v,l)=>(y(),w("div",{class:"modal-backdrop",onClick:l[14]||(l[14]=j(g=>i("close"),["self"]))},[e("div",ln,[e("div",rn,[l[15]||(l[15]=e("h2",{class:"modal-title"},"New Conversation",-1)),e("button",{class:"icon-btn",onClick:l[0]||(l[0]=g=>i("close"))},"âœ•")]),e("div",cn,[f.value==="select"?(y(),w("div",un,[e("button",{class:"chat-type-card",onClick:l[1]||(l[1]=g=>f.value="direct")},[...l[16]||(l[16]=[e("span",{class:"chat-type-icon"},"ðŸ‘¤",-1),e("div",null,[e("div",{class:"chat-type-label"},"Direct Chat"),e("div",{class:"chat-type-desc"},"Private 1-on-1 conversation")],-1)])]),e("button",{class:"chat-type-card",onClick:l[2]||(l[2]=g=>f.value="group")},[...l[17]||(l[17]=[e("span",{class:"chat-type-icon"},"ðŸ‘¥",-1),e("div",null,[e("div",{class:"chat-type-label"},"Group Chat"),e("div",{class:"chat-type-desc"},"Chat with multiple people")],-1)])]),e("button",{class:"chat-type-card",onClick:l[3]||(l[3]=g=>f.value="channel")},[...l[18]||(l[18]=[e("span",{class:"chat-type-icon"},"ðŸ“¢",-1),e("div",null,[e("div",{class:"chat-type-label"},"Channel"),e("div",{class:"chat-type-desc"},"Broadcast to subscribers")],-1)])])])):x("",!0),f.value==="direct"?(y(),w("div",dn,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:l[4]||(l[4]=g=>f.value="select")}," â† Back "),F(e("input",{"onUpdate:modelValue":l[5]||(l[5]=g=>m.value=g),class:"search-input",type:"search",placeholder:"Search users...",onInput:S},null,544),[[V,m.value]]),e("div",vn,[c.value?(y(),w("div",mn,"Loading users...")):_.value.length===0?(y(),w("div",fn,"No users found.")):(y(!0),w(H,{key:2},K(_.value,g=>(y(),w("div",{key:g.id,class:"user-pick-item",onClick:B=>ee(g.id)},[E(q,{name:g.display_name||g.username,url:g.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",hn,M(g.display_name||g.username),1),e("div",gn,"@"+M(g.username),1)])],8,pn))),128))])])):x("",!0),f.value==="group"?(y(),w("div",yn,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:l[6]||(l[6]=g=>f.value="select")}," â† Back "),e("div",bn,[l[19]||(l[19]=e("label",{class:"form-label"},"Group name",-1)),F(e("input",{"onUpdate:modelValue":l[7]||(l[7]=g=>s.value=g),class:"form-input",type:"text",maxlength:"64",placeholder:"My Group"},null,512),[[V,s.value]])]),e("div",_n,[l[20]||(l[20]=e("label",{class:"form-label"},"Description (optional)",-1)),F(e("textarea",{"onUpdate:modelValue":l[8]||(l[8]=g=>p.value=g),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this group about?"},null,512),[[V,p.value]])]),e("div",kn,[l[21]||(l[21]=e("label",{class:"form-label"},"Add members",-1)),F(e("input",{"onUpdate:modelValue":l[9]||(l[9]=g=>b.value=g),class:"search-input",type:"search",placeholder:"Search users...",onInput:z},null,544),[[V,b.value]]),e("div",wn,[(y(!0),w(H,null,K(C.value,g=>(y(),w("div",{key:g.id,class:W(["user-pick-item",{selected:$.value.has(g.id)}]),onClick:B=>X(g.id)},[E(q,{name:g.display_name||g.username,url:g.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",$n,M($.value.has(g.id)?"âœ“ ":"")+M(g.display_name||g.username),1),e("div",Sn,"@"+M(g.username),1)])],10,Cn))),128))])]),e("div",xn,[e("button",{class:"btn btn-primary",disabled:u.value,onClick:Z}," Create Group ",8,Mn)])])):x("",!0),f.value==="channel"?(y(),w("div",Tn,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:l[10]||(l[10]=g=>f.value="select")}," â† Back "),e("div",Un,[l[22]||(l[22]=e("label",{class:"form-label"},"Channel name",-1)),F(e("input",{"onUpdate:modelValue":l[11]||(l[11]=g=>T.value=g),class:"form-input",type:"text",maxlength:"64",placeholder:"My Channel"},null,512),[[V,T.value]])]),e("div",Dn,[l[23]||(l[23]=e("label",{class:"form-label"},"Public link name (optional)",-1)),F(e("input",{"onUpdate:modelValue":l[12]||(l[12]=g=>D.value=g),class:"form-input",type:"text",maxlength:"64",placeholder:"my-channel"},null,512),[[V,D.value]]),l[24]||(l[24]=e("small",{class:"form-hint"},"Letters, numbers, hyphens, underscores. Used for /c/your-name links.",-1))]),e("div",Nn,[l[25]||(l[25]=e("label",{class:"form-label"},"Description (optional)",-1)),F(e("textarea",{"onUpdate:modelValue":l[13]||(l[13]=g=>a.value=g),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this channel about?"},null,512),[[V,a.value]])]),e("div",Ln,[e("button",{class:"btn btn-primary",disabled:u.value,onClick:N}," Create Channel ",8,Pn)])])):x("",!0)])])]))}}),Fn={class:"modal modal-wide"},In={class:"modal-header"},Rn={class:"profile-tabs"},Bn={class:"modal-body profile-body"},En={class:"profile-avatar-section"},Vn={class:"user-id-display"},An={class:"form-group"},Wn={class:"form-group"},zn={key:0,class:"form-hint form-error"},Hn={class:"form-group"},Gn={class:"modal-actions"},Jn={class:"form-group form-inline"},jn={class:"form-group form-inline"},qn={class:"toggle"},Zn={class:"form-group form-inline"},Kn=I({__name:"ProfileModal",emits:["close"],setup(t,{emit:o}){const i=o,r=Y(),n=de(),{showToast:f}=Q(),u=k("profile"),m=k(""),_=k(""),c=k(""),d=k(""),s=k(null),p=k("light"),b=k(!0),C=k("en");ue(b,async D=>{D&&"Notification"in window&&await Notification.requestPermission()==="denied"&&(b.value=!1,f("Notifications blocked by browser"))}),G(async()=>{r.user&&(m.value=r.user.display_name||"",_.value=r.user.username,c.value=r.user.bio||""),p.value=n.theme,b.value=n.notificationsEnabled,C.value=n.language});async function $(){const D=s.value?.files?.[0];if(D){try{const a=await ye(D),h=await Ge(a.id);r.updateUser({avatar_url:h.avatar_url}),f("Avatar updated!")}catch{f("Upload failed")}s.value&&(s.value.value="")}}async function U(){if(d.value="",!r.user)return;const D={display_name:m.value.trim(),bio:c.value.trim()};_.value.trim()&&_.value.trim()!==r.user.username&&(D.username=_.value.trim());try{const a=await He(r.user.id,D);r.updateUser({display_name:a.display_name,username:a.username}),f("Profile saved!"),i("close")}catch(a){a.response?.status===409?d.value="Username already taken":f("Save failed")}}async function T(){try{await n.saveSettings({theme:p.value,notifications_enabled:b.value,language:C.value}),f("Settings saved!"),i("close")}catch{f("Settings save failed")}}return(D,a)=>(y(),w("div",{class:"modal-backdrop",onClick:a[11]||(a[11]=j(h=>i("close"),["self"]))},[e("div",Fn,[e("div",In,[a[12]||(a[12]=e("h2",{class:"modal-title"},"Profile & Settings",-1)),e("button",{class:"icon-btn",onClick:a[0]||(a[0]=h=>i("close"))},"âœ•")]),e("div",Rn,[e("button",{class:W(["profile-tab",{active:u.value==="profile"}]),onClick:a[1]||(a[1]=h=>u.value="profile")},"Profile",2),e("button",{class:W(["profile-tab",{active:u.value==="settings"}]),onClick:a[2]||(a[2]=h=>u.value="settings")},"Settings",2)]),e("div",Bn,[F(e("div",null,[e("div",En,[E(q,{name:m.value||P(r).user?.username||"?",url:P(r).user?.avatar_url,size:"xl"},null,8,["name","url"]),e("button",{class:"btn btn-outline btn-sm",onClick:a[3]||(a[3]=h=>s.value?.click())}," Change photo "),e("input",{ref_key:"fileInput",ref:s,type:"file",accept:"image/*",class:"hidden",onChange:$},null,544),e("p",Vn,"ID: "+M(P(r).user?.id),1)]),e("div",An,[a[13]||(a[13]=e("label",{class:"form-label"},"Display name",-1)),F(e("input",{"onUpdate:modelValue":a[4]||(a[4]=h=>m.value=h),class:"form-input",type:"text",maxlength:"64",placeholder:"Your name"},null,512),[[V,m.value]])]),e("div",Wn,[a[14]||(a[14]=e("label",{class:"form-label"},"Username",-1)),F(e("input",{"onUpdate:modelValue":a[5]||(a[5]=h=>_.value=h),class:"form-input",type:"text",maxlength:"20",placeholder:"username"},null,512),[[V,_.value]]),d.value?(y(),w("small",zn,M(d.value),1)):x("",!0)]),e("div",Hn,[a[15]||(a[15]=e("label",{class:"form-label"},"Bio",-1)),F(e("textarea",{"onUpdate:modelValue":a[6]||(a[6]=h=>c.value=h),class:"form-input",maxlength:"200",rows:"3",placeholder:"About you..."},null,512),[[V,c.value]])]),e("div",Gn,[e("button",{class:"btn btn-primary",onClick:U},"Save Profile"),e("button",{class:"btn btn-ghost",onClick:a[7]||(a[7]=h=>i("close"))},"Cancel")])],512),[[re,u.value==="profile"]]),F(e("div",null,[e("div",Jn,[a[17]||(a[17]=e("label",{class:"form-label"},"Theme",-1)),F(e("select",{"onUpdate:modelValue":a[8]||(a[8]=h=>p.value=h),class:"form-input form-select"},[...a[16]||(a[16]=[e("option",{value:"light"},"Light",-1),e("option",{value:"dark"},"Dark",-1)])],512),[[ve,p.value]])]),e("div",jn,[a[19]||(a[19]=e("label",{class:"form-label"},"Notifications",-1)),e("label",qn,[F(e("input",{"onUpdate:modelValue":a[9]||(a[9]=h=>b.value=h),type:"checkbox"},null,512),[[we,b.value]]),a[18]||(a[18]=e("span",{class:"toggle-slider"},null,-1))])]),e("div",Zn,[a[21]||(a[21]=e("label",{class:"form-label"},"Language",-1)),F(e("select",{"onUpdate:modelValue":a[10]||(a[10]=h=>C.value=h),class:"form-input form-select"},[...a[20]||(a[20]=[e("option",{value:"en"},"English",-1),e("option",{value:"ru"},"Ð ÑƒÑÑÐºÐ¸Ð¹",-1),e("option",{value:"de"},"Deutsch",-1)])],512),[[ve,C.value]])]),e("div",{class:"modal-actions"},[e("button",{class:"btn btn-primary",onClick:T},"Save Settings")])],512),[[re,u.value==="settings"]])])])]))}}),Yn={class:"modal"},Qn={class:"modal-header"},Xn={class:"modal-body user-profile-body"},ea={key:0},ta={class:"profile-avatar-section"},na={class:"user-profile-name"},aa={class:"user-profile-username"},sa={class:"user-id-display"},oa={key:0,class:"user-profile-bio"},ia={class:"modal-actions",style:{"justify-content":"center"}},la={key:2},ra=I({__name:"UserProfileModal",props:{username:{}},emits:["close","message"],setup(t,{emit:o}){const i=t,r=o,n=k(null),f=k(!0);return G(async()=>{try{n.value=await ge(i.username)}catch{n.value=null}finally{f.value=!1}}),(u,m)=>(y(),w("div",{class:"modal-backdrop",onClick:m[2]||(m[2]=j(_=>r("close"),["self"]))},[e("div",Yn,[e("div",Qn,[m[3]||(m[3]=e("h2",{class:"modal-title"},"User Profile",-1)),e("button",{class:"icon-btn",onClick:m[0]||(m[0]=_=>r("close"))},"âœ•")]),e("div",Xn,[f.value?(y(),w("p",ea,"Loading...")):n.value?(y(),w(H,{key:1},[e("div",ta,[E(q,{name:n.value.display_name||n.value.username,url:n.value.avatar_url,size:"xl"},null,8,["name","url"])]),e("div",na,[ne(M(n.value.display_name||n.value.username)+" ",1),n.value.is_admin?(y(),A(_e,{key:0})):x("",!0)]),e("div",aa,"@"+M(n.value.username),1),e("div",sa,"ID: "+M(n.value.id),1),n.value.bio?(y(),w("div",oa,M(n.value.bio),1)):x("",!0),e("div",ia,[e("button",{class:"btn btn-primary",onClick:m[1]||(m[1]=_=>r("message",n.value.username))}," âœŽ Message ")])],64)):(y(),w("p",la,"User not found"))])])]))}}),ca={class:"modal",style:{"max-width":"420px"}},ua={class:"modal-header"},da={class:"modal-body",style:{display:"flex","flex-direction":"column",gap:"12px"}},va=I({__name:"DownloadModal",emits:["close"],setup(t,{emit:o}){const i=o,r=navigator.userAgent.toLowerCase(),n=r.includes("win"),f=r.includes("mac")&&!r.includes("iphone")&&!r.includes("ipad"),u=L(()=>n?"Windows":f?"macOS":null);function m(){n?window.location.href="/downloads/windows/MessengerSetup.exe":f&&(window.location.href="/downloads/macos/Messenger.dmg")}return(_,c)=>(y(),w("div",{class:"modal-backdrop",onClick:c[1]||(c[1]=j(d=>i("close"),["self"]))},[e("div",ca,[e("div",ua,[c[2]||(c[2]=e("h2",{class:"modal-title"},"Download Simple Messenger",-1)),e("button",{class:"icon-btn","aria-label":"Close",onClick:c[0]||(c[0]=d=>i("close"))},"âœ•")]),e("div",da,[u.value?(y(),w("button",{key:0,class:"btn btn-primary btn-full",onClick:m}," Download for "+M(u.value),1)):x("",!0),c[3]||(c[3]=Ce('<details><summary style="cursor:pointer;color:var(--accent);">Other platforms</summary><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"><a href="/downloads/windows/MessengerSetup.exe" class="btn btn-ghost btn-full" download>Windows installer (.exe)</a><a href="/downloads/macos/Messenger.dmg" class="btn btn-ghost btn-full" download>macOS installer (.dmg)</a></div></details><p style="font-size:0.8rem;color:var(--text-muted);margin:0;"> Files not available yet? Check back soon. </p>',2))])])]))}}),ma=I({__name:"ContextMenu",setup(t){const o=J(),{showToast:i}=Q(),r=k(!1),n=k(0),f=k(0),u=k(null),m=L(()=>u.value?o.chats.find(b=>b.id===u.value)??null:null);function _(b){u.value=b.detail.chatId,n.value=b.detail.x,f.value=b.detail.y,r.value=!0}function c(){r.value&&(r.value=!1,u.value=null)}G(()=>{window.addEventListener("show-context-menu",_),document.addEventListener("click",c)}),se(()=>{window.removeEventListener("show-context-menu",_),document.removeEventListener("click",c)});async function d(){if(u.value){r.value=!1;try{await o.toggleFavorite(u.value)}catch{i("Failed to update favorite")}}}async function s(){if(u.value){r.value=!1;try{await o.toggleMute(u.value)}catch{i("Failed to update mute")}}}async function p(){if(u.value&&(r.value=!1,!!confirm("Leave this chat?")))try{await o.leave(u.value),i("Left chat")}catch{i("Failed to leave chat")}}return(b,C)=>r.value?(y(),w("div",{key:0,class:"context-menu",style:$e({left:n.value+"px",top:f.value+"px"})},[e("button",{class:"ctx-item",onClick:d},M(m.value?.is_favorite?"â˜… Unstar":"â˜† Star"),1),e("button",{class:"ctx-item",onClick:s},M(m.value?.is_muted?"Unmute":"Mute"),1),m.value&&m.value.type!=="direct"?(y(),w("button",{key:0,class:"ctx-item ctx-leave",onClick:p}," Leave chat ")):x("",!0)],4)):x("",!0)}}),ha=I({__name:"MessengerView",setup(t){const o=Se(),i=pe(),r=Y(),n=J(),f=de(),{showToast:u}=Q(),{connect:m,disconnect:_,sendTyping:c}=We();le("sendTyping",c);const d=k(!1),s=k(!1),p=k(!1),b=k(!1),C=k(null),$=k([]);le("stickers",$);let U=null;G(async()=>{await f.loadSettings();try{$.value=await Je()}catch{}await n.loadChats(),m(),U=setInterval(()=>n.loadChats(),5e3),T()}),se(()=>{_(),U&&(clearInterval(U),U=null)}),ue(()=>o.path,()=>{T()});async function T(){const N=o.path;if(N.startsWith("/@")){const v=o.params.username;v&&(C.value=v)}else if(N.startsWith("/u/")){const v=o.params.id;if(v)try{const l=await ze(parseInt(v));C.value=l.username}catch{u("User not found")}}else if(N.startsWith("/dm/")){const v=o.params.id;v&&await D(v)}else if(N.startsWith("/c/")){const v=o.params.name;v&&await a(v)}}async function D(N){try{let v;if(N.startsWith("@")){const g=N.substring(1);if(r.user?.username===g){C.value=g;return}v=(await ge(g)).id}else if(v=parseInt(N),r.user?.id===v){u("Cannot open DM with yourself");return}const l=await ae({type:"direct",member_ids:[v]});await n.loadChats(),n.setActiveChat(l.id)}catch{u("Failed to open conversation")}}async function a(N){try{const v=await Ne(N);n.chats.find(g=>g.id===v.id)?n.setActiveChat(v.id):u("You are not a member of this channel")}catch{u("Channel not found")}}function h(N){n.setActiveChat(N),i.replace("/app")}function S(){n.setActiveChat(null)}function R(){d.value=!1,p.value=!0}function z(N){C.value=N}async function X(N){C.value=null,await D("@"+N)}async function ee(N){s.value=!1,await n.loadChats(),n.setActiveChat(N)}function Z(N){if(N.key==="Escape"){if(C.value){C.value=null;return}if(s.value){s.value=!1;return}if(p.value){p.value=!1;return}if(b.value){b.value=!1;return}if(d.value){d.value=!1;return}if(n.activeChatId!==null){S();return}}}return G(()=>document.addEventListener("keydown",Z)),se(()=>document.removeEventListener("keydown",Z)),(N,v)=>(y(),w("div",{class:W(["layout",{"chat-open":!!P(n).activeChatId}])},[E(on,{open:d.value,onClose:v[0]||(v[0]=l=>d.value=!1),onOpenProfile:R,onOpenDownload:v[1]||(v[1]=l=>b.value=!0)},null,8,["open"]),e("div",{class:W(["drawer-overlay",{visible:d.value}]),onClick:v[2]||(v[2]=l=>d.value=!1)},null,2),E(ut,{onOpenDrawer:v[3]||(v[3]=l=>d.value=!0),onOpenNewChat:v[4]||(v[4]=l=>s.value=!0),onSelectChat:h}),E(Qt,{onBack:S,onOpenUserProfile:z}),s.value?(y(),A(On,{key:0,onClose:v[5]||(v[5]=l=>s.value=!1),onChatCreated:ee})):x("",!0),p.value?(y(),A(Kn,{key:1,onClose:v[6]||(v[6]=l=>p.value=!1)})):x("",!0),C.value?(y(),A(ra,{key:2,username:C.value,onClose:v[7]||(v[7]=l=>C.value=null),onMessage:X},null,8,["username"])):x("",!0),b.value?(y(),A(va,{key:3,onClose:v[8]||(v[8]=l=>b.value=!1)})):x("",!0),E(ma)],2))}});export{ha as default};
