import{k as R,l as xe,r as y,m as O,n as fe,u as pe,p as Ne,d as j,o as c,c as b,a as t,t as E,w as X,q as Se,s as Z,g as A,b as L,f as oe,x as I,e as W,v as K,F as Y,y as ee,z as V,A as _e,B as be,C as pt,D as ie,E as gt,G as re,T as Xe,h as Ee,H as Ye,I as Ze,J as Je,K as me,L as $e,M as de,N as Me,j as Qe,O as Ve,P as ht,Q as yt}from"./index-C-zBkb3f.js";import{_ as ce,l as bt,c as wt,r as kt}from"./invites-CbcC-uNw.js";async function _t(){const{data:e}=await R.get("/chats");return e}async function Ct(e){const{data:n}=await R.get(`/chats/${e}`);return n}async function $t(e){const{data:n}=await R.get(`/chats/by-name/${encodeURIComponent(e)}`);return n}async function Ce(e){const{data:n}=await R.post("/chats",e);return n}async function Mt(e){await R.post(`/chats/${e}/favorite`)}async function xt(e){await R.delete(`/chats/${e}/favorite`)}async function St(e,n){await R.post(`/chats/${e}/mute`,{})}async function Tt(e){await R.delete(`/chats/${e}/mute`)}async function Dt(e){await R.delete(`/chats/${e}/leave`)}async function It(e){await R.post(`/chats/${e}/read`)}async function Ut(e){await R.post(`/chats/${e}/pin`)}async function Pt(e){await R.delete(`/chats/${e}/pin`)}async function Ft(e){await R.post(`/chats/${e}/archive`)}async function Lt(e){await R.delete(`/chats/${e}/archive`)}const te=xe("chats",()=>{const e=y([]),n=y(null),a=y({}),l=y(new Set),i=O(()=>e.value.find(v=>v.id===n.value)??null),r=O(()=>[...e.value].sort((v,h)=>{if(v.is_pinned&&!h.is_pinned)return-1;if(!v.is_pinned&&h.is_pinned)return 1;if(v.is_favorite&&!h.is_favorite)return-1;if(!v.is_favorite&&h.is_favorite)return 1;const D=v.last_at||v.updated_at||"";return(h.last_at||h.updated_at||"").localeCompare(D)}));async function s(){try{e.value=await _t()}catch(v){console.error("Failed to load chats",v)}}function m(v){if(n.value=v,v!==null){const h=e.value.find(D=>D.id===v);h&&h.unread_count>0&&(h.unread_count=0,It(v).catch(()=>{}))}}async function M(v){const h=e.value.find(D=>D.id===v);if(h)try{h.is_favorite?await xt(v):await Mt(v),h.is_favorite=!h.is_favorite}catch(D){throw console.error("Failed to toggle favorite",D),D}}async function w(v){const h=e.value.find(D=>D.id===v);if(h)try{h.is_muted?await Tt(v):await St(v),h.is_muted=!h.is_muted}catch(D){throw console.error("Failed to toggle mute",D),D}}async function k(v){const h=e.value.find(D=>D.id===v);if(h)try{h.is_pinned?await Pt(v):await Ut(v),h.is_pinned=!h.is_pinned}catch(D){throw console.error("Failed to toggle pin",D),D}}async function f(v){const h=e.value.find(D=>D.id===v);if(h)try{h.is_archived?await Lt(v):await Ft(v),h.is_archived=!h.is_archived}catch(D){throw console.error("Failed to toggle archive",D),D}}async function u(v){await Dt(v),e.value=e.value.filter(h=>h.id!==v),n.value===v&&(n.value=null)}function $(v,h,D){const B=e.value.find(J=>J.id===v);B&&(B.last_message=h,B.last_at=D)}function _(v){const h=e.value.find(D=>D.id===v);h&&(h.unread_count=(h.unread_count||0)+1)}function o(v,h,D){a.value[v]||(a.value[v]={});const B=a.value[v][h];B&&clearTimeout(B.timer);const J=setTimeout(()=>{d(v,h)},3e3);a.value[v][h]={username:D,timer:J}}function d(v,h){if(a.value[v]){const D=a.value[v][h];D&&(clearTimeout(D.timer),delete a.value[v][h])}}function p(v){const h=a.value[v];return h?Object.values(h).map(D=>D.username):[]}function S(v){l.value=new Set([...l.value,v])}function x(v){const h=new Set(l.value);h.delete(v),l.value=h}function g(v){return l.value.has(v)}return{chats:e,activeChatId:n,activeChat:i,sortedChats:r,typingUsers:a,loadChats:s,setActiveChat:m,toggleFavorite:M,toggleMute:w,togglePin:k,toggleArchive:f,leave:u,updateChatLastMessage:$,incrementUnread:_,setTyping:o,clearTyping:d,getTypingUsernames:p,onlineUsers:l,setUserOnline:S,setUserOffline:x,isUserOnline:g}});async function Nt(){const{data:e}=await R.get("/settings");return e}async function Et(e){await R.put("/settings",e)}const Te=xe("settings",()=>{const e=y(localStorage.getItem("theme")||"light"),n=y(!0),a=y("en");function l(s){e.value=s,document.body.setAttribute("data-theme",s),localStorage.setItem("theme",s)}async function i(){try{const s=await Nt();l(s.theme||"light"),n.value=s.notifications_enabled,a.value=s.language||"en"}catch(s){console.error("Failed to load settings",s)}}async function r(s){await Et(s),s.theme&&l(s.theme),s.notifications_enabled!==void 0&&(n.value=s.notifications_enabled),s.language&&(a.value=s.language)}return document.body.setAttribute("data-theme",e.value),{theme:e,notificationsEnabled:n,language:a,applyTheme:l,loadSettings:i,saveSettings:r}}),De=xe("selection",()=>{const e=y(new Set),n=y(!1),a=y(null),l=O(()=>e.value.size);function i(w,k){n.value=!0,a.value=w,e.value=new Set(k!=null?[k]:[])}function r(){n.value=!1,a.value=null,e.value=new Set}function s(w){const k=new Set(e.value);k.has(w)?k.delete(w):k.add(w),e.value=k,k.size===0&&r()}function m(){e.value=new Set}function M(w){return e.value.has(w)}return{selectedMessageIds:e,selectionMode:n,currentChatId:a,selectedCount:l,enterSelectionMode:i,exitSelectionMode:r,toggleMessage:s,clearSelection:m,isSelected:M}});async function Pe(e,n){const{data:a}=await R.get(`/chats/${e}/messages`,{params:n});return a}async function At(e,n){const{data:a}=await R.post(`/chats/${e}/messages`,n);return a}async function Ot(e,n){await R.delete(`/chats/${e}/messages/${n}`)}async function Rt(e,n){const{data:a}=await R.post(`/chats/${e}/messages/forward`,n);return a}async function Bt(e,n,a){const{data:l}=await R.post(`/chats/${e}/messages/${n}/reactions`,{emoji:a});return l}async function zt(e,n){if(!n.length)return{};const{data:a}=await R.get(`/chats/${e}/reactions`,{params:{message_ids:n.join(",")}});return a}const Ae=xe("messages",()=>{const e=y({}),n=y({}),a=y(null);async function l(o){const d=e.value[o];if(!d||d.length===0)return;const p=d.map(S=>S.id);try{const S=await zt(o,p);for(const x of d)x.reactions=S[String(x.id)]||void 0}catch(S){console.error("Failed to load reactions",S)}}async function i(o){a.value=o;try{const d=await Pe(o,{limit:50});e.value[o]=d,d.length>0&&(n.value[o]=Math.max(...d.map(p=>p.id))),await l(o)}catch(d){throw console.error("Failed to load messages",d),d}finally{a.value=null}}async function r(o){const d=n.value[o]||0;if(d===0)return[];try{const p=await Pe(o,{after_id:d,limit:50});if(p.length>0){e.value[o]||(e.value[o]=[]);const S=new Set(e.value[o].map(g=>g.id)),x=p.filter(g=>!S.has(g.id));e.value[o].push(...x),n.value[o]=Math.max(...p.map(g=>g.id)),await l(o)}return p}catch(p){return console.error("Failed to load newer messages",p),[]}}async function s(o){const d=e.value[o];if(!d||d.length===0)return[];const p=d[0];if(!p)return[];try{const S=await Pe(o,{before:p.created_at,limit:50});if(S.length>0){const x=new Set(d.map(v=>v.id)),g=S.filter(v=>!x.has(v.id));e.value[o]=[...g,...d],await l(o)}return S}catch(S){return console.error("Failed to load older messages",S),[]}}async function m(o,d,p){try{const S=await Bt(o,d,p);M(o,d,S.action,p,!0)}catch(S){console.error("Failed to toggle reaction",S)}}function M(o,d,p,S,x){const g=e.value[o];if(!g)return;const v=g.find(D=>D.id===d);if(!v)return;v.reactions||(v.reactions=[]);const h=v.reactions.find(D=>D.emoji===S);p==="added"?h?(h.count++,x&&(h.me=!0)):v.reactions.push({emoji:S,count:1,me:x}):h&&(h.count--,x&&(h.me=!1),h.count<=0&&(v.reactions=v.reactions.filter(D=>D.emoji!==S))),v.reactions.length===0&&(v.reactions=void 0)}async function w(o,d,p="text",S){const x=await At(o,{content:d,type:p,...S});return e.value[o]||(e.value[o]=[]),e.value[o].push(x),n.value[o]=Math.max(n.value[o]||0,x.id),x}function k(o,d){e.value[o]||(e.value[o]=[]),e.value[o].find(S=>S.id===d.id)||(e.value[o].push(d),n.value[o]=Math.max(n.value[o]||0,d.id))}async function f(o,d){try{await Ot(o,d),u(o,d)}catch(p){throw console.error("Failed to delete message",p),p}}function u(o,d){const p=e.value[o];p&&(e.value[o]=p.filter(S=>S.id!==d))}async function $(o,d,p){try{const S=await Rt(o,{from_chat_id:d,message_ids:p});for(const x of S)k(o,x);return S}catch(S){throw console.error("Failed to forward messages",S),S}}function _(o){return e.value[o]||[]}return{messagesByChat:e,lastMsgId:n,loadingChat:a,loadMessages:i,loadNewer:r,loadOlder:s,sendMessage:w,pushMessage:k,getMessages:_,toggleReaction:m,applyReactionUpdate:M,deleteMessage:f,removeMessage:u,forwardMessages:$}});function Vt(e,n,a){if(!document.hidden||e.sender_id===a.user?.id||!Te().notificationsEnabled||!("Notification"in window)||Notification.permission!=="granted"||n.chats.find(M=>M.id===e.chat_id)?.is_muted)return;const r=e.sender_display_name||e.sender_username||"Someone",s=e.message_type==="text"?e.content?.length>100?e.content.substring(0,100)+"...":e.content:`sent a ${e.message_type==="sticker"?"sticker":e.message_type==="voice"?"voice message":"file"}`,m=new Notification(r,{body:s,tag:`chat-${e.chat_id}`,silent:!1});m.onclick=()=>{window.focus(),n.setActiveChat(e.chat_id),m.close()},setTimeout(()=>m.close(),5e3)}function jt(){const e=y(!1);let n=null,a=null,l=null,i=1e3,r=!1;function s(){const o=localStorage.getItem("access_token");return o?`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?token=${encodeURIComponent(o)}`:null}function m(){if(n&&(n.readyState===WebSocket.OPEN||n.readyState===WebSocket.CONNECTING))return;const o=s();o&&(r=!1,n=new WebSocket(o),n.onopen=()=>{e.value=!0,i=1e3;const d=localStorage.getItem("access_token");d&&n.send(JSON.stringify({type:"auth",token:d}));const p=te();for(const S of p.chats)n.send(JSON.stringify({type:"subscribe",chat_id:S.id}));w()},n.onmessage=d=>{try{const p=JSON.parse(d.data);M(p)}catch{}},n.onclose=()=>{e.value=!1,k(),r||f()},n.onerror=()=>{})}function M(o){const d=Ae(),p=te(),S=pe();switch(o.type){case"message":{const x=o;d.pushMessage(x.chat_id,x),p.updateChatLastMessage(x.chat_id,x.content||(x.message_type==="sticker"?"Sticker":"Attachment"),x.created_at),x.chat_id!==p.activeChatId&&x.sender_id!==S.user?.id&&p.incrementUnread(x.chat_id),p.clearTyping(x.chat_id,x.sender_id),Vt(x,p,S);break}case"typing":{const x=o.chat_id,g=o.user_id;if(g!==S.user?.id){const v=o.username||"Someone";p.setTyping(x,g,v)}break}case"pong":break;case"presence":{const x=o.user_id,g=o.status;g==="online"?p.setUserOnline(x):g==="offline"&&p.setUserOffline(x);break}case"message_deleted":{const x=o.chat_id,g=o.message_id;d.removeMessage(x,g);break}case"reaction":{const x=o.chat_id,g=o.message_id,v=o.user_id,h=o.emoji,D=o.action;d.applyReactionUpdate(x,g,D,h,v===S.user?.id);break}}}function w(){k(),l=setInterval(()=>{n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"ping"}))},25e3)}function k(){l&&(clearInterval(l),l=null)}function f(){a||(a=setTimeout(()=>{a=null,m(),i=Math.min(i*2,3e4)},i))}function u(o){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"subscribe",chat_id:o}))}function $(o){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"typing",chat_id:o}))}function _(){r=!0,k(),a&&(clearTimeout(a),a=null),n&&(n.close(),n=null),e.value=!1}return fe(()=>{_()}),{connected:e,connect:m,disconnect:_,subscribeToChat:u,sendTyping:$}}async function Ht(e){const{data:n}=await R.get(`/users/${e}`);return n}async function Ke(e){const{data:n}=await R.get(`/users/by-username/${encodeURIComponent(e)}`);return n}async function je(e){const{data:n}=await R.get("/users/search",{params:{q:e}});return n}async function Wt(e,n){const{data:a}=await R.put(`/users/${e}`,n);return a}async function qt(e){const{data:n}=await R.put("/users/me/avatar",{file_id:e});return n}async function Gt(){const{data:e}=await R.get("/stickers");return e}const Xt=e=>{for(const n in e)if(n.startsWith("aria-")||n==="role"||n==="title")return!0;return!1};const He=e=>e==="";const Yt=(...e)=>e.filter((n,a,l)=>!!n&&n.trim()!==""&&l.indexOf(n)===a).join(" ").trim();const We=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();const Zt=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(n,a,l)=>l?l.toUpperCase():a.toLowerCase());const Jt=e=>{const n=Zt(e);return n.charAt(0).toUpperCase()+n.slice(1)};var ye={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};const Qt=({name:e,iconNode:n,absoluteStrokeWidth:a,"absolute-stroke-width":l,strokeWidth:i,"stroke-width":r,size:s=ye.width,color:m=ye.stroke,...M},{slots:w})=>Ne("svg",{...ye,...M,width:s,height:s,stroke:m,"stroke-width":He(a)||He(l)||a===!0||l===!0?Number(i||r||ye["stroke-width"])*24/Number(s):i||r||ye["stroke-width"],class:Yt("lucide",M.class,...e?[`lucide-${We(Jt(e))}-icon`,`lucide-${We(e)}`]:["lucide-icon"]),...!w.default&&!Xt(M)&&{"aria-hidden":"true"}},[...n.map(k=>Ne(...k)),...w.default?[w.default()]:[]]);const G=(e,n)=>(a,{slots:l,attrs:i})=>Ne(Qt,{...i,...a,iconNode:n,name:e},l);const Fe=G("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);const Kt=G("bell-off",[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M17 17H4a1 1 0 0 1-.74-1.673C4.59 13.956 6 12.499 6 8a6 6 0 0 1 .258-1.742",key:"178tsu"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M8.668 3.01A6 6 0 0 1 18 8c0 2.687.77 4.653 1.707 6.05",key:"1hqiys"}]]);const en=G("bookmark",[["path",{d:"M17 3a2 2 0 0 1 2 2v15a1 1 0 0 1-1.496.868l-4.512-2.578a2 2 0 0 0-1.984 0l-4.512 2.578A1 1 0 0 1 5 20V5a2 2 0 0 1 2-2z",key:"oz39mx"}]]);const tn=G("camera",[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);const nn=G("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);const sn=G("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);const an=G("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]);const on=G("ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);const ln=G("log-out",[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]]);const et=G("megaphone",[["path",{d:"M11 6a13 13 0 0 0 8.4-2.8A1 1 0 0 1 21 4v12a1 1 0 0 1-1.6.8A13 13 0 0 0 11 14H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z",key:"q8bfy3"}],["path",{d:"M6 14a12 12 0 0 0 2.4 7.2 2 2 0 0 0 3.2-2.4A8 8 0 0 1 10 14",key:"1853fq"}],["path",{d:"M8 6v8",key:"15ugcq"}]]);const rn=G("menu",[["path",{d:"M4 5h16",key:"1tepv9"}],["path",{d:"M4 12h16",key:"1lakjw"}],["path",{d:"M4 19h16",key:"1djgab"}]]);const cn=G("message-circle",[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]]);const un=G("moon",[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]]);const dn=G("settings",[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);const vn=G("square-pen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);const mn=G("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);const tt=G("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);const nt=G("users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]]);const we=G("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),fn={class:"swipe-actions swipe-actions-left"},pn={class:"chat-item-info"},gn={class:"chat-item-top"},hn={class:"chat-item-name"},yn={key:0,class:"pin-icon",title:"Pinned"},bn={key:1,class:"ci-channel"},wn={key:2,class:"ci-group"},kn={key:3,class:"mute-icon",title:"Muted"},_n={class:"chat-item-time"},Cn={class:"chat-item-bottom"},$n={class:"chat-item-preview"},Mn=["title"],xn={class:"swipe-actions swipe-actions-right"},qe=70,Sn=j({__name:"ChatListItem",props:{chat:{},active:{type:Boolean}},emits:["select","toggleFavorite","togglePin","toggleMute","contextmenu"],setup(e,{emit:n}){const a=e,l=te(),i=O(()=>a.chat.type!=="direct"||!a.chat.other_user_id?null:l.isUserOnline(a.chat.other_user_id)||null),r=O(()=>(a.chat.unread_count??0)>0),s=n,m=O(()=>{const o=a.chat;return o.type==="channel"||o.type==="group"?o.title||o.name||"Untitled":o.other_display_name||o.other_username||o.title||o.name||"Chat"});function M(o){if(!o)return"";const d=new Date(o.endsWith("Z")?o:o+"Z"),p=new Date;return d.toDateString()===p.toDateString()?d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):d.toLocaleDateString([],{month:"short",day:"numeric"})}const w=y(0);let k=0,f=!1;function u(o){k=o.touches[0].clientX,f=!0}function $(o){if(!f)return;const d=o.touches[0].clientX-k;w.value=Math.max(-qe,Math.min(qe,d))}function _(){f=!1,w.value=0}return(o,d)=>(c(),b("div",{ref:"swipeRef",class:"chat-item-swipe-wrapper",onTouchstart:u,onTouchmove:$,onTouchend:_},[t("div",fn,[t("button",{class:"swipe-action swipe-pin",onClick:d[0]||(d[0]=p=>s("togglePin"))},E(e.chat.is_pinned?"Unpin":"Pin"),1)]),t("div",{class:Z(["chat-item",{active:e.active,"chat-item-unread":r.value}]),style:Se({transform:`translateX(${w.value}px)`}),onClick:d[2]||(d[2]=p=>s("select")),onContextmenu:d[3]||(d[3]=X(p=>s("contextmenu",p),["prevent"]))},[A(ce,{name:m.value,url:e.chat.other_avatar_url,size:"sm",online:i.value},null,8,["name","url","online"]),t("div",pn,[t("div",gn,[t("span",hn,[e.chat.is_pinned?(c(),b("span",yn,"ðŸ“Œ")):L("",!0),e.chat.type==="channel"?(c(),b("span",bn)):e.chat.type==="group"?(c(),b("span",wn)):L("",!0),oe(" "+E(m.value)+" ",1),e.chat.is_muted?(c(),b("span",kn,"ðŸ””")):L("",!0)]),t("span",_n,E(M(e.chat.last_at||e.chat.updated_at)),1)]),t("div",Cn,[t("span",$n,E(e.chat.last_message||""),1),e.chat.unread_count>0?(c(),b("span",{key:0,class:Z(["unread-badge",{"unread-badge-muted":e.chat.is_muted}])},E(e.chat.unread_count>99?"99+":e.chat.unread_count),3)):L("",!0)])]),t("button",{class:Z(["star-btn",{"star-active":e.chat.is_favorite}]),title:e.chat.is_favorite?"Unstar":"Star",onClick:d[1]||(d[1]=X(p=>s("toggleFavorite"),["stop"]))},"â˜…",10,Mn)],38),t("div",xn,[t("button",{class:"swipe-action swipe-mute",onClick:d[4]||(d[4]=p=>s("toggleMute"))},E(e.chat.is_muted?"Unmute":"Mute"),1)])],544))}}),ne=(e,n)=>{const a=e.__vccOpts||e;for(const[l,i]of n)a[l]=i;return a},Le=ne(Sn,[["__scopeId","data-v-455ebfed"]]),Tn={class:"sidebar"},Dn={class:"sidebar-header"},In={class:"search-wrap"},Un={class:"chat-list"},Pn={key:0,class:"empty-state-small"},Fn={key:0,class:"chat-section-label"},Ln={key:1,class:"chat-section-label"},Nn={key:2,class:"chat-section-label"},En=j({__name:"Sidebar",emits:["openDrawer","openNewChat","selectChat"],setup(e,{emit:n}){const a=n,l=te(),i=y(""),r=O(()=>{const u=i.value.toLowerCase(),$=l.sortedChats.filter(_=>!_.is_archived);return u?$.filter(_=>{const o=w(_).toLowerCase(),d=(_.other_username||"").toLowerCase();return o.includes(u)||d.includes(u)}):$}),s=O(()=>r.value.filter(u=>u.is_pinned&&!u.is_favorite)),m=O(()=>r.value.filter(u=>u.is_favorite&&!u.is_pinned)),M=O(()=>r.value.filter(u=>!u.is_favorite&&!u.is_pinned));function w(u){return u.type==="channel"||u.type==="group"?u.title||u.name||"Untitled":u.other_display_name||u.other_username||u.title||u.name||"Chat"}const k=y(null);_e("contextChatId",k);function f(u,$){u.preventDefault(),k.value=$,window.dispatchEvent(new CustomEvent("show-context-menu",{detail:{x:u.clientX,y:u.clientY,chatId:$}}))}return(u,$)=>(c(),b("aside",Tn,[t("header",Dn,[t("button",{class:"icon-btn","aria-label":"Menu",onClick:$[0]||($[0]=_=>a("openDrawer"))},[A(I(rn),{size:20})]),t("div",In,[W(t("input",{"onUpdate:modelValue":$[1]||($[1]=_=>i.value=_),class:"search-input",type:"search",placeholder:"Search chats..."},null,512),[[K,i.value]])]),t("button",{class:"icon-btn","aria-label":"New chat",title:"New chat",onClick:$[2]||($[2]=_=>a("openNewChat"))},[A(I(vn),{size:20})])]),t("div",Un,[r.value.length===0?(c(),b("div",Pn,[...$[3]||($[3]=[oe(" No conversations yet.",-1),t("br",null,null,-1),oe("Click the pencil icon to start one. ",-1)])])):(c(),b(Y,{key:1},[s.value.length>0?(c(),b("div",Fn,"Pinned")):L("",!0),(c(!0),b(Y,null,ee(s.value,_=>(c(),V(Le,{key:_.id,chat:_,active:_.id===I(l).activeChatId,onSelect:o=>a("selectChat",_.id),onToggleFavorite:o=>I(l).toggleFavorite(_.id),onTogglePin:o=>I(l).togglePin(_.id),onToggleMute:o=>I(l).toggleMute(_.id),onToggleArchive:o=>I(l).toggleArchive(_.id),onContextmenu:o=>f(o,_.id)},null,8,["chat","active","onSelect","onToggleFavorite","onTogglePin","onToggleMute","onToggleArchive","onContextmenu"]))),128)),m.value.length>0?(c(),b("div",Ln,"Starred")):L("",!0),(c(!0),b(Y,null,ee(m.value,_=>(c(),V(Le,{key:_.id,chat:_,active:_.id===I(l).activeChatId,onSelect:o=>a("selectChat",_.id),onToggleFavorite:o=>I(l).toggleFavorite(_.id),onTogglePin:o=>I(l).togglePin(_.id),onToggleMute:o=>I(l).toggleMute(_.id),onToggleArchive:o=>I(l).toggleArchive(_.id),onContextmenu:o=>f(o,_.id)},null,8,["chat","active","onSelect","onToggleFavorite","onTogglePin","onToggleMute","onToggleArchive","onContextmenu"]))),128)),(s.value.length>0||m.value.length>0)&&M.value.length>0?(c(),b("div",Nn," All chats ")):L("",!0),(c(!0),b(Y,null,ee(M.value,_=>(c(),V(Le,{key:_.id,chat:_,active:_.id===I(l).activeChatId,onSelect:o=>a("selectChat",_.id),onToggleFavorite:o=>I(l).toggleFavorite(_.id),onTogglePin:o=>I(l).togglePin(_.id),onToggleMute:o=>I(l).toggleMute(_.id),onToggleArchive:o=>I(l).toggleArchive(_.id),onContextmenu:o=>f(o,_.id)},null,8,["chat","active","onSelect","onToggleFavorite","onTogglePin","onToggleMute","onToggleArchive","onContextmenu"]))),128))],64))])]))}});function An(){const e=y(!1),n=y(0);let a=null,l=[],i=null;async function r(){if(!navigator.mediaDevices?.getUserMedia)throw new Error("MediaDevices not supported");const k=await navigator.mediaDevices.getUserMedia({audio:!0});l=[],n.value=0,a=new MediaRecorder(k),a.ondataavailable=f=>{f.data.size&&l.push(f.data)},a.start(),e.value=!0,i=setInterval(()=>{n.value++},1e3)}function s(){return new Promise((k,f)=>{if(!a||a.state!=="recording"){f(new Error("Not recording"));return}a.onstop=()=>{a?.stream&&a.stream.getTracks().forEach(d=>d.stop()),M(),e.value=!1;const u=a?.mimeType||"audio/webm",$=u.includes("ogg")?"ogg":"webm",_=new Blob(l,{type:u}),o=new File([_],`voice.${$}`,{type:u});k(o)},a.stop()})}function m(){a&&a.state==="recording"&&(a.onstop=()=>{a?.stream&&a.stream.getTracks().forEach(k=>k.stop())},a.stop()),M(),e.value=!1,n.value=0}function M(){i&&(clearInterval(i),i=null)}function w(k){const f=Math.floor(k/60),u=k%60;return`${f}:${String(u).padStart(2,"0")}`}return{isRecording:e,seconds:n,startRecording:r,stopRecording:s,cancelRecording:m,formatTime:w}}async function st(e){const n=new FormData;n.append("file",e);const{data:a}=await R.post("/files",n);return a}const On={class:"chat-header"},Rn={class:"chat-header-name"},Bn=j({__name:"ChatHeader",emits:["back","openUserProfile"],setup(e,{emit:n}){const a=n,l=te(),i=O(()=>l.activeChat),r=O(()=>{const f=i.value;return f?f.type==="channel"||f.type==="group"?f.title||f.name||"Untitled":f.other_display_name||f.other_username||f.title||f.name||"Chat":"---"}),s=O(()=>i.value?l.getTypingUsernames(i.value.id):[]),m=O(()=>s.value.length>0),M=O(()=>{const f=i.value;return!f||f.type!=="direct"||!f.other_user_id?!1:l.isUserOnline(f.other_user_id)}),w=O(()=>{if(s.value.length===1)return`${s.value[0]} is typing...`;if(s.value.length>1)return`${s.value.length} people typing...`;const f=i.value;return f?f.type==="channel"?"Channel":f.type==="group"?"Group":M.value?"online":f.other_username?"@"+f.other_username:"":""});function k(){i.value?.type==="direct"&&i.value.other_username&&a("openUserProfile",i.value.other_username)}return(f,u)=>(c(),b("header",On,[t("button",{class:"icon-btn back-btn","aria-label":"Back",onClick:u[0]||(u[0]=$=>a("back"))},"â†"),A(ce,{class:"chat-header-avatar",name:r.value,url:i.value?.other_avatar_url,online:M.value,onClick:k},null,8,["name","url","online"]),t("div",{class:"chat-header-info",onClick:k},[t("div",Rn,E(r.value),1),t("div",{class:Z(["chat-header-sub",{"typing-text":m.value,"online-text":M.value&&!m.value}])},E(w.value),3)])]))}}),zn={},Vn={class:"admin-badge",title:"Admin"};function jn(e,n){return c(),b("span",Vn,"âœ“")}const at=ne(zn,[["render",jn]]);function Hn(e){const{delay:n=500,scrollThreshold:a=5,onLongPress:l,onCancel:i}=e,r=y(!1);let s=null,m=0,M=0,w=!1;function k(){s&&(clearTimeout(s),s=null)}function f(o){m=o.clientX,M=o.clientY,w=!1,r.value=!0,k(),s=setTimeout(()=>{w=!0,l(o)},n)}function u(o){if(!s)return;const d=o.clientX-m,p=o.clientY-M;(Math.abs(d)>a||Math.abs(p)>a)&&_()}function $(){k(),r.value=!1}function _(){k(),r.value=!1,w||i?.()}return{isPressed:r,onPointerDown:f,onPointerUp:$,onPointerMove:u}}const Wn={key:0,class:"selection-checkbox"},qn=["checked"],Gn={key:1,class:"msg-sender-name"},Xn={class:"msg-content-wrap"},Yn={key:0,class:"msg-bubble sticker-bubble"},Zn=["src","alt"],Jn={key:1,class:"msg-bubble"},Qn={class:"voice-player"},Kn=["src"],es={key:0,class:"voice-dur"},ts=["innerHTML"],ns={key:3,class:"reaction-chips"},ss=["onClick"],as={class:"reaction-emoji"},os={class:"reaction-count"},is={class:"msg-time"},ls=j({__name:"MessageBubble",props:{message:{},isMine:{type:Boolean}},emits:["mentionClick","openEmojiPicker","toggleReaction"],setup(e,{emit:n}){const a=e,l=n,i=De(),r=te(),s=O(()=>i.isSelected(a.message.id)),{onPointerDown:m,onPointerUp:M,onPointerMove:w}=Hn({delay:500,onLongPress(h){u(h.clientX,h.clientY)}}),k={onPointerdown:m,onPointerup:M,onPointermove:w};function f(h){if(i.selectionMode){i.toggleMessage(a.message.id);return}u(h.clientX,h.clientY)}function u(h,D){window.dispatchEvent(new CustomEvent("show-message-context-menu",{detail:{messageId:a.message.id,chatId:r.activeChatId,text:a.message.content||"",x:h,y:D}}))}function $(){i.selectionMode&&i.toggleMessage(a.message.id)}const _=be("stickers",y([])),o=O(()=>{if(a.message.sticker_url)return a.message.sticker_url;if(a.message.sticker_id){const h=_.value.find(D=>D.id===a.message.sticker_id);if(h)return h.url}return""}),d=O(()=>a.message.attachment_url||""),p=O(()=>S(a.message.content||"").replace(/@(\w{1,30})/g,`<span class="mention" data-u="$1" onclick="window.dispatchEvent(new CustomEvent('mention-click', {detail:'$1'}))">@$1</span>`));function S(h){return h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function x(h){if(!h)return"";const D=new Date(h.endsWith("Z")?h:h+"Z"),B=new Date;return D.toDateString()===B.toDateString()?D.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):D.toLocaleDateString([],{month:"short",day:"numeric"})}function g(h){const D=Math.floor(h/60),B=h%60;return`${D}:${String(B).padStart(2,"0")}`}function v(h){const D=h.target.getBoundingClientRect();l("openEmojiPicker",a.message.id,D.left,D.bottom+4)}return typeof window<"u"&&window.addEventListener("mention-click",(h=>{l("mentionClick",h.detail)})),(h,D)=>(c(),b("div",pt({class:["msg-row",[e.isMine?"mine":"theirs",{selected:s.value}]],onContextmenu:X(f,["prevent"])},k,{onClick:$}),[I(i).selectionMode?(c(),b("div",Wn,[t("input",{type:"checkbox",checked:s.value,tabindex:"-1"},null,8,qn)])):L("",!0),!e.isMine&&e.message.message_type!=="sticker"?(c(),b("div",Gn,[oe(E(e.message.sender_display_name||e.message.sender_username)+" ",1),e.message.sender_is_admin?(c(),V(at,{key:0})):L("",!0)])):L("",!0),t("div",Xn,[e.message.message_type==="sticker"?(c(),b("div",Yn,[t("img",{class:"sticker-img",src:o.value,alt:e.message.sticker_label||"sticker"},null,8,Zn)])):e.message.message_type==="voice"?(c(),b("div",Jn,[t("div",Qn,[t("audio",{controls:"",src:d.value},null,8,Kn),e.message.duration_seconds?(c(),b("span",es,E(g(e.message.duration_seconds)),1)):L("",!0)])])):(c(),b("div",{key:2,class:"msg-bubble",innerHTML:p.value},null,8,ts)),t("button",{class:"reaction-add-btn",onClick:X(v,["stop"])},"â˜º"),e.message.reactions&&e.message.reactions.length?(c(),b("div",ns,[(c(!0),b(Y,null,ee(e.message.reactions,B=>(c(),b("button",{key:B.emoji,class:Z(["reaction-chip",{"reaction-mine":B.me}]),onClick:X(J=>l("toggleReaction",e.message.id,B.emoji),["stop"])},[t("span",as,E(B.emoji),1),t("span",os,E(B.count),1)],10,ss))),128)),t("button",{class:"reaction-chip reaction-add-chip",onClick:X(v,["stop"])},"+")])):L("",!0)]),t("div",is,E(x(e.message.created_at)),1)],16))}}),rs={class:"composer"},cs=["onKeydown"],us=j({__name:"Composer",props:{stickerPickerOpen:{type:Boolean}},emits:["send","toggleStickers","startRecording","typing"],setup(e,{expose:n,emit:a}){const l=a,i=y(""),r=y(null);let s=0;function m(){const k=i.value.trim();k&&(l("send",k),i.value="",w())}function M(){w();const k=Date.now();k-s>2e3&&i.value.trim().length>0&&(s=k,l("typing"))}function w(){const k=r.value;k&&(k.style.height="auto",k.style.height=Math.min(k.scrollHeight,120)+"px")}return ie(()=>{r.value?.focus()}),n({focus:()=>r.value?.focus()}),(k,f)=>(c(),b("div",rs,[t("button",{class:"icon-btn composer-btn","aria-label":"Stickers",title:"Stickers",onClick:f[0]||(f[0]=u=>l("toggleStickers"))},"ðŸŒ"),W(t("textarea",{ref_key:"inputRef",ref:r,"onUpdate:modelValue":f[1]||(f[1]=u=>i.value=u),class:"composer-input",placeholder:"Message...",rows:"1",maxlength:"4000",onKeydown:gt(X(m,["exact","prevent"]),["enter"]),onInput:M},null,40,cs),[[K,i.value]]),t("button",{class:"icon-btn composer-btn record-btn","aria-label":"Voice message",title:"Record voice",onClick:f[2]||(f[2]=u=>l("startRecording"))},"ðŸŽ¤"),t("button",{class:"icon-btn composer-btn send-btn","aria-label":"Send",title:"Send",onClick:m},"âž¤")]))}}),ds={class:"sticker-grid"},vs=["title","onClick"],ms=["src","alt"],fs={key:0,class:"empty-state-small",style:{color:"var(--text-muted)"}},ps=j({__name:"StickerPicker",emits:["select"],setup(e,{emit:n}){const a=n,l=be("stickers",y([])),i=O(()=>l.value);return(r,s)=>(c(),b("div",ds,[(c(!0),b(Y,null,ee(i.value,m=>(c(),b("button",{key:m.id,class:"sticker-btn",title:m.label,onClick:M=>a("select",m.id)},[t("img",{src:m.url,alt:m.label},null,8,ms)],8,vs))),128)),i.value.length===0?(c(),b("div",fs," No stickers available ")):L("",!0)]))}}),gs={},hs={class:"msgs-loading"};function ys(e,n){return c(),b("div",hs,"Loading...")}const bs=ne(gs,[["render",ys]]),ws={class:"invite-manage",style:{padding:"0 1rem .5rem"}},ks={class:"invite-link-wrap"},_s=["value"],Cs=j({__name:"InviteSection",props:{chatId:{}},setup(e){const n=e,{showToast:a}=re(),l=y("Loading..."),i=y("");async function r(){try{const M=await bt(n.chatId);if(M.length>0){const w=M[0];i.value=w.token,l.value=`${window.location.origin}/join/${w.token}`}else{const w=await wt(n.chatId);i.value=w.token,l.value=`${window.location.origin}/join/${w.token}`}}catch{l.value="Failed to generate invite"}}function s(){l.value&&navigator.clipboard&&navigator.clipboard.writeText(l.value).then(()=>a("Link copied!"))}async function m(){if(i.value)try{await kt(i.value),a("Invite revoked"),await r()}catch{a("Failed to revoke invite")}}return ie(r),(M,w)=>(c(),b("div",ws,[w[0]||(w[0]=t("div",{class:"invite-manage-title"},"Invite Link",-1)),t("div",ks,[t("input",{class:"form-input invite-link-input",value:l.value,type:"text",readonly:""},null,8,_s),t("button",{class:"btn btn-sm btn-outline",title:"Copy link",onClick:s}," ðŸ“‹ ")]),t("button",{class:"btn btn-sm btn-ghost btn-danger",onClick:m}," Revoke link ")]))}}),$s=["onClick"],Ms=j({__name:"EmojiPicker",props:{visible:{type:Boolean},x:{},y:{}},emits:["select","close"],setup(e,{emit:n}){const a=n,l=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ™","ðŸ”¥","ðŸŽ‰","ðŸ‘","ðŸ¤”","ðŸ˜","ðŸ˜¡","ðŸ‘Ž","ðŸ‘€","ðŸš€","âœ…","âŒ","ðŸ’¯","ðŸŒŸ","ðŸ˜Š","ðŸ¤¯","ðŸ¥³","ðŸ¥²","ðŸ¤—"];return(i,r)=>e.visible?(c(),b("div",{key:0,class:"emoji-picker",style:Se({left:e.x+"px",top:e.y+"px"}),onClick:r[0]||(r[0]=X(()=>{},["stop"]))},[(c(),b(Y,null,ee(l,s=>t("button",{key:s,class:"emoji-pick-btn",onClick:m=>a("select",s)},E(s),9,$s)),64))],4)):L("",!0)}}),xs=j({__name:"MessageContextMenu",setup(e){const{showToast:n}=re(),a=y(!1),l=y(0),i=y(0),r=y(null),s=y(null),m=y(""),M=O(()=>!s.value||!r.value?null:`${window.location.origin}/c/${s.value}/m/${r.value}`);function w(p){r.value=p.detail.messageId,s.value=p.detail.chatId,m.value=p.detail.text||"",l.value=p.detail.x,i.value=p.detail.y,a.value=!0,requestAnimationFrame(()=>{const S=document.querySelector(".msg-context-menu");if(!S)return;const x=S.getBoundingClientRect();x.right>window.innerWidth&&(l.value=window.innerWidth-x.width-8),x.bottom>window.innerHeight&&(i.value=window.innerHeight-x.height-8)})}function k(){a.value&&(a.value=!1,r.value=null,s.value=null,m.value="")}ie(()=>{window.addEventListener("show-message-context-menu",w),document.addEventListener("click",k)}),fe(()=>{window.removeEventListener("show-message-context-menu",w),document.removeEventListener("click",k)});function f(){a.value=!1}async function u(){f();try{await navigator.clipboard.writeText(m.value),n("Copied to clipboard")}catch{n("Failed to copy text")}}async function $(){if(f(),!!M.value)try{await navigator.clipboard.writeText(M.value),n("Link copied")}catch{n("Failed to copy link")}}function _(){f(),!(!r.value||!s.value)&&window.dispatchEvent(new CustomEvent("forward-messages",{detail:{messageIds:[r.value],chatId:s.value}}))}function o(){f(),!(!r.value||!s.value)&&window.dispatchEvent(new CustomEvent("select-message",{detail:{messageId:r.value,chatId:s.value}}))}function d(){f(),!(!r.value||!s.value)&&window.dispatchEvent(new CustomEvent("delete-message",{detail:{messageId:r.value,chatId:s.value}}))}return(p,S)=>(c(),V(Xe,{to:"body"},[a.value?(c(),b("div",{key:0,class:"msg-context-menu",style:Se({left:l.value+"px",top:i.value+"px"}),onClick:S[0]||(S[0]=X(()=>{},["stop"])),onContextmenu:S[1]||(S[1]=X(()=>{},["prevent"]))},[S[2]||(S[2]=t("button",{class:"ctx-item",disabled:""}," Reply ",-1)),t("button",{class:"ctx-item",onClick:u}," Copy text "),M.value?(c(),b("button",{key:0,class:"ctx-item",onClick:$}," Copy link ")):L("",!0),t("button",{class:"ctx-item",onClick:_}," Forward "),t("button",{class:"ctx-item",onClick:o}," Select "),t("button",{class:"ctx-item ctx-delete",onClick:d}," Delete ")],36)):L("",!0)]))}}),Ss=ne(xs,[["__scopeId","data-v-7667b66a"]]),Ts={key:0,class:"selection-bar"},Ds={class:"selection-bar-count"},Is={class:"selection-bar-actions"},Us=["disabled"],Ps=["disabled"],Fs=j({__name:"SelectionBar",emits:["forward","delete"],setup(e,{emit:n}){const a=n,l=De();return(i,r)=>(c(),V(Ye,{name:"slide-down"},{default:Ee(()=>[I(l).selectionMode?(c(),b("div",Ts,[t("button",{class:"selection-bar-btn cancel-btn",onClick:r[0]||(r[0]=s=>I(l).exitSelectionMode())}," Cancel "),t("span",Ds,E(I(l).selectedCount)+" selected",1),t("div",Is,[t("button",{class:"selection-bar-btn forward-btn",disabled:I(l).selectedCount===0,onClick:r[1]||(r[1]=s=>a("forward"))}," Forward ("+E(I(l).selectedCount)+") ",9,Us),t("button",{class:"selection-bar-btn delete-btn",disabled:I(l).selectedCount===0,onClick:r[2]||(r[2]=s=>a("delete"))}," Delete ("+E(I(l).selectedCount)+") ",9,Ps)])])):L("",!0)]),_:1}))}}),Ls=ne(Fs,[["__scopeId","data-v-9ba988f2"]]),Ns=j({__name:"BottomSheet",props:{visible:{type:Boolean}},emits:["close"],setup(e,{emit:n}){const a=n;function l(){a("close")}return(i,r)=>(c(),V(Xe,{to:"body"},[A(Ye,{name:"bottom-sheet"},{default:Ee(()=>[e.visible?(c(),b("div",{key:0,class:"bottom-sheet-backdrop",onClick:X(l,["self"])},[t("div",{class:"bottom-sheet",onClick:r[0]||(r[0]=X(()=>{},["stop"]))},[r[1]||(r[1]=t("div",{class:"bottom-sheet-handle"},null,-1)),Ze(i.$slots,"default",{},void 0,!0)])])):L("",!0)]),_:3})]))}}),Es=ne(Ns,[["__scopeId","data-v-84fa8179"]]),As={class:"modal"},Os={class:"modal-header"},Rs={class:"modal-body"},Bs={class:"forward-chat-list"},zs={key:0,class:"empty-state-small"},Vs=["onClick"],js={class:"forward-chat-info"},Hs={class:"forward-chat-name"},Ws={class:"forward-chat-type"},qs={key:0,class:"forward-check"},Gs={class:"modal-actions"},Xs=["disabled"],Ys=j({__name:"ForwardDialog",props:{messageIds:{},fromChatId:{}},emits:["close","forwarded"],setup(e,{emit:n}){const a=e,l=n,i=te(),r=Ae(),{showToast:s}=re(),m=y(""),M=y(null),w=y(!1),k=O(()=>{const o=m.value.toLowerCase().trim(),d=i.sortedChats;return o?d.filter(p=>f(p).toLowerCase().includes(o)):d});function f(o){return o.type==="direct"?o.other_display_name||o.other_username||o.title||"Direct Chat":o.title||o.name||"Unnamed Chat"}function u(o){if(o.type==="direct")return o.other_avatar_url??void 0}function $(){}async function _(){if(M.value!==null){w.value=!0;try{await r.forwardMessages(M.value,a.fromChatId,a.messageIds),s("Message forwarded!"),l("forwarded",M.value)}catch{s("Failed to forward message")}finally{w.value=!1}}}return(o,d)=>(c(),b("div",{class:"modal-backdrop",onClick:d[2]||(d[2]=X(p=>l("close"),["self"]))},[t("div",As,[t("div",Os,[d[3]||(d[3]=t("h2",{class:"modal-title"},"Forward Message",-1)),t("button",{class:"icon-btn",onClick:d[0]||(d[0]=p=>l("close"))},"âœ•")]),t("div",Rs,[W(t("input",{"onUpdate:modelValue":d[1]||(d[1]=p=>m.value=p),class:"search-input",type:"search",placeholder:"Search chats...",onInput:$},null,544),[[K,m.value]]),t("div",Bs,[k.value.length===0?(c(),b("div",zs,"No chats found.")):L("",!0),(c(!0),b(Y,null,ee(k.value,p=>(c(),b("div",{key:p.id,class:Z(["forward-chat-item",{selected:M.value===p.id}]),onClick:S=>M.value=p.id},[A(ce,{name:f(p),url:u(p),size:"sm"},null,8,["name","url"]),t("div",js,[t("div",Hs,E(f(p)),1),t("div",Ws,E(p.type),1)]),M.value===p.id?(c(),b("span",qs,"âœ“")):L("",!0)],10,Vs))),128))]),t("div",Gs,[t("button",{class:"btn btn-primary",disabled:M.value===null||w.value,onClick:_},E(w.value?"Forwarding...":"Forward"),9,Xs)])])])]))}}),Zs=ne(Ys,[["__scopeId","data-v-ce3f4600"]]),Js={class:"modal modal-sm"},Qs={class:"modal-header"},Ks={class:"modal-body"},ea={class:"delete-confirm-text"},ta={key:0,class:"delete-checkbox-label"},na={class:"modal-actions"},sa=j({__name:"DeleteConfirmModal",props:{messageCount:{default:1},canDeleteForEveryone:{type:Boolean,default:!1}},emits:["close","confirm"],setup(e,{emit:n}){const a=n,l=y(!1);function i(){a("confirm",l.value)}return(r,s)=>(c(),b("div",{class:"modal-backdrop",onClick:s[3]||(s[3]=X(m=>a("close"),["self"]))},[t("div",Js,[t("div",Qs,[s[4]||(s[4]=t("h2",{class:"modal-title"},"Delete Message",-1)),t("button",{class:"icon-btn",onClick:s[0]||(s[0]=m=>a("close"))},"âœ•")]),t("div",Ks,[t("p",ea," Are you sure you want to delete "+E(e.messageCount>1?`these ${e.messageCount} messages`:"this message")+"? ",1),e.canDeleteForEveryone?(c(),b("label",ta,[W(t("input",{"onUpdate:modelValue":s[1]||(s[1]=m=>l.value=m),type:"checkbox",class:"delete-checkbox"},null,512),[[Je,l.value]]),s[5]||(s[5]=oe(" Delete for everyone ",-1))])):L("",!0)]),t("div",na,[t("button",{class:"btn btn-ghost",onClick:s[2]||(s[2]=m=>a("close"))},"Cancel"),t("button",{class:"btn btn-danger",onClick:i},"Delete")])])]))}}),aa=ne(sa,[["__scopeId","data-v-388dbae2"]]),oa={class:"chat-panel"},ia={key:0,class:"empty-chat"},la={key:1,class:"chat-view"},ra={key:0,class:"channel-readonly-bar"},ca={key:0,class:"date-sep"},ua={key:1,class:"sticker-picker"},da={key:3,class:"recording-bar"},va={class:"rec-time"},ma=j({__name:"ChatPanel",emits:["back","openUserProfile"],setup(e,{emit:n}){const a=n,l=pe(),i=te(),r=Ae(),{showToast:s}=re(),m=An(),M=be("stickers",y([])),w=be("sendTyping",()=>{}),k=be("pendingScrollMessageId",y(null)),f=y(null),u=y(!1),$=y(!1),_=y("member"),o=y(!1),d=y(!1),p=y(0),S=y(0),x=y(null),g=De(),v=y(!1),h=y(null),D=y(""),B=y(!1),J=y([]),se=y(!1),ae=y([]),ue=y(!1);let H=null;const T=O(()=>i.activeChat?.type==="channel"&&_.value==="member"),F=O(()=>i.activeChatId?r.getMessages(i.activeChatId):[]),ge=O(()=>{const U=[];let C="";for(const P of F.value){const Q=Ie(P.created_at);Q!==C&&(U.push({type:"date",label:Q}),C=Q),U.push({type:"msg",msg:P})}return U});function Ie(U){if(!U)return"";const C=new Date(U.endsWith("Z")?U:U+"Z"),P=new Date;if(C.toDateString()===P.toDateString())return"Today";const Q=new Date(P);return Q.setDate(P.getDate()-1),C.toDateString()===Q.toDateString()?"Yesterday":C.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})}me(()=>i.activeChatId,async U=>{if(u.value=!1,_.value="member",o.value=!1,H&&(clearInterval(H),H=null),!U)return;await r.loadMessages(U),await de(),ve();const C=i.activeChat;if(C&&(C.type==="channel"||C.type==="group"))try{const P=await Ct(U);_.value=P.my_role||"member",o.value=_.value==="owner"||_.value==="admin"}catch{}H=setInterval(()=>{i.activeChatId===U&&r.loadNewer(U).then(P=>{P.length>0&&ke()})},2500)});function ve(){f.value&&(f.value.scrollTop=f.value.scrollHeight)}function ke(){if(!f.value)return;const U=f.value;U.scrollHeight-U.scrollTop-U.clientHeight<80&&de(()=>{U.scrollTop=U.scrollHeight})}function z(){i.activeChatId&&w(i.activeChatId)}async function N(U){if(!(!i.activeChatId||!U.trim()))try{const C=await r.sendMessage(i.activeChatId,U.trim(),"text");l.user&&(C.sender_id=l.user.id,C.sender_username=l.user.username,C.sender_display_name=l.user.display_name),await de(),ve(),i.loadChats()}catch{s("Failed to send message")}}async function q(U){if(i.activeChatId){u.value=!1;try{const C=await r.sendMessage(i.activeChatId,"","sticker",{sticker_id:U}),P=M.value.find(Q=>Q.id===U);P&&(C.sticker_url=P.url,C.sticker_label=P.label),await de(),ve(),i.loadChats()}catch{s("Failed to send sticker")}}}function le(U,C,P){x.value=U,p.value=C,S.value=P,d.value=!0}function Oe(U){x.value&&i.activeChatId&&r.toggleReaction(i.activeChatId,x.value,U),d.value=!1,x.value=null}function ot(U,C){i.activeChatId&&r.toggleReaction(i.activeChatId,U,C)}function it(){d.value=!1,x.value=null}async function lt(){try{await m.startRecording(),$.value=!0;const U=await m.stopRecording();$.value=!1,await mt(U)}catch{$.value=!1,s("Microphone access denied")}}function rt(){m.cancelRecording(),$.value=!1}function Re(U){const{messageIds:C}=U.detail;J.value=C,B.value=!0}function Be(U){const{messageId:C,chatId:P}=U.detail;P&&g.enterSelectionMode(P,C)}function Ue(U){const{messageId:C,chatId:P}=U.detail;if(!C||!P)return;ae.value=[C];const Q=F.value.find(ft=>ft.id===C);ue.value=!!(Q&&Q.sender_id===l.user?.id),se.value=!0}function ct(){J.value=[...g.selectedMessageIds],B.value=!0}function ut(){ae.value=[...g.selectedMessageIds],ue.value=ae.value.every(U=>{const C=F.value.find(P=>P.id===U);return C&&C.sender_id===l.user?.id}),se.value=!0}function ze(){B.value=!1,J.value=[],g.exitSelectionMode()}async function dt(U){se.value=!1;const C=i.activeChatId;if(C){for(const P of ae.value)try{await r.deleteMessage(C,P)}catch{s("Failed to delete message")}ae.value=[],g.exitSelectionMode()}}function he(U){v.value=!1;const C=h.value,P=i.activeChatId;if(!(!C||!P))switch(U){case"copy":navigator.clipboard.writeText(D.value).then(()=>s("Copied to clipboard"),()=>s("Failed to copy text"));break;case"copyLink":navigator.clipboard.writeText(`${window.location.origin}/c/${P}/m/${C}`).then(()=>s("Link copied"),()=>s("Failed to copy link"));break;case"forward":J.value=[C],B.value=!0;break;case"select":g.enterSelectionMode(P,C);break;case"delete":Ue(new CustomEvent("",{detail:{messageId:C,chatId:P}}));break}}function vt(U){if(!f.value)return;const C=f.value.querySelector(`[data-message-id="${U}"]`);C&&(C.scrollIntoView({behavior:"smooth",block:"center"}),C.classList.add("highlight-message"),setTimeout(()=>C.classList.remove("highlight-message"),2e3))}ie(()=>{window.addEventListener("forward-messages",Re),window.addEventListener("select-message",Be),window.addEventListener("delete-message",Ue)}),fe(()=>{window.removeEventListener("forward-messages",Re),window.removeEventListener("select-message",Be),window.removeEventListener("delete-message",Ue)}),me(()=>k.value,async U=>{U&&(await de(),setTimeout(()=>{vt(U),k.value=null},300))}),me(()=>i.activeChatId,()=>{g.exitSelectionMode()});async function mt(U){if(i.activeChatId)try{const C=await st(U);await r.sendMessage(i.activeChatId,"","voice",{file_id:C.id,duration_seconds:m.seconds.value}),await r.loadMessages(i.activeChatId),await de(),ve(),i.loadChats()}catch{s("Failed to upload voice message")}}return(U,C)=>(c(),b("main",oa,[I(i).activeChatId?(c(),b("div",la,[A(Ls,{onForward:ct,onDelete:ut}),W(A(Bn,{onBack:C[0]||(C[0]=P=>a("back")),onOpenUserProfile:C[1]||(C[1]=P=>a("openUserProfile",P))},null,512),[[$e,!I(g).selectionMode]]),T.value?(c(),b("div",ra,[...C[13]||(C[13]=[t("span",{class:"readonly-icon"},"ðŸ”’",-1),t("span",{class:"readonly-text"},"Only admins can send messages in this channel.",-1)])])):L("",!0),t("div",{ref_key:"msgListRef",ref:f,class:"msg-list",onClick:it},[I(r).loadingChat===I(i).activeChatId?(c(),V(bs,{key:0})):(c(!0),b(Y,{key:1},ee(ge.value,P=>(c(),b(Y,{key:P.type==="date"?"date-"+P.label:"msg-"+P.msg.id},[P.type==="date"?(c(),b("div",ca,[t("span",null,E(P.label),1)])):(c(),V(ls,{key:1,message:P.msg,"is-mine":P.msg.sender_id===I(l).user?.id,onMentionClick:C[2]||(C[2]=Q=>a("openUserProfile",Q)),onOpenEmojiPicker:le,onToggleReaction:ot},null,8,["message","is-mine"]))],64))),128))],512),A(Ms,{visible:d.value,x:p.value,y:S.value,onSelect:Oe,onClose:C[3]||(C[3]=P=>d.value=!1)},null,8,["visible","x","y"]),u.value?(c(),b("div",ua,[A(ps,{onSelect:q})])):L("",!0),T.value?L("",!0):W((c(),V(us,{key:2,"sticker-picker-open":u.value,onSend:N,onToggleStickers:C[4]||(C[4]=P=>u.value=!u.value),onStartRecording:lt,onTyping:z},null,8,["sticker-picker-open"])),[[$e,!$.value]]),$.value?(c(),b("div",da,[C[14]||(C[14]=t("span",{class:"rec-dot"},null,-1)),t("span",va,E(I(m).formatTime(I(m).seconds.value)),1),C[15]||(C[15]=t("span",{class:"rec-label"},"Recording... tap mic to stop",-1)),t("button",{class:"icon-btn rec-cancel",title:"Cancel",onClick:rt},"âœ•")])):L("",!0),o.value?(c(),V(Cs,{key:4,"chat-id":I(i).activeChatId},null,8,["chat-id"])):L("",!0),A(Ss),A(Es,{visible:v.value,onClose:C[10]||(C[10]=P=>v.value=!1)},{default:Ee(()=>[C[16]||(C[16]=t("button",{class:"ctx-item",disabled:""},"Reply",-1)),t("button",{class:"ctx-item",onClick:C[5]||(C[5]=P=>he("copy"))},"Copy text"),t("button",{class:"ctx-item",onClick:C[6]||(C[6]=P=>he("copyLink"))},"Copy link"),t("button",{class:"ctx-item",onClick:C[7]||(C[7]=P=>he("forward"))},"Forward"),t("button",{class:"ctx-item",onClick:C[8]||(C[8]=P=>he("select"))},"Select"),t("button",{class:"ctx-item ctx-delete",onClick:C[9]||(C[9]=P=>he("delete"))},"Delete")]),_:1},8,["visible"]),B.value?(c(),V(Zs,{key:5,"message-ids":J.value,"from-chat-id":I(i).activeChatId,onClose:ze,onForwarded:ze},null,8,["message-ids","from-chat-id"])):L("",!0),se.value?(c(),V(aa,{key:6,"message-count":ae.value.length,"can-delete-for-everyone":ue.value,onClose:C[11]||(C[11]=P=>se.value=!1),onConfirm:dt},null,8,["message-count","can-delete-for-everyone"])):L("",!0)])):(c(),b("div",ia,[...C[12]||(C[12]=[t("div",{class:"empty-chat-icon"},"ðŸ’¬",-1),t("div",{class:"empty-chat-text"},"Select a chat to start messaging",-1)])]))]))}}),fa=[{id:"my-profile",label:"My Profile",icon:"user",action:"openProfile",visible:()=>!0,rightSlot:"none"},{id:"create-group",label:"Create Group",icon:"users",action:"createGroup",visible:()=>!0,rightSlot:"none"},{id:"create-channel",label:"Create Channel",icon:"megaphone",action:"createChannel",visible:()=>!0,rightSlot:"none"},{id:"favorites",label:"Favorites",icon:"bookmark",action:"openFavorites",visible:()=>!0,rightSlot:"none"},{id:"settings",label:"Settings",icon:"settings",action:"openSettings",visible:()=>!0,rightSlot:"none",separator:!0},{id:"night-mode",label:"Night Mode",icon:"moon",action:"toggleNightMode",visible:()=>!0,rightSlot:"toggle"},{id:"download-app",label:"Download App",icon:"download",action:"openDownload",visible:e=>e.isDesktop,rightSlot:"none"},{id:"logout",label:"Log Out",icon:"log-out",action:"logout",visible:e=>e.isAuthenticated,rightSlot:"none",separator:!0}];function pa(e){return fa.filter(n=>n.visible(e))}const ga=["disabled"],ha={class:"menu-item__label"},ya={key:1,class:"menu-item__badge"},ba=j({__name:"MenuItem",props:{icon:{},label:{},badge:{},chevron:{type:Boolean},danger:{type:Boolean},disabled:{type:Boolean}},emits:["click"],setup(e,{emit:n}){const a=n;return(l,i)=>(c(),b("button",{class:Z(["menu-item",{"menu-item--danger":e.danger,"menu-item--disabled":e.disabled}]),disabled:e.disabled,onClick:i[0]||(i[0]=r=>a("click"))},[e.icon?(c(),V(Me(e.icon),{key:0,class:"menu-item__icon",size:24,"stroke-width":1.8})):L("",!0),t("span",ha,E(e.label),1),e.badge?(c(),b("span",ya,E(e.badge),1)):L("",!0),Ze(l.$slots,"right",{},void 0),e.chevron?(c(),V(Me(I(sn)),{key:2,class:"menu-item__chevron",size:18,"stroke-width":1.8})):L("",!0)],10,ga))}}),Ge=ne(ba,[["__scopeId","data-v-682bc042"]]),wa={class:"drawer-header"},ka={class:"drawer-avatar-wrap"},_a={class:"drawer-user-info"},Ca={class:"drawer-display-name"},$a={class:"drawer-username"},Ma={class:"drawer-nav"},xa={key:0,class:"drawer-divider"},Sa=["onClick"],Ta={class:"menu-item__label"},Da=["aria-checked"],Ia=j({__name:"Drawer",props:{open:{type:Boolean}},emits:["close","openProfile","openSettings","openNewGroup","openNewChannel","openFavorites","openDownload"],setup(e,{emit:n}){const a=n,l=Qe(),i=pe(),r=Te(),s={user:tt,users:nt,megaphone:et,bookmark:en,settings:dn,moon:un,download:an,"log-out":ln,star:mn},m=O(()=>({isAuthenticated:!!i.user,isDesktop:!0})),M=O(()=>pa(m.value)),w={openProfile:()=>a("openProfile"),createGroup:()=>a("openNewGroup"),createChannel:()=>a("openNewChannel"),openFavorites:()=>a("openFavorites"),openSettings:()=>a("openSettings"),toggleNightMode:()=>{const f=r.theme==="dark"?"light":"dark";r.applyTheme(f),r.saveSettings({theme:f})},openDownload:()=>a("openDownload"),logout:()=>{i.logout(),l.push("/login")}};function k(f){f&&w[f]&&w[f]()}return(f,u)=>(c(),b("div",{class:Z(["drawer",{open:e.open}])},[t("div",wa,[t("button",{class:"icon-btn","aria-label":"Close menu",onClick:u[0]||(u[0]=$=>a("close"))},[A(I(we),{size:20,"stroke-width":2})]),u[1]||(u[1]=t("span",{class:"drawer-title"},"Menu",-1))]),t("div",ka,[A(ce,{name:I(i).user?.display_name||I(i).user?.username||"?",url:I(i).user?.avatar_url,size:"lg"},null,8,["name","url"]),t("div",_a,[t("div",Ca,E(I(i).user?.display_name||I(i).user?.username||"---"),1),t("div",$a,"@"+E(I(i).user?.username||"---"),1)])]),t("nav",Ma,[(c(!0),b(Y,null,ee(M.value,$=>(c(),b(Y,{key:$.id},[$.separator?(c(),b("div",xa)):L("",!0),$.rightSlot==="toggle"?(c(),b("div",{key:1,class:"menu-item menu-item--toggle",onClick:_=>k($.action)},[(c(),V(Me(s[$.icon]),{class:"menu-item__icon",size:24,"stroke-width":1.8})),t("span",Ta,E($.label),1),t("span",{class:Z(["toggle-switch",{"toggle-switch--on":I(r).theme==="dark"}]),role:"switch","aria-checked":I(r).theme==="dark"},[...u[2]||(u[2]=[t("span",{class:"toggle-switch__thumb"},null,-1)])],10,Da)],8,Sa)):$.id==="logout"?(c(),V(Ge,{key:2,icon:s[$.icon],label:$.label,danger:"",onClick:_=>k($.action)},null,8,["icon","label","onClick"])):(c(),V(Ge,{key:3,icon:s[$.icon],label:$.label,onClick:_=>k($.action)},null,8,["icon","label","onClick"]))],64))),128))]),u[3]||(u[3]=t("div",{class:"drawer-footer"},"Simple Messenger v2",-1))],2))}}),Ua=ne(Ia,[["__scopeId","data-v-de7cf394"]]),Pa={class:"modal"},Fa={class:"modal-header"},La={class:"modal-body"},Na={key:0,class:"chat-type-cards"},Ea={class:"chat-type-icon"},Aa={class:"chat-type-icon"},Oa={class:"chat-type-icon"},Ra={key:1,class:"new-chat-form"},Ba={class:"user-pick-list"},za={key:0,class:"empty-state-small"},Va={key:1,class:"empty-state-small"},ja=["onClick"],Ha={class:"user-pick-name"},Wa={class:"user-pick-handle"},qa={key:2,class:"new-chat-form"},Ga={class:"form-group"},Xa={class:"form-group"},Ya={class:"form-group"},Za={class:"user-pick-list"},Ja=["onClick"],Qa={class:"user-pick-name"},Ka={class:"user-pick-handle"},eo={class:"modal-actions"},to=["disabled"],no={key:3,class:"new-chat-form"},so={class:"form-group"},ao={class:"form-group"},oo={class:"form-group"},io={class:"modal-actions"},lo=["disabled"],ro=j({__name:"NewChatModal",props:{initialStep:{default:"select"}},emits:["close","chatCreated"],setup(e,{emit:n}){const a=e,l=n,i=pe(),{showToast:r}=re(),s=y(a.initialStep),m=y(!1),M=y(""),w=y([]),k=y(!1);let f=null;const u=y(""),$=y(""),_=y(""),o=y([]),d=y(new Set);let p=null;const S=y(""),x=y(""),g=y("");ie(()=>{v("")});async function v(H){k.value=!0;try{const T=await je(H);w.value=T.filter(F=>F.id!==i.user?.id)}catch{w.value=[]}finally{k.value=!1}}function h(){f&&clearTimeout(f),f=setTimeout(()=>v(M.value),300)}async function D(H){try{o.value=await je(H)}catch{o.value=[]}}function B(){p&&clearTimeout(p),p=setTimeout(()=>D(_.value),300)}function J(H){d.value.has(H)?d.value.delete(H):d.value.add(H)}async function se(H){m.value=!0;try{const T=await Ce({type:"direct",member_ids:[H]});l("chatCreated",T.id)}catch{r("Failed to start conversation")}finally{m.value=!1}}async function ae(){if(!u.value.trim()){r("Group name is required");return}m.value=!0;try{const H=await Ce({type:"group",title:u.value.trim(),description:$.value.trim(),member_ids:Array.from(d.value)});r("Group created!"),l("chatCreated",H.id)}catch{r("Failed to create group")}finally{m.value=!1}}async function ue(){if(!S.value.trim()){r("Channel name is required");return}m.value=!0;try{const H=await Ce({type:"channel",title:S.value.trim(),description:g.value.trim(),public_name:x.value.trim()||void 0,member_ids:[]});r("Channel created!"),l("chatCreated",H.id)}catch{r("Failed to create channel")}finally{m.value=!1}}return(H,T)=>(c(),b("div",{class:"modal-backdrop",onClick:T[14]||(T[14]=X(F=>l("close"),["self"]))},[t("div",Pa,[t("div",Fa,[T[15]||(T[15]=t("h2",{class:"modal-title"},"New Conversation",-1)),t("button",{class:"icon-btn",onClick:T[0]||(T[0]=F=>l("close"))},[A(I(we),{size:20})])]),t("div",La,[s.value==="select"?(c(),b("div",Na,[t("button",{class:"chat-type-card",onClick:T[1]||(T[1]=F=>s.value="direct")},[t("span",Ea,[A(I(tt),{size:24})]),T[16]||(T[16]=t("div",null,[t("div",{class:"chat-type-label"},"Direct Chat"),t("div",{class:"chat-type-desc"},"Private 1-on-1 conversation")],-1))]),t("button",{class:"chat-type-card",onClick:T[2]||(T[2]=F=>s.value="group")},[t("span",Aa,[A(I(nt),{size:24})]),T[17]||(T[17]=t("div",null,[t("div",{class:"chat-type-label"},"Group Chat"),t("div",{class:"chat-type-desc"},"Chat with multiple people")],-1))]),t("button",{class:"chat-type-card",onClick:T[3]||(T[3]=F=>s.value="channel")},[t("span",Oa,[A(I(et),{size:24})]),T[18]||(T[18]=t("div",null,[t("div",{class:"chat-type-label"},"Channel"),t("div",{class:"chat-type-desc"},"Broadcast to subscribers")],-1))])])):L("",!0),s.value==="direct"?(c(),b("div",Ra,[t("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:T[4]||(T[4]=F=>s.value="select")},[A(I(Fe),{size:16}),T[19]||(T[19]=oe(" Back ",-1))]),W(t("input",{"onUpdate:modelValue":T[5]||(T[5]=F=>M.value=F),class:"search-input",type:"search",placeholder:"Search users...",onInput:h},null,544),[[K,M.value]]),t("div",Ba,[k.value?(c(),b("div",za,"Loading users...")):w.value.length===0?(c(),b("div",Va,"No users found.")):(c(!0),b(Y,{key:2},ee(w.value,F=>(c(),b("div",{key:F.id,class:"user-pick-item",onClick:ge=>se(F.id)},[A(ce,{name:F.display_name||F.username,url:F.avatar_url,size:"sm"},null,8,["name","url"]),t("div",null,[t("div",Ha,E(F.display_name||F.username),1),t("div",Wa,"@"+E(F.username),1)])],8,ja))),128))])])):L("",!0),s.value==="group"?(c(),b("div",qa,[t("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:T[6]||(T[6]=F=>s.value="select")},[A(I(Fe),{size:16}),T[20]||(T[20]=oe(" Back ",-1))]),t("div",Ga,[T[21]||(T[21]=t("label",{class:"form-label"},"Group name",-1)),W(t("input",{"onUpdate:modelValue":T[7]||(T[7]=F=>u.value=F),class:"form-input",type:"text",maxlength:"64",placeholder:"My Group"},null,512),[[K,u.value]])]),t("div",Xa,[T[22]||(T[22]=t("label",{class:"form-label"},"Description (optional)",-1)),W(t("textarea",{"onUpdate:modelValue":T[8]||(T[8]=F=>$.value=F),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this group about?"},null,512),[[K,$.value]])]),t("div",Ya,[T[23]||(T[23]=t("label",{class:"form-label"},"Add members",-1)),W(t("input",{"onUpdate:modelValue":T[9]||(T[9]=F=>_.value=F),class:"search-input",type:"search",placeholder:"Search users...",onInput:B},null,544),[[K,_.value]]),t("div",Za,[(c(!0),b(Y,null,ee(o.value,F=>(c(),b("div",{key:F.id,class:Z(["user-pick-item",{selected:d.value.has(F.id)}]),onClick:ge=>J(F.id)},[A(ce,{name:F.display_name||F.username,url:F.avatar_url,size:"sm"},null,8,["name","url"]),t("div",null,[t("div",Qa,[d.value.has(F.id)?(c(),V(I(nn),{key:0,size:14,style:{"margin-right":"4px"}})):L("",!0),oe(E(F.display_name||F.username),1)]),t("div",Ka,"@"+E(F.username),1)])],10,Ja))),128))])]),t("div",eo,[t("button",{class:"btn btn-primary",disabled:m.value,onClick:ae}," Create Group ",8,to)])])):L("",!0),s.value==="channel"?(c(),b("div",no,[t("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:T[10]||(T[10]=F=>s.value="select")},[A(I(Fe),{size:16}),T[24]||(T[24]=oe(" Back ",-1))]),t("div",so,[T[25]||(T[25]=t("label",{class:"form-label"},"Channel name",-1)),W(t("input",{"onUpdate:modelValue":T[11]||(T[11]=F=>S.value=F),class:"form-input",type:"text",maxlength:"64",placeholder:"My Channel"},null,512),[[K,S.value]])]),t("div",ao,[T[26]||(T[26]=t("label",{class:"form-label"},"Public link name (optional)",-1)),W(t("input",{"onUpdate:modelValue":T[12]||(T[12]=F=>x.value=F),class:"form-input",type:"text",maxlength:"64",placeholder:"my-channel"},null,512),[[K,x.value]]),T[27]||(T[27]=t("small",{class:"form-hint"},"Letters, numbers, hyphens, underscores. Used for /c/your-name links.",-1))]),t("div",oo,[T[28]||(T[28]=t("label",{class:"form-label"},"Description (optional)",-1)),W(t("textarea",{"onUpdate:modelValue":T[13]||(T[13]=F=>g.value=F),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this channel about?"},null,512),[[K,g.value]])]),t("div",io,[t("button",{class:"btn btn-primary",disabled:m.value,onClick:ue}," Create Channel ",8,lo)])])):L("",!0)])])]))}}),co={class:"modal profile-modal profile-modal--self"},uo={class:"profile-tabs"},vo={class:"profile-modal-body profile-modal-body--scrollable"},mo={class:"profile-avatar-section profile-avatar-upload-section"},fo={class:"profile-avatar-overlay"},po={class:"profile-name"},go={key:0,class:"profile-status profile-status--online"},ho={class:"profile-info-list"},yo={class:"form-group"},bo={class:"form-group"},wo={key:0,class:"form-hint form-error"},ko={class:"form-group"},_o={class:"profile-info-item"},Co={class:"profile-info-value"},$o={class:"profile-edit-actions"},Mo={class:"profile-info-list"},xo={class:"form-group form-inline"},So={class:"form-group form-inline"},To={class:"toggle"},Do={class:"form-group form-inline"},Io=j({__name:"ProfileModal",props:{initialTab:{default:"profile"}},emits:["close"],setup(e,{emit:n}){const a=e,l=n,i=pe(),r=Te(),{showToast:s}=re(),m=y(a.initialTab),M=y(""),w=y(""),k=y(""),f=y(""),u=y(null),$=y("light"),_=y(!0),o=y("en");me(_,async x=>{x&&"Notification"in window&&await Notification.requestPermission()==="denied"&&(_.value=!1,s("Notifications blocked by browser"))}),ie(async()=>{i.user&&(M.value=i.user.display_name||"",w.value=i.user.username,k.value=i.user.bio||""),$.value=r.theme,_.value=r.notificationsEnabled,o.value=r.language});async function d(){const x=u.value?.files?.[0];if(x){try{const g=await st(x),v=await qt(g.id);i.updateUser({avatar_url:v.avatar_url}),s("Avatar updated!")}catch{s("Upload failed")}u.value&&(u.value.value="")}}async function p(){if(f.value="",!i.user)return;const x={display_name:M.value.trim(),bio:k.value.trim()};w.value.trim()&&w.value.trim()!==i.user.username&&(x.username=w.value.trim());try{const g=await Wt(i.user.id,x);i.updateUser({display_name:g.display_name,username:g.username}),s("Profile saved!"),l("close")}catch(g){g.response?.status===409?f.value="Username already taken":s("Save failed")}}async function S(){try{await r.saveSettings({theme:$.value,notifications_enabled:_.value,language:o.value}),s("Settings saved!"),l("close")}catch{s("Settings save failed")}}return(x,g)=>(c(),b("div",{class:"modal-backdrop profile-backdrop",onClick:g[11]||(g[11]=X(v=>l("close"),["self"]))},[t("div",co,[t("button",{class:"icon-btn profile-close-btn","aria-label":"Close",onClick:g[0]||(g[0]=v=>l("close"))},[A(I(we),{size:20,"stroke-width":2})]),t("div",uo,[t("button",{class:Z(["profile-tab",{active:m.value==="profile"}]),onClick:g[1]||(g[1]=v=>m.value="profile")},"Profile",2),t("button",{class:Z(["profile-tab",{active:m.value==="settings"}]),onClick:g[2]||(g[2]=v=>m.value="settings")},"Settings",2)]),t("div",vo,[W(t("div",null,[t("div",mo,[t("div",{class:"profile-avatar-upload-wrap",onClick:g[3]||(g[3]=v=>u.value?.click())},[A(ce,{name:M.value||I(i).user?.username||"?",url:I(i).user?.avatar_url,size:"xxl"},null,8,["name","url"]),t("div",fo,[A(I(tn),{size:24,"stroke-width":1.8,class:"profile-avatar-overlay-icon"})])]),t("input",{ref_key:"fileInput",ref:u,type:"file",accept:"image/*",class:"hidden",onChange:d},null,544)]),t("div",po,E(M.value||I(i).user?.username||"?"),1),I(i).user?(c(),b("div",go," online ")):L("",!0),g[16]||(g[16]=t("div",{class:"profile-divider"},null,-1)),t("div",ho,[t("div",yo,[g[12]||(g[12]=t("label",{class:"form-label"},"Display name",-1)),W(t("input",{"onUpdate:modelValue":g[4]||(g[4]=v=>M.value=v),class:"form-input",type:"text",maxlength:"64",placeholder:"Your name"},null,512),[[K,M.value]])]),t("div",bo,[g[13]||(g[13]=t("label",{class:"form-label"},"Username",-1)),W(t("input",{"onUpdate:modelValue":g[5]||(g[5]=v=>w.value=v),class:"form-input",type:"text",maxlength:"20",placeholder:"username"},null,512),[[K,w.value]]),f.value?(c(),b("small",wo,E(f.value),1)):L("",!0)]),t("div",ko,[g[14]||(g[14]=t("label",{class:"form-label"},"Bio",-1)),W(t("textarea",{"onUpdate:modelValue":g[6]||(g[6]=v=>k.value=v),class:"form-input",maxlength:"200",rows:"3",placeholder:"About you..."},null,512),[[K,k.value]])]),t("div",_o,[g[15]||(g[15]=t("div",{class:"profile-info-label"},"User ID",-1)),t("div",Co,E(I(i).user?.id),1)])]),t("div",$o,[t("button",{class:"btn btn-primary",onClick:p},"Save Profile"),t("button",{class:"btn btn-ghost",onClick:g[7]||(g[7]=v=>l("close"))},"Cancel")])],512),[[$e,m.value==="profile"]]),W(t("div",null,[t("div",Mo,[t("div",xo,[g[18]||(g[18]=t("label",{class:"form-label"},"Theme",-1)),W(t("select",{"onUpdate:modelValue":g[8]||(g[8]=v=>$.value=v),class:"form-input form-select"},[...g[17]||(g[17]=[t("option",{value:"light"},"Light",-1),t("option",{value:"dark"},"Dark",-1)])],512),[[Ve,$.value]])]),t("div",So,[g[20]||(g[20]=t("label",{class:"form-label"},"Notifications",-1)),t("label",To,[W(t("input",{"onUpdate:modelValue":g[9]||(g[9]=v=>_.value=v),type:"checkbox"},null,512),[[Je,_.value]]),g[19]||(g[19]=t("span",{class:"toggle-slider"},null,-1))])]),t("div",Do,[g[22]||(g[22]=t("label",{class:"form-label"},"Language",-1)),W(t("select",{"onUpdate:modelValue":g[10]||(g[10]=v=>o.value=v),class:"form-input form-select"},[...g[21]||(g[21]=[t("option",{value:"en"},"English",-1),t("option",{value:"ru"},"Ð ÑƒÑÑÐºÐ¸Ð¹",-1),t("option",{value:"de"},"Deutsch",-1)])],512),[[Ve,o.value]])])]),t("div",{class:"profile-edit-actions"},[t("button",{class:"btn btn-primary",onClick:S},"Save Settings")])],512),[[$e,m.value==="settings"]])])])]))}}),Uo={class:"profile-actions"},Po=["disabled","onClick"],Fo={class:"profile-action-btn__circle"},Lo={class:"profile-action-btn__label"},No=j({__name:"ProfileActionButtons",props:{showMute:{type:Boolean},showMore:{type:Boolean},muted:{type:Boolean}},emits:["message","mute","more"],setup(e,{emit:n}){const a=e,l=n,i=O(()=>{const r=[{icon:cn,label:"Message",event:"message"}];return a.showMute!==!1&&r.push({icon:Kt,label:a.muted?"Unmute":"Mute",event:"mute"}),a.showMore!==!1&&r.push({icon:on,label:"More",event:"more"}),r});return(r,s)=>(c(),b("div",Uo,[(c(!0),b(Y,null,ee(i.value,m=>(c(),b("button",{key:m.label,class:Z(["profile-action-btn",{"profile-action-btn--danger":m.danger}]),disabled:m.disabled,onClick:M=>l(m.event)},[t("span",Fo,[(c(),V(Me(m.icon),{size:22,"stroke-width":1.8}))]),t("span",Lo,E(m.label),1)],10,Po))),128))]))}}),Eo=ne(No,[["__scopeId","data-v-b5376905"]]),Ao={class:"modal profile-modal"},Oo={class:"profile-modal-body"},Ro={key:0,class:"profile-loading"},Bo={class:"profile-avatar-section"},zo={class:"profile-name"},Vo={class:"profile-info-list"},jo={class:"profile-info-item"},Ho={class:"profile-info-value"},Wo={key:0,class:"profile-info-item"},qo={class:"profile-info-value"},Go={class:"profile-info-item"},Xo={class:"profile-info-value"},Yo={key:2,class:"profile-loading"},Zo=j({__name:"UserProfileModal",props:{username:{}},emits:["close","message"],setup(e,{emit:n}){const a=e,l=n,i=te(),{showToast:r}=re(),s=y(null),m=y(!0),M=y(!1),w=O(()=>s.value?i.isUserOnline(s.value.id):!1);ie(async()=>{try{s.value=await Ke(a.username)}catch{s.value=null}finally{m.value=!1}});function k(){M.value=!M.value,r(M.value?"User muted":"User unmuted")}return(f,u)=>(c(),b("div",{class:"modal-backdrop profile-backdrop",onClick:u[2]||(u[2]=X($=>l("close"),["self"]))},[t("div",Ao,[t("button",{class:"icon-btn profile-close-btn","aria-label":"Close",onClick:u[0]||(u[0]=$=>l("close"))},[A(I(we),{size:20,"stroke-width":2})]),t("div",Oo,[m.value?(c(),b("div",Ro,[...u[3]||(u[3]=[t("p",null,"Loading...",-1)])])):s.value?(c(),b(Y,{key:1},[t("div",Bo,[A(ce,{name:s.value.display_name||s.value.username,url:s.value.avatar_url,online:w.value,size:"xxl"},null,8,["name","url","online"])]),t("div",zo,[oe(E(s.value.display_name||s.value.username)+" ",1),s.value.is_admin?(c(),V(at,{key:0})):L("",!0)]),t("div",{class:Z(["profile-status",{"profile-status--online":w.value}])},E(w.value?"online":"offline"),3),A(Eo,{muted:M.value,"show-more":!1,onMessage:u[1]||(u[1]=$=>l("message",s.value.username)),onMute:k},null,8,["muted"]),u[7]||(u[7]=t("div",{class:"profile-divider"},null,-1)),t("div",Vo,[t("div",jo,[u[4]||(u[4]=t("div",{class:"profile-info-label"},"Username",-1)),t("div",Ho,"@"+E(s.value.username),1)]),s.value.bio?(c(),b("div",Wo,[u[5]||(u[5]=t("div",{class:"profile-info-label"},"Bio",-1)),t("div",qo,E(s.value.bio),1)])):L("",!0),t("div",Go,[u[6]||(u[6]=t("div",{class:"profile-info-label"},"User ID",-1)),t("div",Xo,E(s.value.id),1)])])],64)):(c(),b("div",Yo,[...u[8]||(u[8]=[t("p",null,"User not found",-1)])]))])])]))}}),Jo={class:"modal",style:{"max-width":"420px"}},Qo={class:"modal-header"},Ko={class:"modal-body",style:{display:"flex","flex-direction":"column",gap:"12px"}},ei=j({__name:"DownloadModal",emits:["close"],setup(e,{emit:n}){const a=n,l=navigator.userAgent.toLowerCase(),i=l.includes("win"),r=l.includes("mac")&&!l.includes("iphone")&&!l.includes("ipad"),s=O(()=>i?"Windows":r?"macOS":null);function m(){i?window.location.href="/downloads/windows/MessengerSetup.exe":r&&(window.location.href="/downloads/macos/Messenger.dmg")}return(M,w)=>(c(),b("div",{class:"modal-backdrop",onClick:w[1]||(w[1]=X(k=>a("close"),["self"]))},[t("div",Jo,[t("div",Qo,[w[2]||(w[2]=t("h2",{class:"modal-title"},"Download Simple Messenger",-1)),t("button",{class:"icon-btn","aria-label":"Close",onClick:w[0]||(w[0]=k=>a("close"))},[A(I(we),{size:20})])]),t("div",Ko,[s.value?(c(),b("button",{key:0,class:"btn btn-primary btn-full",onClick:m}," Download for "+E(s.value),1)):L("",!0),w[3]||(w[3]=ht('<details><summary style="cursor:pointer;color:var(--accent);">Other platforms</summary><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"><a href="/downloads/windows/MessengerSetup.exe" class="btn btn-ghost btn-full" download>Windows installer (.exe)</a><a href="/downloads/macos/Messenger.dmg" class="btn btn-ghost btn-full" download>macOS installer (.dmg)</a></div></details><p style="font-size:0.8rem;color:var(--text-muted);margin:0;"> Files not available yet? Check back soon. </p>',2))])])]))}}),ti=j({__name:"ContextMenu",setup(e){const n=te(),{showToast:a}=re(),l=y(!1),i=y(0),r=y(0),s=y(null),m=O(()=>s.value?n.chats.find($=>$.id===s.value)??null:null);function M($){s.value=$.detail.chatId,i.value=$.detail.x,r.value=$.detail.y,l.value=!0}function w(){l.value&&(l.value=!1,s.value=null)}ie(()=>{window.addEventListener("show-context-menu",M),document.addEventListener("click",w)}),fe(()=>{window.removeEventListener("show-context-menu",M),document.removeEventListener("click",w)});async function k(){if(s.value){l.value=!1;try{await n.toggleFavorite(s.value)}catch{a("Failed to update favorite")}}}async function f(){if(s.value){l.value=!1;try{await n.toggleMute(s.value)}catch{a("Failed to update mute")}}}async function u(){if(s.value&&(l.value=!1,!!confirm("Leave this chat?")))try{await n.leave(s.value),a("Left chat")}catch{a("Failed to leave chat")}}return($,_)=>l.value?(c(),b("div",{key:0,class:"context-menu",style:Se({left:i.value+"px",top:r.value+"px"})},[t("button",{class:"ctx-item",onClick:k},E(m.value?.is_favorite?"â˜… Unstar":"â˜† Star"),1),t("button",{class:"ctx-item",onClick:f},E(m.value?.is_muted?"Unmute":"Mute"),1),m.value&&m.value.type!=="direct"?(c(),b("button",{key:0,class:"ctx-item ctx-leave",onClick:u}," Leave chat ")):L("",!0)],4)):L("",!0)}}),ai=j({__name:"MessengerView",setup(e){const n=yt(),a=Qe(),l=pe(),i=te(),r=Te(),s=De(),{showToast:m}=re(),{connect:M,disconnect:w,sendTyping:k}=jt();_e("sendTyping",k);const f=y(!1),u=y(!1),$=y("select"),_=y(!1),o=y("profile"),d=y(!1),p=y(null),S=y([]),x=y(null);_e("stickers",S),_e("pendingScrollMessageId",x);let g=null;ie(async()=>{await r.loadSettings();try{S.value=await Gt()}catch{}await i.loadChats(),M(),g=setInterval(()=>i.loadChats(),5e3),v()}),fe(()=>{w(),g&&(clearInterval(g),g=null)}),me(()=>n.path,()=>{v()}),me(()=>i.activeChatId,()=>{s.selectionMode&&s.exitSelectionMode()});async function v(){const z=n.path;if(z.startsWith("/@")){const N=n.params.username;N&&(p.value=N)}else if(z.startsWith("/u/")){const N=n.params.id;if(N)try{const q=await Ht(parseInt(N));p.value=q.username}catch{m("User not found")}}else if(z.startsWith("/dm/")){const N=n.params.id;N&&await h(N)}else if(n.name==="messageDeepLink"){const N=parseInt(n.params.chatId),q=parseInt(n.params.messageId);N&&q&&await B(N,q)}else if(z.startsWith("/c/")){const N=n.params.name;N&&await D(N)}}async function h(z){try{let N;if(z.startsWith("@")){const le=z.substring(1);if(l.user?.username===le){p.value=le;return}N=(await Ke(le)).id}else if(N=parseInt(z),l.user?.id===N){m("Cannot open DM with yourself");return}const q=await Ce({type:"direct",member_ids:[N]});await i.loadChats(),i.setActiveChat(q.id)}catch{m("Failed to open conversation")}}async function D(z){try{const N=await $t(z);i.chats.find(le=>le.id===N.id)?i.setActiveChat(N.id):m("You are not a member of this channel")}catch{m("Channel not found")}}async function B(z,N){if(!i.chats.find(le=>le.id===z)){m("Chat not found");return}i.setActiveChat(z),await de(),x.value=N}function J(z){i.setActiveChat(z),a.replace("/app")}function se(){i.setActiveChat(null)}function ae(){f.value=!1,o.value="profile",_.value=!0}function ue(){f.value=!1,o.value="settings",_.value=!0}function H(){f.value=!1,$.value="group",u.value=!0}function T(){f.value=!1,$.value="channel",u.value=!0}function F(){f.value=!1}function ge(z){p.value=z}async function Ie(z){p.value=null,await h("@"+z)}async function ve(z){u.value=!1,await i.loadChats(),i.setActiveChat(z)}function ke(z){if(z.key==="Escape"){if(s.selectionMode){s.exitSelectionMode();return}if(p.value){p.value=null;return}if(u.value){u.value=!1;return}if(_.value){_.value=!1;return}if(d.value){d.value=!1;return}if(f.value){f.value=!1;return}if(i.activeChatId!==null){se();return}}}return ie(()=>document.addEventListener("keydown",ke)),fe(()=>document.removeEventListener("keydown",ke)),(z,N)=>(c(),b("div",{class:Z(["layout",{"chat-open":!!I(i).activeChatId}])},[A(Ua,{open:f.value,onClose:N[0]||(N[0]=q=>f.value=!1),onOpenProfile:ae,onOpenSettings:ue,onOpenNewGroup:H,onOpenNewChannel:T,onOpenFavorites:F,onOpenDownload:N[1]||(N[1]=q=>d.value=!0)},null,8,["open"]),t("div",{class:Z(["drawer-overlay",{visible:f.value}]),onClick:N[2]||(N[2]=q=>f.value=!1)},null,2),A(En,{onOpenDrawer:N[3]||(N[3]=q=>f.value=!0),onOpenNewChat:N[4]||(N[4]=q=>{$.value="select",u.value=!0}),onSelectChat:J}),A(ma,{onBack:se,onOpenUserProfile:ge}),u.value?(c(),V(ro,{key:0,"initial-step":$.value,onClose:N[5]||(N[5]=q=>u.value=!1),onChatCreated:ve},null,8,["initial-step"])):L("",!0),_.value?(c(),V(Io,{key:1,"initial-tab":o.value,onClose:N[6]||(N[6]=q=>_.value=!1)},null,8,["initial-tab"])):L("",!0),p.value?(c(),V(Zo,{key:2,username:p.value,onClose:N[7]||(N[7]=q=>p.value=null),onMessage:Ie},null,8,["username"])):L("",!0),d.value?(c(),V(ei,{key:3,onClose:N[8]||(N[8]=q=>d.value=!1)})):L("",!0),A(ti)],2))}});export{ai as default};
