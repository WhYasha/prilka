import{k as L,l as le,r as b,m as F,n as se,d as I,o as g,c as k,w as z,p as A,g as B,a as e,b as M,f as ee,t as D,e as P,v as O,F as V,q as Z,s as E,x as T,y as de,z as ie,A as W,B as _e,C as j,u as te,D as ve,E as oe,G as X,j as me,H as re,I as we,J as Ce,K as $e,L as Se}from"./index-CfLuhcJ0.js";import{_ as H,l as xe,c as Me,r as De}from"./invites-U9k29N3J.js";async function Te(){const{data:t}=await L.get("/chats");return t}async function Ue(t){const{data:s}=await L.get(`/chats/${t}`);return s}async function Le(t){const{data:s}=await L.get(`/chats/by-name/${encodeURIComponent(t)}`);return s}async function ae(t){const{data:s}=await L.post("/chats",t);return s}async function Ne(t){await L.post(`/chats/${t}/favorite`)}async function Pe(t){await L.delete(`/chats/${t}/favorite`)}async function Fe(t,s){await L.post(`/chats/${t}/mute`,{})}async function Ie(t){await L.delete(`/chats/${t}/mute`)}async function Re(t){await L.delete(`/chats/${t}/leave`)}const G=le("chats",()=>{const t=b([]),s=b(null),o=F(()=>t.value.find(r=>r.id===s.value)??null),c=F(()=>[...t.value].sort((r,n)=>{if(r.is_favorite&&!n.is_favorite)return-1;if(!r.is_favorite&&n.is_favorite)return 1;const d=r.last_at||r.updated_at||"";return(n.last_at||n.updated_at||"").localeCompare(d)}));async function a(){try{t.value=await Te()}catch(r){console.error("Failed to load chats",r)}}function h(r){s.value=r}async function i(r){const n=t.value.find(d=>d.id===r);if(n)try{n.is_favorite?await Pe(r):await Ne(r),n.is_favorite=!n.is_favorite}catch(d){throw console.error("Failed to toggle favorite",d),d}}async function u(r){const n=t.value.find(d=>d.id===r);if(n)try{n.is_muted?await Ie(r):await Fe(r),n.is_muted=!n.is_muted}catch(d){throw console.error("Failed to toggle mute",d),d}}async function m(r){await Re(r),t.value=t.value.filter(n=>n.id!==r),s.value===r&&(s.value=null)}function l(r,n,d){const p=t.value.find(C=>C.id===r);p&&(p.last_message=n,p.last_at=d)}return{chats:t,activeChatId:s,activeChat:o,sortedChats:c,loadChats:a,setActiveChat:h,toggleFavorite:i,toggleMute:u,leave:m,updateChatLastMessage:l}});async function Be(){const{data:t}=await L.get("/settings");return t}async function Oe(t){await L.put("/settings",t)}const fe=le("settings",()=>{const t=b(localStorage.getItem("theme")||"light"),s=b(!0),o=b("en");function c(i){t.value=i,document.body.setAttribute("data-theme",i),localStorage.setItem("theme",i)}async function a(){try{const i=await Be();c(i.theme||"light"),s.value=i.notifications_enabled,o.value=i.language||"en"}catch(i){console.error("Failed to load settings",i)}}async function h(i){await Oe(i),i.theme&&c(i.theme),i.notifications_enabled!==void 0&&(s.value=i.notifications_enabled),i.language&&(o.value=i.language)}return document.body.setAttribute("data-theme",t.value),{theme:t,notificationsEnabled:s,language:o,applyTheme:c,loadSettings:a,saveSettings:h}});async function ne(t,s){const{data:o}=await L.get(`/chats/${t}/messages`,{params:s});return o}async function Ee(t,s){const{data:o}=await L.post(`/chats/${t}/messages`,s);return o}const pe=le("messages",()=>{const t=b({}),s=b({}),o=b(null);async function c(l){o.value=l;try{const r=await ne(l,{limit:50});t.value[l]=r,r.length>0&&(s.value[l]=Math.max(...r.map(n=>n.id)))}catch(r){throw console.error("Failed to load messages",r),r}finally{o.value=null}}async function a(l){const r=s.value[l]||0;if(r===0)return[];try{const n=await ne(l,{after_id:r,limit:50});if(n.length>0){t.value[l]||(t.value[l]=[]);const d=new Set(t.value[l].map(C=>C.id)),p=n.filter(C=>!d.has(C.id));t.value[l].push(...p),s.value[l]=Math.max(...n.map(C=>C.id))}return n}catch(n){return console.error("Failed to load newer messages",n),[]}}async function h(l){const r=t.value[l];if(!r||r.length===0)return[];const n=r[0];if(!n)return[];try{const d=await ne(l,{before:n.created_at,limit:50});if(d.length>0){const p=new Set(r.map(S=>S.id)),C=d.filter(S=>!p.has(S.id));t.value[l]=[...C,...r]}return d}catch(d){return console.error("Failed to load older messages",d),[]}}async function i(l,r,n="text",d){const p=await Ee(l,{content:r,type:n,...d});return t.value[l]||(t.value[l]=[]),t.value[l].push(p),s.value[l]=Math.max(s.value[l]||0,p.id),p}function u(l,r){t.value[l]||(t.value[l]=[]),t.value[l].find(d=>d.id===r.id)||(t.value[l].push(r),s.value[l]=Math.max(s.value[l]||0,r.id))}function m(l){return t.value[l]||[]}return{messagesByChat:t,lastMsgId:s,loadingChat:o,loadMessages:c,loadNewer:a,loadOlder:h,sendMessage:i,pushMessage:u,getMessages:m}});function Ve(){const t=b(!1);let s=null,o=null,c=null,a=1e3,h=!1;function i(){const C=localStorage.getItem("access_token");return C?`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?token=${encodeURIComponent(C)}`:null}function u(){if(s&&(s.readyState===WebSocket.OPEN||s.readyState===WebSocket.CONNECTING))return;const C=i();C&&(h=!1,s=new WebSocket(C),s.onopen=()=>{t.value=!0,a=1e3;const S=localStorage.getItem("access_token");S&&s.send(JSON.stringify({type:"auth",token:S}));const N=G();for(const U of N.chats)s.send(JSON.stringify({type:"subscribe",chat_id:U.id}));l()},s.onmessage=S=>{try{const N=JSON.parse(S.data);m(N)}catch{}},s.onclose=()=>{t.value=!1,r(),h||n()},s.onerror=()=>{})}function m(C){const S=pe(),N=G();if(C.type==="message"){const U=C;S.pushMessage(U.chat_id,U),N.updateChatLastMessage(U.chat_id,U.content||(U.message_type==="sticker"?"Sticker":"Attachment"),U.created_at)}}function l(){r(),c=setInterval(()=>{s&&s.readyState===WebSocket.OPEN&&s.send(JSON.stringify({type:"ping"}))},25e3)}function r(){c&&(clearInterval(c),c=null)}function n(){o||(o=setTimeout(()=>{o=null,u(),a=Math.min(a*2,3e4)},a))}function d(C){s&&s.readyState===WebSocket.OPEN&&s.send(JSON.stringify({type:"subscribe",chat_id:C}))}function p(){h=!0,r(),o&&(clearTimeout(o),o=null),s&&(s.close(),s=null),t.value=!1}return se(()=>{p()}),{connected:t,connect:u,disconnect:p,subscribeToChat:d}}async function Ae(t){const{data:s}=await L.get(`/users/${t}`);return s}async function he(t){const{data:s}=await L.get(`/users/by-username/${encodeURIComponent(t)}`);return s}async function ce(t){const{data:s}=await L.get("/users/search",{params:{q:t}});return s}async function We(t,s){const{data:o}=await L.put(`/users/${t}`,s);return o}async function ze(t){const{data:s}=await L.put("/users/me/avatar",{file_id:t});return s}async function He(){const{data:t}=await L.get("/stickers");return t}const Ge={class:"chat-item-info"},Je={class:"chat-item-top"},Ze={class:"chat-item-name"},je={key:0,class:"ci-channel"},qe={key:1,class:"ci-group"},Ke={key:2,class:"mute-icon",title:"Muted"},Ye={class:"chat-item-time"},Qe={class:"chat-item-preview"},Xe=["title"],ue=I({__name:"ChatListItem",props:{chat:{},active:{type:Boolean}},emits:["select","toggleFavorite","contextmenu"],setup(t,{emit:s}){const o=t,c=s,a=F(()=>{const i=o.chat;return i.type==="channel"||i.type==="group"?i.title||i.name||"Untitled":i.other_display_name||i.other_username||i.title||i.name||"Chat"});function h(i){if(!i)return"";const u=new Date(i.endsWith("Z")?i:i+"Z"),m=new Date;return u.toDateString()===m.toDateString()?u.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):u.toLocaleDateString([],{month:"short",day:"numeric"})}return(i,u)=>(g(),k("div",{class:A(["chat-item",{active:t.active}]),onClick:u[1]||(u[1]=m=>c("select")),onContextmenu:u[2]||(u[2]=z(m=>c("contextmenu",m),["prevent"]))},[B(H,{name:a.value,url:t.chat.other_avatar_url,size:"sm"},null,8,["name","url"]),e("div",Ge,[e("div",Je,[e("span",Ze,[t.chat.type==="channel"?(g(),k("span",je)):t.chat.type==="group"?(g(),k("span",qe)):M("",!0),ee(" "+D(a.value)+" ",1),t.chat.is_muted?(g(),k("span",Ke,"ðŸ””")):M("",!0)]),e("span",Ye,D(h(t.chat.last_at||t.chat.updated_at)),1)]),e("div",Qe,D(t.chat.last_message||""),1)]),e("button",{class:A(["star-btn",{"star-active":t.chat.is_favorite}]),title:t.chat.is_favorite?"Unstar":"Star",onClick:u[0]||(u[0]=z(m=>c("toggleFavorite"),["stop"]))},"â˜…",10,Xe)],34))}}),et={class:"sidebar"},tt={class:"sidebar-header"},at={class:"search-wrap"},st={class:"chat-list"},nt={key:0,class:"empty-state-small"},ot={key:0,class:"chat-section-label"},lt={key:1,class:"chat-section-label"},it=I({__name:"Sidebar",emits:["openDrawer","openNewChat","selectChat"],setup(t,{emit:s}){const o=s,c=G(),a=b(""),h=F(()=>{const n=a.value.toLowerCase();return n?c.sortedChats.filter(d=>{const p=m(d).toLowerCase(),C=(d.other_username||"").toLowerCase();return p.includes(n)||C.includes(n)}):c.sortedChats}),i=F(()=>h.value.filter(n=>n.is_favorite)),u=F(()=>h.value.filter(n=>!n.is_favorite));function m(n){return n.type==="channel"||n.type==="group"?n.title||n.name||"Untitled":n.other_display_name||n.other_username||n.title||n.name||"Chat"}const l=b(null);de("contextChatId",l);function r(n,d){n.preventDefault(),l.value=d,window.dispatchEvent(new CustomEvent("show-context-menu",{detail:{x:n.clientX,y:n.clientY,chatId:d}}))}return(n,d)=>(g(),k("aside",et,[e("header",tt,[e("button",{class:"icon-btn","aria-label":"Menu",onClick:d[0]||(d[0]=p=>o("openDrawer"))},"â˜°"),e("div",at,[P(e("input",{"onUpdate:modelValue":d[1]||(d[1]=p=>a.value=p),class:"search-input",type:"search",placeholder:"Search chats..."},null,512),[[O,a.value]])]),e("button",{class:"icon-btn","aria-label":"New chat",title:"New chat",onClick:d[2]||(d[2]=p=>o("openNewChat"))},"âœŽ")]),e("div",st,[h.value.length===0?(g(),k("div",nt,[...d[3]||(d[3]=[ee(" No conversations yet.",-1),e("br",null,null,-1),ee("Click âœŽ to start one. ",-1)])])):(g(),k(V,{key:1},[i.value.length>0?(g(),k("div",ot,"Starred")):M("",!0),(g(!0),k(V,null,Z(i.value,p=>(g(),E(ue,{key:p.id,chat:p,active:p.id===T(c).activeChatId,onSelect:C=>o("selectChat",p.id),onToggleFavorite:C=>T(c).toggleFavorite(p.id),onContextmenu:C=>r(C,p.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128)),i.value.length>0&&u.value.length>0?(g(),k("div",lt," All chats ")):M("",!0),(g(!0),k(V,null,Z(u.value,p=>(g(),E(ue,{key:p.id,chat:p,active:p.id===T(c).activeChatId,onSelect:C=>o("selectChat",p.id),onToggleFavorite:C=>T(c).toggleFavorite(p.id),onContextmenu:C=>r(C,p.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128))],64))])]))}});function rt(){const t=b(!1),s=b(0);let o=null,c=[],a=null;async function h(){if(!navigator.mediaDevices?.getUserMedia)throw new Error("MediaDevices not supported");const r=await navigator.mediaDevices.getUserMedia({audio:!0});c=[],s.value=0,o=new MediaRecorder(r),o.ondataavailable=n=>{n.data.size&&c.push(n.data)},o.start(),t.value=!0,a=setInterval(()=>{s.value++},1e3)}function i(){return new Promise((r,n)=>{if(!o||o.state!=="recording"){n(new Error("Not recording"));return}o.onstop=()=>{o?.stream&&o.stream.getTracks().forEach(N=>N.stop()),m(),t.value=!1;const d=o?.mimeType||"audio/webm",p=d.includes("ogg")?"ogg":"webm",C=new Blob(c,{type:d}),S=new File([C],`voice.${p}`,{type:d});r(S)},o.stop()})}function u(){o&&o.state==="recording"&&(o.onstop=()=>{o?.stream&&o.stream.getTracks().forEach(r=>r.stop())},o.stop()),m(),t.value=!1,s.value=0}function m(){a&&(clearInterval(a),a=null)}function l(r){const n=Math.floor(r/60),d=r%60;return`${n}:${String(d).padStart(2,"0")}`}return{isRecording:t,seconds:s,startRecording:h,stopRecording:i,cancelRecording:u,formatTime:l}}async function ge(t){const s=new FormData;s.append("file",t);const{data:o}=await L.post("/files",s);return o}const ct={class:"chat-header"},ut={class:"chat-header-name"},dt={class:"chat-header-sub"},vt=I({__name:"ChatHeader",emits:["back","openUserProfile"],setup(t,{emit:s}){const o=s,c=G(),a=F(()=>c.activeChat),h=F(()=>{const m=a.value;return m?m.type==="channel"||m.type==="group"?m.title||m.name||"Untitled":m.other_display_name||m.other_username||m.title||m.name||"Chat":"---"}),i=F(()=>{const m=a.value;return m?m.type==="channel"?"Channel":m.type==="group"?"Group":m.other_username?"@"+m.other_username:"":""});function u(){a.value?.type==="direct"&&a.value.other_username&&o("openUserProfile",a.value.other_username)}return(m,l)=>(g(),k("header",ct,[e("button",{class:"icon-btn back-btn","aria-label":"Back",onClick:l[0]||(l[0]=r=>o("back"))},"â†"),B(H,{class:"chat-header-avatar",name:h.value,url:a.value?.other_avatar_url,onClick:u},null,8,["name","url"]),e("div",{class:"chat-header-info",onClick:u},[e("div",ut,D(h.value),1),e("div",dt,D(i.value),1)])]))}}),ye=(t,s)=>{const o=t.__vccOpts||t;for(const[c,a]of s)o[c]=a;return o},mt={},ft={class:"admin-badge",title:"Admin"};function pt(t,s){return g(),k("span",ft,"âœ“")}const be=ye(mt,[["render",pt]]),ht={key:0,class:"msg-sender-name"},gt={key:1,class:"msg-bubble sticker-bubble"},yt=["src","alt"],bt={key:2,class:"msg-bubble"},kt={class:"voice-player"},_t=["src"],wt={key:0,class:"voice-dur"},Ct=["innerHTML"],$t={class:"msg-time"},St=I({__name:"MessageBubble",props:{message:{},isMine:{type:Boolean}},emits:["mentionClick"],setup(t,{emit:s}){const o=t,c=s,a=ie("stickers",b([])),h=F(()=>{if(o.message.sticker_url)return o.message.sticker_url;if(o.message.sticker_id){const n=a.value.find(d=>d.id===o.message.sticker_id);if(n)return n.url}return""}),i=F(()=>o.message.attachment_url||""),u=F(()=>m(o.message.content||"").replace(/@(\w{1,30})/g,`<span class="mention" data-u="$1" onclick="window.dispatchEvent(new CustomEvent('mention-click', {detail:'$1'}))">@$1</span>`));function m(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function l(n){if(!n)return"";const d=new Date(n.endsWith("Z")?n:n+"Z"),p=new Date;return d.toDateString()===p.toDateString()?d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):d.toLocaleDateString([],{month:"short",day:"numeric"})}function r(n){const d=Math.floor(n/60),p=n%60;return`${d}:${String(p).padStart(2,"0")}`}return typeof window<"u"&&window.addEventListener("mention-click",(n=>{c("mentionClick",n.detail)})),(n,d)=>(g(),k("div",{class:A(["msg-row",t.isMine?"mine":"theirs"])},[!t.isMine&&t.message.message_type!=="sticker"?(g(),k("div",ht,[ee(D(t.message.sender_display_name||t.message.sender_username)+" ",1),t.message.sender_is_admin?(g(),E(be,{key:0})):M("",!0)])):M("",!0),t.message.message_type==="sticker"?(g(),k("div",gt,[e("img",{class:"sticker-img",src:h.value,alt:t.message.sticker_label||"sticker"},null,8,yt)])):t.message.message_type==="voice"?(g(),k("div",bt,[e("div",kt,[e("audio",{controls:"",src:i.value},null,8,_t),t.message.duration_seconds?(g(),k("span",wt,D(r(t.message.duration_seconds)),1)):M("",!0)])])):(g(),k("div",{key:3,class:"msg-bubble",innerHTML:u.value},null,8,Ct)),e("div",$t,D(l(t.message.created_at)),1)],2))}}),xt={class:"composer"},Mt=["onKeydown"],Dt=I({__name:"Composer",props:{stickerPickerOpen:{type:Boolean}},emits:["send","toggleStickers","startRecording"],setup(t,{expose:s,emit:o}){const c=o,a=b(""),h=b(null);function i(){const m=a.value.trim();m&&(c("send",m),a.value="",u())}function u(){const m=h.value;m&&(m.style.height="auto",m.style.height=Math.min(m.scrollHeight,120)+"px")}return W(()=>{h.value?.focus()}),s({focus:()=>h.value?.focus()}),(m,l)=>(g(),k("div",xt,[e("button",{class:"icon-btn composer-btn","aria-label":"Stickers",title:"Stickers",onClick:l[0]||(l[0]=r=>c("toggleStickers"))},"ðŸŒ"),P(e("textarea",{ref_key:"inputRef",ref:h,"onUpdate:modelValue":l[1]||(l[1]=r=>a.value=r),class:"composer-input",placeholder:"Message...",rows:"1",maxlength:"4000",onKeydown:_e(z(i,["exact","prevent"]),["enter"]),onInput:u},null,40,Mt),[[O,a.value]]),e("button",{class:"icon-btn composer-btn record-btn","aria-label":"Voice message",title:"Record voice",onClick:l[2]||(l[2]=r=>c("startRecording"))},"ðŸŽ¤"),e("button",{class:"icon-btn composer-btn send-btn","aria-label":"Send",title:"Send",onClick:i},"âž¤")]))}}),Tt={class:"sticker-grid"},Ut=["title","onClick"],Lt=["src","alt"],Nt={key:0,class:"empty-state-small",style:{color:"var(--text-muted)"}},Pt=I({__name:"StickerPicker",emits:["select"],setup(t,{emit:s}){const o=s,c=ie("stickers",b([])),a=F(()=>c.value);return(h,i)=>(g(),k("div",Tt,[(g(!0),k(V,null,Z(a.value,u=>(g(),k("button",{key:u.id,class:"sticker-btn",title:u.label,onClick:m=>o("select",u.id)},[e("img",{src:u.url,alt:u.label},null,8,Lt)],8,Ut))),128)),a.value.length===0?(g(),k("div",Nt," No stickers available ")):M("",!0)]))}}),Ft={},It={class:"msgs-loading"};function Rt(t,s){return g(),k("div",It,"Loading...")}const Bt=ye(Ft,[["render",Rt]]),Ot={class:"invite-manage",style:{padding:"0 1rem .5rem"}},Et={class:"invite-link-wrap"},Vt=["value"],At=I({__name:"InviteSection",props:{chatId:{}},setup(t){const s=t,{showToast:o}=j(),c=b("Loading..."),a=b("");async function h(){try{const m=await xe(s.chatId);if(m.length>0){const l=m[0];a.value=l.token,c.value=`${window.location.origin}/join/${l.token}`}else{const l=await Me(s.chatId);a.value=l.token,c.value=`${window.location.origin}/join/${l.token}`}}catch{c.value="Failed to generate invite"}}function i(){c.value&&navigator.clipboard&&navigator.clipboard.writeText(c.value).then(()=>o("Link copied!"))}async function u(){if(a.value)try{await De(a.value),o("Invite revoked"),await h()}catch{o("Failed to revoke invite")}}return W(h),(m,l)=>(g(),k("div",Ot,[l[0]||(l[0]=e("div",{class:"invite-manage-title"},"Invite Link",-1)),e("div",Et,[e("input",{class:"form-input invite-link-input",value:c.value,type:"text",readonly:""},null,8,Vt),e("button",{class:"btn btn-sm btn-outline",title:"Copy link",onClick:i}," ðŸ“‹ ")]),e("button",{class:"btn btn-sm btn-ghost btn-danger",onClick:u}," Revoke link ")]))}}),Wt={class:"chat-panel"},zt={key:0,class:"empty-chat"},Ht={key:1,class:"chat-view"},Gt={key:0,class:"channel-readonly-bar"},Jt={key:0,class:"date-sep"},Zt={key:1,class:"sticker-picker"},jt={key:3,class:"recording-bar"},qt={class:"rec-time"},Kt=I({__name:"ChatPanel",emits:["back","openUserProfile"],setup(t,{emit:s}){const o=s,c=te(),a=G(),h=pe(),{showToast:i}=j(),u=rt(),m=ie("stickers",b([])),l=b(null),r=b(!1),n=b(!1),d=b("member"),p=b(!1);let C=null;const S=F(()=>a.activeChat?.type==="channel"&&d.value==="member"),N=F(()=>a.activeChatId?h.getMessages(a.activeChatId):[]),U=F(()=>{const _=[];let v="";for(const w of N.value){const f=R(w.created_at);f!==v&&(_.push({type:"date",label:f}),v=f),_.push({type:"msg",msg:w})}return _});function R(_){if(!_)return"";const v=new Date(_.endsWith("Z")?_:_+"Z"),w=new Date;if(v.toDateString()===w.toDateString())return"Today";const f=new Date(w);return f.setDate(w.getDate()-1),v.toDateString()===f.toDateString()?"Yesterday":v.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})}ve(()=>a.activeChatId,async _=>{if(r.value=!1,d.value="member",p.value=!1,C&&(clearInterval(C),C=null),!_)return;await h.loadMessages(_),await X(),y();const v=a.activeChat;if(v&&(v.type==="channel"||v.type==="group"))try{const w=await Ue(_);d.value=w.my_role||"member",p.value=d.value==="owner"||d.value==="admin"}catch{}C=setInterval(()=>{a.activeChatId===_&&h.loadNewer(_).then(w=>{w.length>0&&x()})},2500)});function y(){l.value&&(l.value.scrollTop=l.value.scrollHeight)}function x(){if(!l.value)return;const _=l.value;_.scrollHeight-_.scrollTop-_.clientHeight<80&&X(()=>{_.scrollTop=_.scrollHeight})}async function q(_){if(!(!a.activeChatId||!_.trim()))try{const v=await h.sendMessage(a.activeChatId,_.trim(),"text");c.user&&(v.sender_id=c.user.id,v.sender_username=c.user.username,v.sender_display_name=c.user.display_name),await X(),y(),a.loadChats()}catch{i("Failed to send message")}}async function K(_){if(a.activeChatId){r.value=!1;try{const v=await h.sendMessage(a.activeChatId,"","sticker",{sticker_id:_}),w=m.value.find(f=>f.id===_);w&&(v.sticker_url=w.url,v.sticker_label=w.label),await X(),y(),a.loadChats()}catch{i("Failed to send sticker")}}}async function Y(){try{await u.startRecording(),n.value=!0;const _=await u.stopRecording();n.value=!1,await J(_)}catch{n.value=!1,i("Microphone access denied")}}function Q(){u.cancelRecording(),n.value=!1}async function J(_){if(a.activeChatId)try{const v=await ge(_);await h.sendMessage(a.activeChatId,"","voice",{file_id:v.id,duration_seconds:u.seconds.value}),await h.loadMessages(a.activeChatId),await X(),y(),a.loadChats()}catch{i("Failed to upload voice message")}}return(_,v)=>(g(),k("main",Wt,[T(a).activeChatId?(g(),k("div",Ht,[B(vt,{onBack:v[0]||(v[0]=w=>o("back")),onOpenUserProfile:v[1]||(v[1]=w=>o("openUserProfile",w))}),S.value?(g(),k("div",Gt,[...v[5]||(v[5]=[e("span",{class:"readonly-icon"},"ðŸ”’",-1),e("span",{class:"readonly-text"},"Only admins can send messages in this channel.",-1)])])):M("",!0),e("div",{ref_key:"msgListRef",ref:l,class:"msg-list"},[T(h).loadingChat===T(a).activeChatId?(g(),E(Bt,{key:0})):(g(!0),k(V,{key:1},Z(U.value,w=>(g(),k(V,{key:w.type==="date"?"date-"+w.label:"msg-"+w.msg.id},[w.type==="date"?(g(),k("div",Jt,[e("span",null,D(w.label),1)])):(g(),E(St,{key:1,message:w.msg,"is-mine":w.msg.sender_id===T(c).user?.id,onMentionClick:v[2]||(v[2]=f=>o("openUserProfile",f))},null,8,["message","is-mine"]))],64))),128))],512),r.value?(g(),k("div",Zt,[B(Pt,{onSelect:K})])):M("",!0),S.value?M("",!0):P((g(),E(Dt,{key:2,"sticker-picker-open":r.value,onSend:q,onToggleStickers:v[3]||(v[3]=w=>r.value=!r.value),onStartRecording:Y},null,8,["sticker-picker-open"])),[[oe,!n.value]]),n.value?(g(),k("div",jt,[v[6]||(v[6]=e("span",{class:"rec-dot"},null,-1)),e("span",qt,D(T(u).formatTime(T(u).seconds.value)),1),v[7]||(v[7]=e("span",{class:"rec-label"},"Recording... tap mic to stop",-1)),e("button",{class:"icon-btn rec-cancel",title:"Cancel",onClick:Q},"âœ•")])):M("",!0),p.value?(g(),E(At,{key:4,"chat-id":T(a).activeChatId},null,8,["chat-id"])):M("",!0)])):(g(),k("div",zt,[...v[4]||(v[4]=[e("div",{class:"empty-chat-icon"},"ðŸ’¬",-1),e("div",{class:"empty-chat-text"},"Select a chat to start messaging",-1)])]))]))}}),Yt={class:"drawer-header"},Qt={class:"drawer-avatar-wrap"},Xt={class:"drawer-user-info"},ea={class:"drawer-display-name"},ta={class:"drawer-username"},aa={class:"drawer-nav"},sa=I({__name:"Drawer",props:{open:{type:Boolean}},emits:["close","openProfile","openDownload"],setup(t,{emit:s}){const o=s,c=me(),a=te();function h(){a.logout(),c.push("/login")}return(i,u)=>(g(),k("div",{class:A(["drawer",{open:t.open}])},[e("div",Yt,[e("button",{class:"icon-btn","aria-label":"Close menu",onClick:u[0]||(u[0]=m=>o("close"))},"âœ•"),u[3]||(u[3]=e("span",{class:"drawer-title"},"Menu",-1))]),e("div",Qt,[B(H,{name:T(a).user?.display_name||T(a).user?.username||"?",url:T(a).user?.avatar_url,size:"lg"},null,8,["name","url"]),e("div",Xt,[e("div",ea,D(T(a).user?.display_name||T(a).user?.username||"---"),1),e("div",ta,"@"+D(T(a).user?.username||"---"),1)])]),e("nav",aa,[e("button",{class:"drawer-nav-item",onClick:u[1]||(u[1]=m=>o("openProfile"))}," Profile & Settings "),e("button",{class:"drawer-nav-item",onClick:u[2]||(u[2]=m=>o("openDownload"))}," Download App "),e("button",{class:"drawer-nav-item",onClick:h}," Log out ")]),u[4]||(u[4]=e("div",{class:"drawer-footer"},"Simple Messenger v2",-1))],2))}}),na={class:"modal"},oa={class:"modal-header"},la={class:"modal-body"},ia={key:0,class:"chat-type-cards"},ra={key:1,class:"new-chat-form"},ca={class:"user-pick-list"},ua={key:0,class:"empty-state-small"},da={key:1,class:"empty-state-small"},va=["onClick"],ma={class:"user-pick-name"},fa={class:"user-pick-handle"},pa={key:2,class:"new-chat-form"},ha={class:"form-group"},ga={class:"form-group"},ya={class:"form-group"},ba={class:"user-pick-list"},ka=["onClick"],_a={class:"user-pick-name"},wa={class:"user-pick-handle"},Ca={class:"modal-actions"},$a=["disabled"],Sa={key:3,class:"new-chat-form"},xa={class:"form-group"},Ma={class:"form-group"},Da={class:"form-group"},Ta={class:"modal-actions"},Ua=["disabled"],La=I({__name:"NewChatModal",emits:["close","chatCreated"],setup(t,{emit:s}){const o=s,c=te(),{showToast:a}=j(),h=b("select"),i=b(!1),u=b(""),m=b([]),l=b(!1);let r=null;const n=b(""),d=b(""),p=b(""),C=b([]),S=b(new Set);let N=null;const U=b(""),R=b(""),y=b("");W(()=>{x("")});async function x(w){l.value=!0;try{const f=await ce(w);m.value=f.filter($=>$.id!==c.user?.id)}catch{m.value=[]}finally{l.value=!1}}function q(){r&&clearTimeout(r),r=setTimeout(()=>x(u.value),300)}async function K(w){try{C.value=await ce(w)}catch{C.value=[]}}function Y(){N&&clearTimeout(N),N=setTimeout(()=>K(p.value),300)}function Q(w){S.value.has(w)?S.value.delete(w):S.value.add(w)}async function J(w){i.value=!0;try{const f=await ae({type:"direct",member_ids:[w]});o("chatCreated",f.id)}catch{a("Failed to start conversation")}finally{i.value=!1}}async function _(){if(!n.value.trim()){a("Group name is required");return}i.value=!0;try{const w=await ae({type:"group",title:n.value.trim(),description:d.value.trim(),member_ids:Array.from(S.value)});a("Group created!"),o("chatCreated",w.id)}catch{a("Failed to create group")}finally{i.value=!1}}async function v(){if(!U.value.trim()){a("Channel name is required");return}i.value=!0;try{const w=await ae({type:"channel",title:U.value.trim(),description:y.value.trim(),public_name:R.value.trim()||void 0,member_ids:[]});a("Channel created!"),o("chatCreated",w.id)}catch{a("Failed to create channel")}finally{i.value=!1}}return(w,f)=>(g(),k("div",{class:"modal-backdrop",onClick:f[14]||(f[14]=z($=>o("close"),["self"]))},[e("div",na,[e("div",oa,[f[15]||(f[15]=e("h2",{class:"modal-title"},"New Conversation",-1)),e("button",{class:"icon-btn",onClick:f[0]||(f[0]=$=>o("close"))},"âœ•")]),e("div",la,[h.value==="select"?(g(),k("div",ia,[e("button",{class:"chat-type-card",onClick:f[1]||(f[1]=$=>h.value="direct")},[...f[16]||(f[16]=[e("span",{class:"chat-type-icon"},"ðŸ‘¤",-1),e("div",null,[e("div",{class:"chat-type-label"},"Direct Chat"),e("div",{class:"chat-type-desc"},"Private 1-on-1 conversation")],-1)])]),e("button",{class:"chat-type-card",onClick:f[2]||(f[2]=$=>h.value="group")},[...f[17]||(f[17]=[e("span",{class:"chat-type-icon"},"ðŸ‘¥",-1),e("div",null,[e("div",{class:"chat-type-label"},"Group Chat"),e("div",{class:"chat-type-desc"},"Chat with multiple people")],-1)])]),e("button",{class:"chat-type-card",onClick:f[3]||(f[3]=$=>h.value="channel")},[...f[18]||(f[18]=[e("span",{class:"chat-type-icon"},"ðŸ“¢",-1),e("div",null,[e("div",{class:"chat-type-label"},"Channel"),e("div",{class:"chat-type-desc"},"Broadcast to subscribers")],-1)])])])):M("",!0),h.value==="direct"?(g(),k("div",ra,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:f[4]||(f[4]=$=>h.value="select")}," â† Back "),P(e("input",{"onUpdate:modelValue":f[5]||(f[5]=$=>u.value=$),class:"search-input",type:"search",placeholder:"Search users...",onInput:q},null,544),[[O,u.value]]),e("div",ca,[l.value?(g(),k("div",ua,"Loading users...")):m.value.length===0?(g(),k("div",da,"No users found.")):(g(!0),k(V,{key:2},Z(m.value,$=>(g(),k("div",{key:$.id,class:"user-pick-item",onClick:ke=>J($.id)},[B(H,{name:$.display_name||$.username,url:$.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",ma,D($.display_name||$.username),1),e("div",fa,"@"+D($.username),1)])],8,va))),128))])])):M("",!0),h.value==="group"?(g(),k("div",pa,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:f[6]||(f[6]=$=>h.value="select")}," â† Back "),e("div",ha,[f[19]||(f[19]=e("label",{class:"form-label"},"Group name",-1)),P(e("input",{"onUpdate:modelValue":f[7]||(f[7]=$=>n.value=$),class:"form-input",type:"text",maxlength:"64",placeholder:"My Group"},null,512),[[O,n.value]])]),e("div",ga,[f[20]||(f[20]=e("label",{class:"form-label"},"Description (optional)",-1)),P(e("textarea",{"onUpdate:modelValue":f[8]||(f[8]=$=>d.value=$),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this group about?"},null,512),[[O,d.value]])]),e("div",ya,[f[21]||(f[21]=e("label",{class:"form-label"},"Add members",-1)),P(e("input",{"onUpdate:modelValue":f[9]||(f[9]=$=>p.value=$),class:"search-input",type:"search",placeholder:"Search users...",onInput:Y},null,544),[[O,p.value]]),e("div",ba,[(g(!0),k(V,null,Z(C.value,$=>(g(),k("div",{key:$.id,class:A(["user-pick-item",{selected:S.value.has($.id)}]),onClick:ke=>Q($.id)},[B(H,{name:$.display_name||$.username,url:$.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",_a,D(S.value.has($.id)?"âœ“ ":"")+D($.display_name||$.username),1),e("div",wa,"@"+D($.username),1)])],10,ka))),128))])]),e("div",Ca,[e("button",{class:"btn btn-primary",disabled:i.value,onClick:_}," Create Group ",8,$a)])])):M("",!0),h.value==="channel"?(g(),k("div",Sa,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:f[10]||(f[10]=$=>h.value="select")}," â† Back "),e("div",xa,[f[22]||(f[22]=e("label",{class:"form-label"},"Channel name",-1)),P(e("input",{"onUpdate:modelValue":f[11]||(f[11]=$=>U.value=$),class:"form-input",type:"text",maxlength:"64",placeholder:"My Channel"},null,512),[[O,U.value]])]),e("div",Ma,[f[23]||(f[23]=e("label",{class:"form-label"},"Public link name (optional)",-1)),P(e("input",{"onUpdate:modelValue":f[12]||(f[12]=$=>R.value=$),class:"form-input",type:"text",maxlength:"64",placeholder:"my-channel"},null,512),[[O,R.value]]),f[24]||(f[24]=e("small",{class:"form-hint"},"Letters, numbers, hyphens, underscores. Used for /c/your-name links.",-1))]),e("div",Da,[f[25]||(f[25]=e("label",{class:"form-label"},"Description (optional)",-1)),P(e("textarea",{"onUpdate:modelValue":f[13]||(f[13]=$=>y.value=$),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this channel about?"},null,512),[[O,y.value]])]),e("div",Ta,[e("button",{class:"btn btn-primary",disabled:i.value,onClick:v}," Create Channel ",8,Ua)])])):M("",!0)])])]))}}),Na={class:"modal modal-wide"},Pa={class:"modal-header"},Fa={class:"profile-tabs"},Ia={class:"modal-body profile-body"},Ra={class:"profile-avatar-section"},Ba={class:"user-id-display"},Oa={class:"form-group"},Ea={class:"form-group"},Va={key:0,class:"form-hint form-error"},Aa={class:"form-group"},Wa={class:"modal-actions"},za={class:"form-group form-inline"},Ha={class:"form-group form-inline"},Ga={class:"toggle"},Ja={class:"form-group form-inline"},Za=I({__name:"ProfileModal",emits:["close"],setup(t,{emit:s}){const o=s,c=te(),a=fe(),{showToast:h}=j(),i=b("profile"),u=b(""),m=b(""),l=b(""),r=b(""),n=b(null),d=b("light"),p=b(!0),C=b("en");W(async()=>{c.user&&(u.value=c.user.display_name||"",m.value=c.user.username,l.value=c.user.bio||""),d.value=a.theme,p.value=a.notificationsEnabled,C.value=a.language});async function S(){const R=n.value?.files?.[0];if(R){try{const y=await ge(R),x=await ze(y.id);c.updateUser({avatar_url:x.avatar_url}),h("Avatar updated!")}catch{h("Upload failed")}n.value&&(n.value.value="")}}async function N(){if(r.value="",!c.user)return;const R={display_name:u.value.trim(),bio:l.value.trim()};m.value.trim()&&m.value.trim()!==c.user.username&&(R.username=m.value.trim());try{const y=await We(c.user.id,R);c.updateUser({display_name:y.display_name,username:y.username}),h("Profile saved!"),o("close")}catch(y){y.response?.status===409?r.value="Username already taken":h("Save failed")}}async function U(){try{await a.saveSettings({theme:d.value,notifications_enabled:p.value,language:C.value}),h("Settings saved!"),o("close")}catch{h("Settings save failed")}}return(R,y)=>(g(),k("div",{class:"modal-backdrop",onClick:y[11]||(y[11]=z(x=>o("close"),["self"]))},[e("div",Na,[e("div",Pa,[y[12]||(y[12]=e("h2",{class:"modal-title"},"Profile & Settings",-1)),e("button",{class:"icon-btn",onClick:y[0]||(y[0]=x=>o("close"))},"âœ•")]),e("div",Fa,[e("button",{class:A(["profile-tab",{active:i.value==="profile"}]),onClick:y[1]||(y[1]=x=>i.value="profile")},"Profile",2),e("button",{class:A(["profile-tab",{active:i.value==="settings"}]),onClick:y[2]||(y[2]=x=>i.value="settings")},"Settings",2)]),e("div",Ia,[P(e("div",null,[e("div",Ra,[B(H,{name:u.value||T(c).user?.username||"?",url:T(c).user?.avatar_url,size:"xl"},null,8,["name","url"]),e("button",{class:"btn btn-outline btn-sm",onClick:y[3]||(y[3]=x=>n.value?.click())}," Change photo "),e("input",{ref_key:"fileInput",ref:n,type:"file",accept:"image/*",class:"hidden",onChange:S},null,544),e("p",Ba,"ID: "+D(T(c).user?.id),1)]),e("div",Oa,[y[13]||(y[13]=e("label",{class:"form-label"},"Display name",-1)),P(e("input",{"onUpdate:modelValue":y[4]||(y[4]=x=>u.value=x),class:"form-input",type:"text",maxlength:"64",placeholder:"Your name"},null,512),[[O,u.value]])]),e("div",Ea,[y[14]||(y[14]=e("label",{class:"form-label"},"Username",-1)),P(e("input",{"onUpdate:modelValue":y[5]||(y[5]=x=>m.value=x),class:"form-input",type:"text",maxlength:"20",placeholder:"username"},null,512),[[O,m.value]]),r.value?(g(),k("small",Va,D(r.value),1)):M("",!0)]),e("div",Aa,[y[15]||(y[15]=e("label",{class:"form-label"},"Bio",-1)),P(e("textarea",{"onUpdate:modelValue":y[6]||(y[6]=x=>l.value=x),class:"form-input",maxlength:"200",rows:"3",placeholder:"About you..."},null,512),[[O,l.value]])]),e("div",Wa,[e("button",{class:"btn btn-primary",onClick:N},"Save Profile"),e("button",{class:"btn btn-ghost",onClick:y[7]||(y[7]=x=>o("close"))},"Cancel")])],512),[[oe,i.value==="profile"]]),P(e("div",null,[e("div",za,[y[17]||(y[17]=e("label",{class:"form-label"},"Theme",-1)),P(e("select",{"onUpdate:modelValue":y[8]||(y[8]=x=>d.value=x),class:"form-input form-select"},[...y[16]||(y[16]=[e("option",{value:"light"},"Light",-1),e("option",{value:"dark"},"Dark",-1)])],512),[[re,d.value]])]),e("div",Ha,[y[19]||(y[19]=e("label",{class:"form-label"},"Notifications",-1)),e("label",Ga,[P(e("input",{"onUpdate:modelValue":y[9]||(y[9]=x=>p.value=x),type:"checkbox"},null,512),[[we,p.value]]),y[18]||(y[18]=e("span",{class:"toggle-slider"},null,-1))])]),e("div",Ja,[y[21]||(y[21]=e("label",{class:"form-label"},"Language",-1)),P(e("select",{"onUpdate:modelValue":y[10]||(y[10]=x=>C.value=x),class:"form-input form-select"},[...y[20]||(y[20]=[e("option",{value:"en"},"English",-1),e("option",{value:"ru"},"Ð ÑƒÑÑÐºÐ¸Ð¹",-1),e("option",{value:"de"},"Deutsch",-1)])],512),[[re,C.value]])]),e("div",{class:"modal-actions"},[e("button",{class:"btn btn-primary",onClick:U},"Save Settings")])],512),[[oe,i.value==="settings"]])])])]))}}),ja={class:"modal"},qa={class:"modal-header"},Ka={class:"modal-body user-profile-body"},Ya={key:0},Qa={class:"profile-avatar-section"},Xa={class:"user-profile-name"},es={class:"user-profile-username"},ts={class:"user-id-display"},as={key:0,class:"user-profile-bio"},ss={class:"modal-actions",style:{"justify-content":"center"}},ns={key:2},os=I({__name:"UserProfileModal",props:{username:{}},emits:["close","message"],setup(t,{emit:s}){const o=t,c=s,a=b(null),h=b(!0);return W(async()=>{try{a.value=await he(o.username)}catch{a.value=null}finally{h.value=!1}}),(i,u)=>(g(),k("div",{class:"modal-backdrop",onClick:u[2]||(u[2]=z(m=>c("close"),["self"]))},[e("div",ja,[e("div",qa,[u[3]||(u[3]=e("h2",{class:"modal-title"},"User Profile",-1)),e("button",{class:"icon-btn",onClick:u[0]||(u[0]=m=>c("close"))},"âœ•")]),e("div",Ka,[h.value?(g(),k("p",Ya,"Loading...")):a.value?(g(),k(V,{key:1},[e("div",Qa,[B(H,{name:a.value.display_name||a.value.username,url:a.value.avatar_url,size:"xl"},null,8,["name","url"])]),e("div",Xa,[ee(D(a.value.display_name||a.value.username)+" ",1),a.value.is_admin?(g(),E(be,{key:0})):M("",!0)]),e("div",es,"@"+D(a.value.username),1),e("div",ts,"ID: "+D(a.value.id),1),a.value.bio?(g(),k("div",as,D(a.value.bio),1)):M("",!0),e("div",ss,[e("button",{class:"btn btn-primary",onClick:u[1]||(u[1]=m=>c("message",a.value.username))}," âœŽ Message ")])],64)):(g(),k("p",ns,"User not found"))])])]))}}),ls={class:"modal",style:{"max-width":"420px"}},is={class:"modal-header"},rs={class:"modal-body",style:{display:"flex","flex-direction":"column",gap:"12px"}},cs=I({__name:"DownloadModal",emits:["close"],setup(t,{emit:s}){const o=s,c=navigator.userAgent.toLowerCase(),a=c.includes("win"),h=c.includes("mac")&&!c.includes("iphone")&&!c.includes("ipad"),i=F(()=>a?"Windows":h?"macOS":null);function u(){a?window.location.href="/downloads/windows/MessengerSetup.exe":h&&(window.location.href="/downloads/macos/Messenger.dmg")}return(m,l)=>(g(),k("div",{class:"modal-backdrop",onClick:l[1]||(l[1]=z(r=>o("close"),["self"]))},[e("div",ls,[e("div",is,[l[2]||(l[2]=e("h2",{class:"modal-title"},"Download Simple Messenger",-1)),e("button",{class:"icon-btn","aria-label":"Close",onClick:l[0]||(l[0]=r=>o("close"))},"âœ•")]),e("div",rs,[i.value?(g(),k("button",{key:0,class:"btn btn-primary btn-full",onClick:u}," Download for "+D(i.value),1)):M("",!0),l[3]||(l[3]=Ce('<details><summary style="cursor:pointer;color:var(--accent);">Other platforms</summary><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"><a href="/downloads/windows/MessengerSetup.exe" class="btn btn-ghost btn-full" download>Windows installer (.exe)</a><a href="/downloads/macos/Messenger.dmg" class="btn btn-ghost btn-full" download>macOS installer (.dmg)</a></div></details><p style="font-size:0.8rem;color:var(--text-muted);margin:0;"> Files not available yet? Check back soon. </p>',2))])])]))}}),us=I({__name:"ContextMenu",setup(t){const s=G(),{showToast:o}=j(),c=b(!1),a=b(0),h=b(0),i=b(null),u=F(()=>i.value?s.chats.find(p=>p.id===i.value)??null:null);function m(p){i.value=p.detail.chatId,a.value=p.detail.x,h.value=p.detail.y,c.value=!0}function l(){c.value&&(c.value=!1,i.value=null)}W(()=>{window.addEventListener("show-context-menu",m),document.addEventListener("click",l)}),se(()=>{window.removeEventListener("show-context-menu",m),document.removeEventListener("click",l)});async function r(){if(i.value){c.value=!1;try{await s.toggleFavorite(i.value)}catch{o("Failed to update favorite")}}}async function n(){if(i.value){c.value=!1;try{await s.toggleMute(i.value)}catch{o("Failed to update mute")}}}async function d(){if(i.value&&(c.value=!1,!!confirm("Leave this chat?")))try{await s.leave(i.value),o("Left chat")}catch{o("Failed to leave chat")}}return(p,C)=>c.value?(g(),k("div",{key:0,class:"context-menu",style:$e({left:a.value+"px",top:h.value+"px"})},[e("button",{class:"ctx-item",onClick:r},D(u.value?.is_favorite?"â˜… Unstar":"â˜† Star"),1),e("button",{class:"ctx-item",onClick:n},D(u.value?.is_muted?"Unmute":"Mute"),1),u.value&&u.value.type!=="direct"?(g(),k("button",{key:0,class:"ctx-item ctx-leave",onClick:d}," Leave chat ")):M("",!0)],4)):M("",!0)}}),ms=I({__name:"MessengerView",setup(t){const s=Se(),o=me(),c=te(),a=G(),h=fe(),{showToast:i}=j(),{connect:u,disconnect:m}=Ve(),l=b(!1),r=b(!1),n=b(!1),d=b(!1),p=b(null),C=b([]);de("stickers",C);let S=null;W(async()=>{await h.loadSettings();try{C.value=await He()}catch{}await a.loadChats(),u(),S=setInterval(()=>a.loadChats(),5e3),N()}),se(()=>{m(),S&&(clearInterval(S),S=null)}),ve(()=>s.path,()=>{N()});async function N(){const _=s.path;if(_.startsWith("/@")){const v=s.params.username;v&&(p.value=v)}else if(_.startsWith("/u/")){const v=s.params.id;if(v)try{const w=await Ae(parseInt(v));p.value=w.username}catch{i("User not found")}}else if(_.startsWith("/dm/")){const v=s.params.id;v&&await U(v)}else if(_.startsWith("/c/")){const v=s.params.name;v&&await R(v)}}async function U(_){try{let v;if(_.startsWith("@")){const f=_.substring(1);if(c.user?.username===f){p.value=f;return}v=(await he(f)).id}else if(v=parseInt(_),c.user?.id===v){i("Cannot open DM with yourself");return}const w=await ae({type:"direct",member_ids:[v]});await a.loadChats(),a.setActiveChat(w.id)}catch{i("Failed to open conversation")}}async function R(_){try{const v=await Le(_);a.chats.find(f=>f.id===v.id)?a.setActiveChat(v.id):i("You are not a member of this channel")}catch{i("Channel not found")}}function y(_){a.setActiveChat(_),o.replace("/app")}function x(){a.setActiveChat(null)}function q(){l.value=!1,n.value=!0}function K(_){p.value=_}async function Y(_){p.value=null,await U("@"+_)}async function Q(_){r.value=!1,await a.loadChats(),a.setActiveChat(_)}function J(_){if(_.key==="Escape"){if(p.value){p.value=null;return}if(r.value){r.value=!1;return}if(n.value){n.value=!1;return}if(d.value){d.value=!1;return}if(l.value){l.value=!1;return}if(a.activeChatId!==null){x();return}}}return W(()=>document.addEventListener("keydown",J)),se(()=>document.removeEventListener("keydown",J)),(_,v)=>(g(),k("div",{class:A(["layout",{"chat-open":!!T(a).activeChatId}])},[B(sa,{open:l.value,onClose:v[0]||(v[0]=w=>l.value=!1),onOpenProfile:q,onOpenDownload:v[1]||(v[1]=w=>d.value=!0)},null,8,["open"]),e("div",{class:A(["drawer-overlay",{visible:l.value}]),onClick:v[2]||(v[2]=w=>l.value=!1)},null,2),B(it,{onOpenDrawer:v[3]||(v[3]=w=>l.value=!0),onOpenNewChat:v[4]||(v[4]=w=>r.value=!0),onSelectChat:y}),B(Kt,{onBack:x,onOpenUserProfile:K}),r.value?(g(),E(La,{key:0,onClose:v[5]||(v[5]=w=>r.value=!1),onChatCreated:Q})):M("",!0),n.value?(g(),E(Za,{key:1,onClose:v[6]||(v[6]=w=>n.value=!1)})):M("",!0),p.value?(g(),E(os,{key:2,username:p.value,onClose:v[7]||(v[7]=w=>p.value=null),onMessage:Y},null,8,["username"])):M("",!0),d.value?(g(),E(cs,{key:3,onClose:v[8]||(v[8]=w=>d.value=!1)})):M("",!0),B(us)],2))}});export{ms as default};
