import{k as N,l as ce,r as _,m as P,n as se,u as q,d as I,o as g,c as w,w as H,p as V,g as O,a as e,b as T,f as ae,t as D,e as F,v as B,F as W,q as Z,s as E,x as L,y as ie,z as oe,A as z,B as _e,C as K,D as me,E as re,G as te,j as fe,H as ue,I as we,J as Ce,K as $e,L as Se}from"./index-D3i7W5xh.js";import{_ as G,l as xe,c as Me,r as Te}from"./invites-BB50HFFc.js";async function De(){const{data:t}=await N.get("/chats");return t}async function Ue(t){const{data:n}=await N.get(`/chats/${t}`);return n}async function Le(t){const{data:n}=await N.get(`/chats/by-name/${encodeURIComponent(t)}`);return n}async function ne(t){const{data:n}=await N.post("/chats",t);return n}async function Ne(t){await N.post(`/chats/${t}/favorite`)}async function Pe(t){await N.delete(`/chats/${t}/favorite`)}async function Fe(t,n){await N.post(`/chats/${t}/mute`,{})}async function Ie(t){await N.delete(`/chats/${t}/mute`)}async function Re(t){await N.delete(`/chats/${t}/leave`)}async function Oe(t){await N.post(`/chats/${t}/read`)}const J=ce("chats",()=>{const t=_([]),n=_(null),s=_({}),c=P(()=>t.value.find(m=>m.id===n.value)??null),a=P(()=>[...t.value].sort((m,k)=>{if(m.is_favorite&&!k.is_favorite)return-1;if(!m.is_favorite&&k.is_favorite)return 1;const S=m.last_at||m.updated_at||"";return(k.last_at||k.updated_at||"").localeCompare(S)}));async function y(){try{t.value=await De()}catch(m){console.error("Failed to load chats",m)}}function l(m){if(n.value=m,m!==null){const k=t.value.find(S=>S.id===m);k&&k.unread_count>0&&(k.unread_count=0,Oe(m).catch(()=>{}))}}async function d(m){const k=t.value.find(S=>S.id===m);if(k)try{k.is_favorite?await Pe(m):await Ne(m),k.is_favorite=!k.is_favorite}catch(S){throw console.error("Failed to toggle favorite",S),S}}async function C(m){const k=t.value.find(S=>S.id===m);if(k)try{k.is_muted?await Ie(m):await Fe(m),k.is_muted=!k.is_muted}catch(S){throw console.error("Failed to toggle mute",S),S}}async function v(m){await Re(m),t.value=t.value.filter(k=>k.id!==m),n.value===m&&(n.value=null)}function r(m,k,S){const M=t.value.find(f=>f.id===m);M&&(M.last_message=k,M.last_at=S)}function i(m){const k=t.value.find(S=>S.id===m);k&&(k.unread_count=(k.unread_count||0)+1)}function h(m,k,S){s.value[m]||(s.value[m]={});const M=s.value[m][k];M&&clearTimeout(M.timer);const f=setTimeout(()=>{b(m,k)},3e3);s.value[m][k]={username:S,timer:f}}function b(m,k){if(s.value[m]){const S=s.value[m][k];S&&(clearTimeout(S.timer),delete s.value[m][k])}}function $(m){const k=s.value[m];return k?Object.values(k).map(S=>S.username):[]}return{chats:t,activeChatId:n,activeChat:c,sortedChats:a,typingUsers:s,loadChats:y,setActiveChat:l,toggleFavorite:d,toggleMute:C,leave:v,updateChatLastMessage:r,incrementUnread:i,setTyping:h,clearTyping:b,getTypingUsernames:$}});async function Be(){const{data:t}=await N.get("/settings");return t}async function Ee(t){await N.put("/settings",t)}const pe=ce("settings",()=>{const t=_(localStorage.getItem("theme")||"light"),n=_(!0),s=_("en");function c(l){t.value=l,document.body.setAttribute("data-theme",l),localStorage.setItem("theme",l)}async function a(){try{const l=await Be();c(l.theme||"light"),n.value=l.notifications_enabled,s.value=l.language||"en"}catch(l){console.error("Failed to load settings",l)}}async function y(l){await Ee(l),l.theme&&c(l.theme),l.notifications_enabled!==void 0&&(n.value=l.notifications_enabled),l.language&&(s.value=l.language)}return document.body.setAttribute("data-theme",t.value),{theme:t,notificationsEnabled:n,language:s,applyTheme:c,loadSettings:a,saveSettings:y}});async function le(t,n){const{data:s}=await N.get(`/chats/${t}/messages`,{params:n});return s}async function Ve(t,n){const{data:s}=await N.post(`/chats/${t}/messages`,n);return s}const he=ce("messages",()=>{const t=_({}),n=_({}),s=_(null);async function c(v){s.value=v;try{const r=await le(v,{limit:50});t.value[v]=r,r.length>0&&(n.value[v]=Math.max(...r.map(i=>i.id)))}catch(r){throw console.error("Failed to load messages",r),r}finally{s.value=null}}async function a(v){const r=n.value[v]||0;if(r===0)return[];try{const i=await le(v,{after_id:r,limit:50});if(i.length>0){t.value[v]||(t.value[v]=[]);const h=new Set(t.value[v].map($=>$.id)),b=i.filter($=>!h.has($.id));t.value[v].push(...b),n.value[v]=Math.max(...i.map($=>$.id))}return i}catch(i){return console.error("Failed to load newer messages",i),[]}}async function y(v){const r=t.value[v];if(!r||r.length===0)return[];const i=r[0];if(!i)return[];try{const h=await le(v,{before:i.created_at,limit:50});if(h.length>0){const b=new Set(r.map(m=>m.id)),$=h.filter(m=>!b.has(m.id));t.value[v]=[...$,...r]}return h}catch(h){return console.error("Failed to load older messages",h),[]}}async function l(v,r,i="text",h){const b=await Ve(v,{content:r,type:i,...h});return t.value[v]||(t.value[v]=[]),t.value[v].push(b),n.value[v]=Math.max(n.value[v]||0,b.id),b}function d(v,r){t.value[v]||(t.value[v]=[]),t.value[v].find(h=>h.id===r.id)||(t.value[v].push(r),n.value[v]=Math.max(n.value[v]||0,r.id))}function C(v){return t.value[v]||[]}return{messagesByChat:t,lastMsgId:n,loadingChat:s,loadMessages:c,loadNewer:a,loadOlder:y,sendMessage:l,pushMessage:d,getMessages:C}});function We(){const t=_(!1);let n=null,s=null,c=null,a=1e3,y=!1;function l(){const m=localStorage.getItem("access_token");return m?`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?token=${encodeURIComponent(m)}`:null}function d(){if(n&&(n.readyState===WebSocket.OPEN||n.readyState===WebSocket.CONNECTING))return;const m=l();m&&(y=!1,n=new WebSocket(m),n.onopen=()=>{t.value=!0,a=1e3;const k=localStorage.getItem("access_token");k&&n.send(JSON.stringify({type:"auth",token:k}));const S=J();for(const M of S.chats)n.send(JSON.stringify({type:"subscribe",chat_id:M.id}));v()},n.onmessage=k=>{try{const S=JSON.parse(k.data);C(S)}catch{}},n.onclose=()=>{t.value=!1,r(),y||i()},n.onerror=()=>{})}function C(m){const k=he(),S=J(),M=q();switch(m.type){case"message":{const f=m;k.pushMessage(f.chat_id,f),S.updateChatLastMessage(f.chat_id,f.content||(f.message_type==="sticker"?"Sticker":"Attachment"),f.created_at),f.chat_id!==S.activeChatId&&f.sender_id!==M.user?.id&&S.incrementUnread(f.chat_id),S.clearTyping(f.chat_id,f.sender_id);break}case"typing":{const f=m.chat_id,x=m.user_id;if(x!==M.user?.id){const A=m.username||"Someone";S.setTyping(f,x,A)}break}}}function v(){r(),c=setInterval(()=>{n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"ping"}))},25e3)}function r(){c&&(clearInterval(c),c=null)}function i(){s||(s=setTimeout(()=>{s=null,d(),a=Math.min(a*2,3e4)},a))}function h(m){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"subscribe",chat_id:m}))}function b(m){n&&n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"typing",chat_id:m}))}function $(){y=!0,r(),s&&(clearTimeout(s),s=null),n&&(n.close(),n=null),t.value=!1}return se(()=>{$()}),{connected:t,connect:d,disconnect:$,subscribeToChat:h,sendTyping:b}}async function Ae(t){const{data:n}=await N.get(`/users/${t}`);return n}async function ge(t){const{data:n}=await N.get(`/users/by-username/${encodeURIComponent(t)}`);return n}async function de(t){const{data:n}=await N.get("/users/search",{params:{q:t}});return n}async function ze(t,n){const{data:s}=await N.put(`/users/${t}`,n);return s}async function He(t){const{data:n}=await N.put("/users/me/avatar",{file_id:t});return n}async function Ge(){const{data:t}=await N.get("/stickers");return t}const Je={class:"chat-item-info"},je={class:"chat-item-top"},Ze={class:"chat-item-name"},qe={key:0,class:"ci-channel"},Ke={key:1,class:"ci-group"},Ye={key:2,class:"mute-icon",title:"Muted"},Qe={key:0,class:"unread-badge"},Xe={class:"chat-item-time"},et={class:"chat-item-preview"},tt=["title"],ve=I({__name:"ChatListItem",props:{chat:{},active:{type:Boolean}},emits:["select","toggleFavorite","contextmenu"],setup(t,{emit:n}){const s=t,c=n,a=P(()=>{const l=s.chat;return l.type==="channel"||l.type==="group"?l.title||l.name||"Untitled":l.other_display_name||l.other_username||l.title||l.name||"Chat"});function y(l){if(!l)return"";const d=new Date(l.endsWith("Z")?l:l+"Z"),C=new Date;return d.toDateString()===C.toDateString()?d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):d.toLocaleDateString([],{month:"short",day:"numeric"})}return(l,d)=>(g(),w("div",{class:V(["chat-item",{active:t.active}]),onClick:d[1]||(d[1]=C=>c("select")),onContextmenu:d[2]||(d[2]=H(C=>c("contextmenu",C),["prevent"]))},[O(G,{name:a.value,url:t.chat.other_avatar_url,size:"sm"},null,8,["name","url"]),e("div",Je,[e("div",je,[e("span",Ze,[t.chat.type==="channel"?(g(),w("span",qe)):t.chat.type==="group"?(g(),w("span",Ke)):T("",!0),ae(" "+D(a.value)+" ",1),t.chat.is_muted?(g(),w("span",Ye,"ðŸ””")):T("",!0)]),t.chat.unread_count>0?(g(),w("span",Qe,D(t.chat.unread_count>99?"99+":t.chat.unread_count),1)):T("",!0),e("span",Xe,D(y(t.chat.last_at||t.chat.updated_at)),1)]),e("div",et,D(t.chat.last_message||""),1)]),e("button",{class:V(["star-btn",{"star-active":t.chat.is_favorite}]),title:t.chat.is_favorite?"Unstar":"Star",onClick:d[0]||(d[0]=H(C=>c("toggleFavorite"),["stop"]))},"â˜…",10,tt)],34))}}),at={class:"sidebar"},nt={class:"sidebar-header"},st={class:"search-wrap"},ot={class:"chat-list"},lt={key:0,class:"empty-state-small"},it={key:0,class:"chat-section-label"},rt={key:1,class:"chat-section-label"},ct=I({__name:"Sidebar",emits:["openDrawer","openNewChat","selectChat"],setup(t,{emit:n}){const s=n,c=J(),a=_(""),y=P(()=>{const i=a.value.toLowerCase();return i?c.sortedChats.filter(h=>{const b=C(h).toLowerCase(),$=(h.other_username||"").toLowerCase();return b.includes(i)||$.includes(i)}):c.sortedChats}),l=P(()=>y.value.filter(i=>i.is_favorite)),d=P(()=>y.value.filter(i=>!i.is_favorite));function C(i){return i.type==="channel"||i.type==="group"?i.title||i.name||"Untitled":i.other_display_name||i.other_username||i.title||i.name||"Chat"}const v=_(null);ie("contextChatId",v);function r(i,h){i.preventDefault(),v.value=h,window.dispatchEvent(new CustomEvent("show-context-menu",{detail:{x:i.clientX,y:i.clientY,chatId:h}}))}return(i,h)=>(g(),w("aside",at,[e("header",nt,[e("button",{class:"icon-btn","aria-label":"Menu",onClick:h[0]||(h[0]=b=>s("openDrawer"))},"â˜°"),e("div",st,[F(e("input",{"onUpdate:modelValue":h[1]||(h[1]=b=>a.value=b),class:"search-input",type:"search",placeholder:"Search chats..."},null,512),[[B,a.value]])]),e("button",{class:"icon-btn","aria-label":"New chat",title:"New chat",onClick:h[2]||(h[2]=b=>s("openNewChat"))},"âœŽ")]),e("div",ot,[y.value.length===0?(g(),w("div",lt,[...h[3]||(h[3]=[ae(" No conversations yet.",-1),e("br",null,null,-1),ae("Click âœŽ to start one. ",-1)])])):(g(),w(W,{key:1},[l.value.length>0?(g(),w("div",it,"Starred")):T("",!0),(g(!0),w(W,null,Z(l.value,b=>(g(),E(ve,{key:b.id,chat:b,active:b.id===L(c).activeChatId,onSelect:$=>s("selectChat",b.id),onToggleFavorite:$=>L(c).toggleFavorite(b.id),onContextmenu:$=>r($,b.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128)),l.value.length>0&&d.value.length>0?(g(),w("div",rt," All chats ")):T("",!0),(g(!0),w(W,null,Z(d.value,b=>(g(),E(ve,{key:b.id,chat:b,active:b.id===L(c).activeChatId,onSelect:$=>s("selectChat",b.id),onToggleFavorite:$=>L(c).toggleFavorite(b.id),onContextmenu:$=>r($,b.id)},null,8,["chat","active","onSelect","onToggleFavorite","onContextmenu"]))),128))],64))])]))}});function ut(){const t=_(!1),n=_(0);let s=null,c=[],a=null;async function y(){if(!navigator.mediaDevices?.getUserMedia)throw new Error("MediaDevices not supported");const r=await navigator.mediaDevices.getUserMedia({audio:!0});c=[],n.value=0,s=new MediaRecorder(r),s.ondataavailable=i=>{i.data.size&&c.push(i.data)},s.start(),t.value=!0,a=setInterval(()=>{n.value++},1e3)}function l(){return new Promise((r,i)=>{if(!s||s.state!=="recording"){i(new Error("Not recording"));return}s.onstop=()=>{s?.stream&&s.stream.getTracks().forEach(k=>k.stop()),C(),t.value=!1;const h=s?.mimeType||"audio/webm",b=h.includes("ogg")?"ogg":"webm",$=new Blob(c,{type:h}),m=new File([$],`voice.${b}`,{type:h});r(m)},s.stop()})}function d(){s&&s.state==="recording"&&(s.onstop=()=>{s?.stream&&s.stream.getTracks().forEach(r=>r.stop())},s.stop()),C(),t.value=!1,n.value=0}function C(){a&&(clearInterval(a),a=null)}function v(r){const i=Math.floor(r/60),h=r%60;return`${i}:${String(h).padStart(2,"0")}`}return{isRecording:t,seconds:n,startRecording:y,stopRecording:l,cancelRecording:d,formatTime:v}}async function ye(t){const n=new FormData;n.append("file",t);const{data:s}=await N.post("/files",n);return s}const dt={class:"chat-header"},vt={class:"chat-header-name"},mt=I({__name:"ChatHeader",emits:["back","openUserProfile"],setup(t,{emit:n}){const s=n,c=J(),a=P(()=>c.activeChat),y=P(()=>{const r=a.value;return r?r.type==="channel"||r.type==="group"?r.title||r.name||"Untitled":r.other_display_name||r.other_username||r.title||r.name||"Chat":"---"}),l=P(()=>a.value?c.getTypingUsernames(a.value.id):[]),d=P(()=>l.value.length>0),C=P(()=>{if(l.value.length===1)return`${l.value[0]} is typing...`;if(l.value.length>1)return`${l.value.length} people typing...`;const r=a.value;return r?r.type==="channel"?"Channel":r.type==="group"?"Group":r.other_username?"@"+r.other_username:"":""});function v(){a.value?.type==="direct"&&a.value.other_username&&s("openUserProfile",a.value.other_username)}return(r,i)=>(g(),w("header",dt,[e("button",{class:"icon-btn back-btn","aria-label":"Back",onClick:i[0]||(i[0]=h=>s("back"))},"â†"),O(G,{class:"chat-header-avatar",name:y.value,url:a.value?.other_avatar_url,onClick:v},null,8,["name","url"]),e("div",{class:"chat-header-info",onClick:v},[e("div",vt,D(y.value),1),e("div",{class:V(["chat-header-sub",{"typing-text":d.value}])},D(C.value),3)])]))}}),be=(t,n)=>{const s=t.__vccOpts||t;for(const[c,a]of n)s[c]=a;return s},ft={},pt={class:"admin-badge",title:"Admin"};function ht(t,n){return g(),w("span",pt,"âœ“")}const ke=be(ft,[["render",ht]]),gt={key:0,class:"msg-sender-name"},yt={key:1,class:"msg-bubble sticker-bubble"},bt=["src","alt"],kt={key:2,class:"msg-bubble"},_t={class:"voice-player"},wt=["src"],Ct={key:0,class:"voice-dur"},$t=["innerHTML"],St={class:"msg-time"},xt=I({__name:"MessageBubble",props:{message:{},isMine:{type:Boolean}},emits:["mentionClick"],setup(t,{emit:n}){const s=t,c=n,a=oe("stickers",_([])),y=P(()=>{if(s.message.sticker_url)return s.message.sticker_url;if(s.message.sticker_id){const i=a.value.find(h=>h.id===s.message.sticker_id);if(i)return i.url}return""}),l=P(()=>s.message.attachment_url||""),d=P(()=>C(s.message.content||"").replace(/@(\w{1,30})/g,`<span class="mention" data-u="$1" onclick="window.dispatchEvent(new CustomEvent('mention-click', {detail:'$1'}))">@$1</span>`));function C(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function v(i){if(!i)return"";const h=new Date(i.endsWith("Z")?i:i+"Z"),b=new Date;return h.toDateString()===b.toDateString()?h.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):h.toLocaleDateString([],{month:"short",day:"numeric"})}function r(i){const h=Math.floor(i/60),b=i%60;return`${h}:${String(b).padStart(2,"0")}`}return typeof window<"u"&&window.addEventListener("mention-click",(i=>{c("mentionClick",i.detail)})),(i,h)=>(g(),w("div",{class:V(["msg-row",t.isMine?"mine":"theirs"])},[!t.isMine&&t.message.message_type!=="sticker"?(g(),w("div",gt,[ae(D(t.message.sender_display_name||t.message.sender_username)+" ",1),t.message.sender_is_admin?(g(),E(ke,{key:0})):T("",!0)])):T("",!0),t.message.message_type==="sticker"?(g(),w("div",yt,[e("img",{class:"sticker-img",src:y.value,alt:t.message.sticker_label||"sticker"},null,8,bt)])):t.message.message_type==="voice"?(g(),w("div",kt,[e("div",_t,[e("audio",{controls:"",src:l.value},null,8,wt),t.message.duration_seconds?(g(),w("span",Ct,D(r(t.message.duration_seconds)),1)):T("",!0)])])):(g(),w("div",{key:3,class:"msg-bubble",innerHTML:d.value},null,8,$t)),e("div",St,D(v(t.message.created_at)),1)],2))}}),Mt={class:"composer"},Tt=["onKeydown"],Dt=I({__name:"Composer",props:{stickerPickerOpen:{type:Boolean}},emits:["send","toggleStickers","startRecording","typing"],setup(t,{expose:n,emit:s}){const c=s,a=_(""),y=_(null);let l=0;function d(){const r=a.value.trim();r&&(c("send",r),a.value="",v())}function C(){v();const r=Date.now();r-l>2e3&&a.value.trim().length>0&&(l=r,c("typing"))}function v(){const r=y.value;r&&(r.style.height="auto",r.style.height=Math.min(r.scrollHeight,120)+"px")}return z(()=>{y.value?.focus()}),n({focus:()=>y.value?.focus()}),(r,i)=>(g(),w("div",Mt,[e("button",{class:"icon-btn composer-btn","aria-label":"Stickers",title:"Stickers",onClick:i[0]||(i[0]=h=>c("toggleStickers"))},"ðŸŒ"),F(e("textarea",{ref_key:"inputRef",ref:y,"onUpdate:modelValue":i[1]||(i[1]=h=>a.value=h),class:"composer-input",placeholder:"Message...",rows:"1",maxlength:"4000",onKeydown:_e(H(d,["exact","prevent"]),["enter"]),onInput:C},null,40,Tt),[[B,a.value]]),e("button",{class:"icon-btn composer-btn record-btn","aria-label":"Voice message",title:"Record voice",onClick:i[2]||(i[2]=h=>c("startRecording"))},"ðŸŽ¤"),e("button",{class:"icon-btn composer-btn send-btn","aria-label":"Send",title:"Send",onClick:d},"âž¤")]))}}),Ut={class:"sticker-grid"},Lt=["title","onClick"],Nt=["src","alt"],Pt={key:0,class:"empty-state-small",style:{color:"var(--text-muted)"}},Ft=I({__name:"StickerPicker",emits:["select"],setup(t,{emit:n}){const s=n,c=oe("stickers",_([])),a=P(()=>c.value);return(y,l)=>(g(),w("div",Ut,[(g(!0),w(W,null,Z(a.value,d=>(g(),w("button",{key:d.id,class:"sticker-btn",title:d.label,onClick:C=>s("select",d.id)},[e("img",{src:d.url,alt:d.label},null,8,Nt)],8,Lt))),128)),a.value.length===0?(g(),w("div",Pt," No stickers available ")):T("",!0)]))}}),It={},Rt={class:"msgs-loading"};function Ot(t,n){return g(),w("div",Rt,"Loading...")}const Bt=be(It,[["render",Ot]]),Et={class:"invite-manage",style:{padding:"0 1rem .5rem"}},Vt={class:"invite-link-wrap"},Wt=["value"],At=I({__name:"InviteSection",props:{chatId:{}},setup(t){const n=t,{showToast:s}=K(),c=_("Loading..."),a=_("");async function y(){try{const C=await xe(n.chatId);if(C.length>0){const v=C[0];a.value=v.token,c.value=`${window.location.origin}/join/${v.token}`}else{const v=await Me(n.chatId);a.value=v.token,c.value=`${window.location.origin}/join/${v.token}`}}catch{c.value="Failed to generate invite"}}function l(){c.value&&navigator.clipboard&&navigator.clipboard.writeText(c.value).then(()=>s("Link copied!"))}async function d(){if(a.value)try{await Te(a.value),s("Invite revoked"),await y()}catch{s("Failed to revoke invite")}}return z(y),(C,v)=>(g(),w("div",Et,[v[0]||(v[0]=e("div",{class:"invite-manage-title"},"Invite Link",-1)),e("div",Vt,[e("input",{class:"form-input invite-link-input",value:c.value,type:"text",readonly:""},null,8,Wt),e("button",{class:"btn btn-sm btn-outline",title:"Copy link",onClick:l}," ðŸ“‹ ")]),e("button",{class:"btn btn-sm btn-ghost btn-danger",onClick:d}," Revoke link ")]))}}),zt={class:"chat-panel"},Ht={key:0,class:"empty-chat"},Gt={key:1,class:"chat-view"},Jt={key:0,class:"channel-readonly-bar"},jt={key:0,class:"date-sep"},Zt={key:1,class:"sticker-picker"},qt={key:3,class:"recording-bar"},Kt={class:"rec-time"},Yt=I({__name:"ChatPanel",emits:["back","openUserProfile"],setup(t,{emit:n}){const s=n,c=q(),a=J(),y=he(),{showToast:l}=K(),d=ut(),C=oe("stickers",_([])),v=oe("sendTyping",()=>{}),r=_(null),i=_(!1),h=_(!1),b=_("member"),$=_(!1);let m=null;const k=P(()=>a.activeChat?.type==="channel"&&b.value==="member"),S=P(()=>a.activeChatId?y.getMessages(a.activeChatId):[]),M=P(()=>{const u=[];let o="";for(const p of S.value){const R=f(p.created_at);R!==o&&(u.push({type:"date",label:R}),o=R),u.push({type:"msg",msg:p})}return u});function f(u){if(!u)return"";const o=new Date(u.endsWith("Z")?u:u+"Z"),p=new Date;if(o.toDateString()===p.toDateString())return"Today";const R=new Date(p);return R.setDate(p.getDate()-1),o.toDateString()===R.toDateString()?"Yesterday":o.toLocaleDateString([],{year:"numeric",month:"long",day:"numeric"})}me(()=>a.activeChatId,async u=>{if(i.value=!1,b.value="member",$.value=!1,m&&(clearInterval(m),m=null),!u)return;await y.loadMessages(u),await te(),x();const o=a.activeChat;if(o&&(o.type==="channel"||o.type==="group"))try{const p=await Ue(u);b.value=p.my_role||"member",$.value=b.value==="owner"||b.value==="admin"}catch{}m=setInterval(()=>{a.activeChatId===u&&y.loadNewer(u).then(p=>{p.length>0&&A()})},2500)});function x(){r.value&&(r.value.scrollTop=r.value.scrollHeight)}function A(){if(!r.value)return;const u=r.value;u.scrollHeight-u.scrollTop-u.clientHeight<80&&te(()=>{u.scrollTop=u.scrollHeight})}function Y(){a.activeChatId&&v(a.activeChatId)}async function Q(u){if(!(!a.activeChatId||!u.trim()))try{const o=await y.sendMessage(a.activeChatId,u.trim(),"text");c.user&&(o.sender_id=c.user.id,o.sender_username=c.user.username,o.sender_display_name=c.user.display_name),await te(),x(),a.loadChats()}catch{l("Failed to send message")}}async function X(u){if(a.activeChatId){i.value=!1;try{const o=await y.sendMessage(a.activeChatId,"","sticker",{sticker_id:u}),p=C.value.find(R=>R.id===u);p&&(o.sticker_url=p.url,o.sticker_label=p.label),await te(),x(),a.loadChats()}catch{l("Failed to send sticker")}}}async function ee(){try{await d.startRecording(),h.value=!0;const u=await d.stopRecording();h.value=!1,await U(u)}catch{h.value=!1,l("Microphone access denied")}}function j(){d.cancelRecording(),h.value=!1}async function U(u){if(a.activeChatId)try{const o=await ye(u);await y.sendMessage(a.activeChatId,"","voice",{file_id:o.id,duration_seconds:d.seconds.value}),await y.loadMessages(a.activeChatId),await te(),x(),a.loadChats()}catch{l("Failed to upload voice message")}}return(u,o)=>(g(),w("main",zt,[L(a).activeChatId?(g(),w("div",Gt,[O(mt,{onBack:o[0]||(o[0]=p=>s("back")),onOpenUserProfile:o[1]||(o[1]=p=>s("openUserProfile",p))}),k.value?(g(),w("div",Jt,[...o[5]||(o[5]=[e("span",{class:"readonly-icon"},"ðŸ”’",-1),e("span",{class:"readonly-text"},"Only admins can send messages in this channel.",-1)])])):T("",!0),e("div",{ref_key:"msgListRef",ref:r,class:"msg-list"},[L(y).loadingChat===L(a).activeChatId?(g(),E(Bt,{key:0})):(g(!0),w(W,{key:1},Z(M.value,p=>(g(),w(W,{key:p.type==="date"?"date-"+p.label:"msg-"+p.msg.id},[p.type==="date"?(g(),w("div",jt,[e("span",null,D(p.label),1)])):(g(),E(xt,{key:1,message:p.msg,"is-mine":p.msg.sender_id===L(c).user?.id,onMentionClick:o[2]||(o[2]=R=>s("openUserProfile",R))},null,8,["message","is-mine"]))],64))),128))],512),i.value?(g(),w("div",Zt,[O(Ft,{onSelect:X})])):T("",!0),k.value?T("",!0):F((g(),E(Dt,{key:2,"sticker-picker-open":i.value,onSend:Q,onToggleStickers:o[3]||(o[3]=p=>i.value=!i.value),onStartRecording:ee,onTyping:Y},null,8,["sticker-picker-open"])),[[re,!h.value]]),h.value?(g(),w("div",qt,[o[6]||(o[6]=e("span",{class:"rec-dot"},null,-1)),e("span",Kt,D(L(d).formatTime(L(d).seconds.value)),1),o[7]||(o[7]=e("span",{class:"rec-label"},"Recording... tap mic to stop",-1)),e("button",{class:"icon-btn rec-cancel",title:"Cancel",onClick:j},"âœ•")])):T("",!0),$.value?(g(),E(At,{key:4,"chat-id":L(a).activeChatId},null,8,["chat-id"])):T("",!0)])):(g(),w("div",Ht,[...o[4]||(o[4]=[e("div",{class:"empty-chat-icon"},"ðŸ’¬",-1),e("div",{class:"empty-chat-text"},"Select a chat to start messaging",-1)])]))]))}}),Qt={class:"drawer-header"},Xt={class:"drawer-avatar-wrap"},ea={class:"drawer-user-info"},ta={class:"drawer-display-name"},aa={class:"drawer-username"},na={class:"drawer-nav"},sa=I({__name:"Drawer",props:{open:{type:Boolean}},emits:["close","openProfile","openDownload"],setup(t,{emit:n}){const s=n,c=fe(),a=q();function y(){a.logout(),c.push("/login")}return(l,d)=>(g(),w("div",{class:V(["drawer",{open:t.open}])},[e("div",Qt,[e("button",{class:"icon-btn","aria-label":"Close menu",onClick:d[0]||(d[0]=C=>s("close"))},"âœ•"),d[3]||(d[3]=e("span",{class:"drawer-title"},"Menu",-1))]),e("div",Xt,[O(G,{name:L(a).user?.display_name||L(a).user?.username||"?",url:L(a).user?.avatar_url,size:"lg"},null,8,["name","url"]),e("div",ea,[e("div",ta,D(L(a).user?.display_name||L(a).user?.username||"---"),1),e("div",aa,"@"+D(L(a).user?.username||"---"),1)])]),e("nav",na,[e("button",{class:"drawer-nav-item",onClick:d[1]||(d[1]=C=>s("openProfile"))}," Profile & Settings "),e("button",{class:"drawer-nav-item",onClick:d[2]||(d[2]=C=>s("openDownload"))}," Download App "),e("button",{class:"drawer-nav-item",onClick:y}," Log out ")]),d[4]||(d[4]=e("div",{class:"drawer-footer"},"Simple Messenger v2",-1))],2))}}),oa={class:"modal"},la={class:"modal-header"},ia={class:"modal-body"},ra={key:0,class:"chat-type-cards"},ca={key:1,class:"new-chat-form"},ua={class:"user-pick-list"},da={key:0,class:"empty-state-small"},va={key:1,class:"empty-state-small"},ma=["onClick"],fa={class:"user-pick-name"},pa={class:"user-pick-handle"},ha={key:2,class:"new-chat-form"},ga={class:"form-group"},ya={class:"form-group"},ba={class:"form-group"},ka={class:"user-pick-list"},_a=["onClick"],wa={class:"user-pick-name"},Ca={class:"user-pick-handle"},$a={class:"modal-actions"},Sa=["disabled"],xa={key:3,class:"new-chat-form"},Ma={class:"form-group"},Ta={class:"form-group"},Da={class:"form-group"},Ua={class:"modal-actions"},La=["disabled"],Na=I({__name:"NewChatModal",emits:["close","chatCreated"],setup(t,{emit:n}){const s=n,c=q(),{showToast:a}=K(),y=_("select"),l=_(!1),d=_(""),C=_([]),v=_(!1);let r=null;const i=_(""),h=_(""),b=_(""),$=_([]),m=_(new Set);let k=null;const S=_(""),M=_(""),f=_("");z(()=>{x("")});async function x(u){v.value=!0;try{const o=await de(u);C.value=o.filter(p=>p.id!==c.user?.id)}catch{C.value=[]}finally{v.value=!1}}function A(){r&&clearTimeout(r),r=setTimeout(()=>x(d.value),300)}async function Y(u){try{$.value=await de(u)}catch{$.value=[]}}function Q(){k&&clearTimeout(k),k=setTimeout(()=>Y(b.value),300)}function X(u){m.value.has(u)?m.value.delete(u):m.value.add(u)}async function ee(u){l.value=!0;try{const o=await ne({type:"direct",member_ids:[u]});s("chatCreated",o.id)}catch{a("Failed to start conversation")}finally{l.value=!1}}async function j(){if(!i.value.trim()){a("Group name is required");return}l.value=!0;try{const u=await ne({type:"group",title:i.value.trim(),description:h.value.trim(),member_ids:Array.from(m.value)});a("Group created!"),s("chatCreated",u.id)}catch{a("Failed to create group")}finally{l.value=!1}}async function U(){if(!S.value.trim()){a("Channel name is required");return}l.value=!0;try{const u=await ne({type:"channel",title:S.value.trim(),description:f.value.trim(),public_name:M.value.trim()||void 0,member_ids:[]});a("Channel created!"),s("chatCreated",u.id)}catch{a("Failed to create channel")}finally{l.value=!1}}return(u,o)=>(g(),w("div",{class:"modal-backdrop",onClick:o[14]||(o[14]=H(p=>s("close"),["self"]))},[e("div",oa,[e("div",la,[o[15]||(o[15]=e("h2",{class:"modal-title"},"New Conversation",-1)),e("button",{class:"icon-btn",onClick:o[0]||(o[0]=p=>s("close"))},"âœ•")]),e("div",ia,[y.value==="select"?(g(),w("div",ra,[e("button",{class:"chat-type-card",onClick:o[1]||(o[1]=p=>y.value="direct")},[...o[16]||(o[16]=[e("span",{class:"chat-type-icon"},"ðŸ‘¤",-1),e("div",null,[e("div",{class:"chat-type-label"},"Direct Chat"),e("div",{class:"chat-type-desc"},"Private 1-on-1 conversation")],-1)])]),e("button",{class:"chat-type-card",onClick:o[2]||(o[2]=p=>y.value="group")},[...o[17]||(o[17]=[e("span",{class:"chat-type-icon"},"ðŸ‘¥",-1),e("div",null,[e("div",{class:"chat-type-label"},"Group Chat"),e("div",{class:"chat-type-desc"},"Chat with multiple people")],-1)])]),e("button",{class:"chat-type-card",onClick:o[3]||(o[3]=p=>y.value="channel")},[...o[18]||(o[18]=[e("span",{class:"chat-type-icon"},"ðŸ“¢",-1),e("div",null,[e("div",{class:"chat-type-label"},"Channel"),e("div",{class:"chat-type-desc"},"Broadcast to subscribers")],-1)])])])):T("",!0),y.value==="direct"?(g(),w("div",ca,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:o[4]||(o[4]=p=>y.value="select")}," â† Back "),F(e("input",{"onUpdate:modelValue":o[5]||(o[5]=p=>d.value=p),class:"search-input",type:"search",placeholder:"Search users...",onInput:A},null,544),[[B,d.value]]),e("div",ua,[v.value?(g(),w("div",da,"Loading users...")):C.value.length===0?(g(),w("div",va,"No users found.")):(g(!0),w(W,{key:2},Z(C.value,p=>(g(),w("div",{key:p.id,class:"user-pick-item",onClick:R=>ee(p.id)},[O(G,{name:p.display_name||p.username,url:p.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",fa,D(p.display_name||p.username),1),e("div",pa,"@"+D(p.username),1)])],8,ma))),128))])])):T("",!0),y.value==="group"?(g(),w("div",ha,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:o[6]||(o[6]=p=>y.value="select")}," â† Back "),e("div",ga,[o[19]||(o[19]=e("label",{class:"form-label"},"Group name",-1)),F(e("input",{"onUpdate:modelValue":o[7]||(o[7]=p=>i.value=p),class:"form-input",type:"text",maxlength:"64",placeholder:"My Group"},null,512),[[B,i.value]])]),e("div",ya,[o[20]||(o[20]=e("label",{class:"form-label"},"Description (optional)",-1)),F(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=p=>h.value=p),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this group about?"},null,512),[[B,h.value]])]),e("div",ba,[o[21]||(o[21]=e("label",{class:"form-label"},"Add members",-1)),F(e("input",{"onUpdate:modelValue":o[9]||(o[9]=p=>b.value=p),class:"search-input",type:"search",placeholder:"Search users...",onInput:Q},null,544),[[B,b.value]]),e("div",ka,[(g(!0),w(W,null,Z($.value,p=>(g(),w("div",{key:p.id,class:V(["user-pick-item",{selected:m.value.has(p.id)}]),onClick:R=>X(p.id)},[O(G,{name:p.display_name||p.username,url:p.avatar_url,size:"sm"},null,8,["name","url"]),e("div",null,[e("div",wa,D(m.value.has(p.id)?"âœ“ ":"")+D(p.display_name||p.username),1),e("div",Ca,"@"+D(p.username),1)])],10,_a))),128))])]),e("div",$a,[e("button",{class:"btn btn-primary",disabled:l.value,onClick:j}," Create Group ",8,Sa)])])):T("",!0),y.value==="channel"?(g(),w("div",xa,[e("button",{class:"btn btn-ghost btn-sm new-chat-back-btn",onClick:o[10]||(o[10]=p=>y.value="select")}," â† Back "),e("div",Ma,[o[22]||(o[22]=e("label",{class:"form-label"},"Channel name",-1)),F(e("input",{"onUpdate:modelValue":o[11]||(o[11]=p=>S.value=p),class:"form-input",type:"text",maxlength:"64",placeholder:"My Channel"},null,512),[[B,S.value]])]),e("div",Ta,[o[23]||(o[23]=e("label",{class:"form-label"},"Public link name (optional)",-1)),F(e("input",{"onUpdate:modelValue":o[12]||(o[12]=p=>M.value=p),class:"form-input",type:"text",maxlength:"64",placeholder:"my-channel"},null,512),[[B,M.value]]),o[24]||(o[24]=e("small",{class:"form-hint"},"Letters, numbers, hyphens, underscores. Used for /c/your-name links.",-1))]),e("div",Da,[o[25]||(o[25]=e("label",{class:"form-label"},"Description (optional)",-1)),F(e("textarea",{"onUpdate:modelValue":o[13]||(o[13]=p=>f.value=p),class:"form-input",maxlength:"200",rows:"2",placeholder:"What is this channel about?"},null,512),[[B,f.value]])]),e("div",Ua,[e("button",{class:"btn btn-primary",disabled:l.value,onClick:U}," Create Channel ",8,La)])])):T("",!0)])])]))}}),Pa={class:"modal modal-wide"},Fa={class:"modal-header"},Ia={class:"profile-tabs"},Ra={class:"modal-body profile-body"},Oa={class:"profile-avatar-section"},Ba={class:"user-id-display"},Ea={class:"form-group"},Va={class:"form-group"},Wa={key:0,class:"form-hint form-error"},Aa={class:"form-group"},za={class:"modal-actions"},Ha={class:"form-group form-inline"},Ga={class:"form-group form-inline"},Ja={class:"toggle"},ja={class:"form-group form-inline"},Za=I({__name:"ProfileModal",emits:["close"],setup(t,{emit:n}){const s=n,c=q(),a=pe(),{showToast:y}=K(),l=_("profile"),d=_(""),C=_(""),v=_(""),r=_(""),i=_(null),h=_("light"),b=_(!0),$=_("en");z(async()=>{c.user&&(d.value=c.user.display_name||"",C.value=c.user.username,v.value=c.user.bio||""),h.value=a.theme,b.value=a.notificationsEnabled,$.value=a.language});async function m(){const M=i.value?.files?.[0];if(M){try{const f=await ye(M),x=await He(f.id);c.updateUser({avatar_url:x.avatar_url}),y("Avatar updated!")}catch{y("Upload failed")}i.value&&(i.value.value="")}}async function k(){if(r.value="",!c.user)return;const M={display_name:d.value.trim(),bio:v.value.trim()};C.value.trim()&&C.value.trim()!==c.user.username&&(M.username=C.value.trim());try{const f=await ze(c.user.id,M);c.updateUser({display_name:f.display_name,username:f.username}),y("Profile saved!"),s("close")}catch(f){f.response?.status===409?r.value="Username already taken":y("Save failed")}}async function S(){try{await a.saveSettings({theme:h.value,notifications_enabled:b.value,language:$.value}),y("Settings saved!"),s("close")}catch{y("Settings save failed")}}return(M,f)=>(g(),w("div",{class:"modal-backdrop",onClick:f[11]||(f[11]=H(x=>s("close"),["self"]))},[e("div",Pa,[e("div",Fa,[f[12]||(f[12]=e("h2",{class:"modal-title"},"Profile & Settings",-1)),e("button",{class:"icon-btn",onClick:f[0]||(f[0]=x=>s("close"))},"âœ•")]),e("div",Ia,[e("button",{class:V(["profile-tab",{active:l.value==="profile"}]),onClick:f[1]||(f[1]=x=>l.value="profile")},"Profile",2),e("button",{class:V(["profile-tab",{active:l.value==="settings"}]),onClick:f[2]||(f[2]=x=>l.value="settings")},"Settings",2)]),e("div",Ra,[F(e("div",null,[e("div",Oa,[O(G,{name:d.value||L(c).user?.username||"?",url:L(c).user?.avatar_url,size:"xl"},null,8,["name","url"]),e("button",{class:"btn btn-outline btn-sm",onClick:f[3]||(f[3]=x=>i.value?.click())}," Change photo "),e("input",{ref_key:"fileInput",ref:i,type:"file",accept:"image/*",class:"hidden",onChange:m},null,544),e("p",Ba,"ID: "+D(L(c).user?.id),1)]),e("div",Ea,[f[13]||(f[13]=e("label",{class:"form-label"},"Display name",-1)),F(e("input",{"onUpdate:modelValue":f[4]||(f[4]=x=>d.value=x),class:"form-input",type:"text",maxlength:"64",placeholder:"Your name"},null,512),[[B,d.value]])]),e("div",Va,[f[14]||(f[14]=e("label",{class:"form-label"},"Username",-1)),F(e("input",{"onUpdate:modelValue":f[5]||(f[5]=x=>C.value=x),class:"form-input",type:"text",maxlength:"20",placeholder:"username"},null,512),[[B,C.value]]),r.value?(g(),w("small",Wa,D(r.value),1)):T("",!0)]),e("div",Aa,[f[15]||(f[15]=e("label",{class:"form-label"},"Bio",-1)),F(e("textarea",{"onUpdate:modelValue":f[6]||(f[6]=x=>v.value=x),class:"form-input",maxlength:"200",rows:"3",placeholder:"About you..."},null,512),[[B,v.value]])]),e("div",za,[e("button",{class:"btn btn-primary",onClick:k},"Save Profile"),e("button",{class:"btn btn-ghost",onClick:f[7]||(f[7]=x=>s("close"))},"Cancel")])],512),[[re,l.value==="profile"]]),F(e("div",null,[e("div",Ha,[f[17]||(f[17]=e("label",{class:"form-label"},"Theme",-1)),F(e("select",{"onUpdate:modelValue":f[8]||(f[8]=x=>h.value=x),class:"form-input form-select"},[...f[16]||(f[16]=[e("option",{value:"light"},"Light",-1),e("option",{value:"dark"},"Dark",-1)])],512),[[ue,h.value]])]),e("div",Ga,[f[19]||(f[19]=e("label",{class:"form-label"},"Notifications",-1)),e("label",Ja,[F(e("input",{"onUpdate:modelValue":f[9]||(f[9]=x=>b.value=x),type:"checkbox"},null,512),[[we,b.value]]),f[18]||(f[18]=e("span",{class:"toggle-slider"},null,-1))])]),e("div",ja,[f[21]||(f[21]=e("label",{class:"form-label"},"Language",-1)),F(e("select",{"onUpdate:modelValue":f[10]||(f[10]=x=>$.value=x),class:"form-input form-select"},[...f[20]||(f[20]=[e("option",{value:"en"},"English",-1),e("option",{value:"ru"},"Ð ÑƒÑÑÐºÐ¸Ð¹",-1),e("option",{value:"de"},"Deutsch",-1)])],512),[[ue,$.value]])]),e("div",{class:"modal-actions"},[e("button",{class:"btn btn-primary",onClick:S},"Save Settings")])],512),[[re,l.value==="settings"]])])])]))}}),qa={class:"modal"},Ka={class:"modal-header"},Ya={class:"modal-body user-profile-body"},Qa={key:0},Xa={class:"profile-avatar-section"},en={class:"user-profile-name"},tn={class:"user-profile-username"},an={class:"user-id-display"},nn={key:0,class:"user-profile-bio"},sn={class:"modal-actions",style:{"justify-content":"center"}},on={key:2},ln=I({__name:"UserProfileModal",props:{username:{}},emits:["close","message"],setup(t,{emit:n}){const s=t,c=n,a=_(null),y=_(!0);return z(async()=>{try{a.value=await ge(s.username)}catch{a.value=null}finally{y.value=!1}}),(l,d)=>(g(),w("div",{class:"modal-backdrop",onClick:d[2]||(d[2]=H(C=>c("close"),["self"]))},[e("div",qa,[e("div",Ka,[d[3]||(d[3]=e("h2",{class:"modal-title"},"User Profile",-1)),e("button",{class:"icon-btn",onClick:d[0]||(d[0]=C=>c("close"))},"âœ•")]),e("div",Ya,[y.value?(g(),w("p",Qa,"Loading...")):a.value?(g(),w(W,{key:1},[e("div",Xa,[O(G,{name:a.value.display_name||a.value.username,url:a.value.avatar_url,size:"xl"},null,8,["name","url"])]),e("div",en,[ae(D(a.value.display_name||a.value.username)+" ",1),a.value.is_admin?(g(),E(ke,{key:0})):T("",!0)]),e("div",tn,"@"+D(a.value.username),1),e("div",an,"ID: "+D(a.value.id),1),a.value.bio?(g(),w("div",nn,D(a.value.bio),1)):T("",!0),e("div",sn,[e("button",{class:"btn btn-primary",onClick:d[1]||(d[1]=C=>c("message",a.value.username))}," âœŽ Message ")])],64)):(g(),w("p",on,"User not found"))])])]))}}),rn={class:"modal",style:{"max-width":"420px"}},cn={class:"modal-header"},un={class:"modal-body",style:{display:"flex","flex-direction":"column",gap:"12px"}},dn=I({__name:"DownloadModal",emits:["close"],setup(t,{emit:n}){const s=n,c=navigator.userAgent.toLowerCase(),a=c.includes("win"),y=c.includes("mac")&&!c.includes("iphone")&&!c.includes("ipad"),l=P(()=>a?"Windows":y?"macOS":null);function d(){a?window.location.href="/downloads/windows/MessengerSetup.exe":y&&(window.location.href="/downloads/macos/Messenger.dmg")}return(C,v)=>(g(),w("div",{class:"modal-backdrop",onClick:v[1]||(v[1]=H(r=>s("close"),["self"]))},[e("div",rn,[e("div",cn,[v[2]||(v[2]=e("h2",{class:"modal-title"},"Download Simple Messenger",-1)),e("button",{class:"icon-btn","aria-label":"Close",onClick:v[0]||(v[0]=r=>s("close"))},"âœ•")]),e("div",un,[l.value?(g(),w("button",{key:0,class:"btn btn-primary btn-full",onClick:d}," Download for "+D(l.value),1)):T("",!0),v[3]||(v[3]=Ce('<details><summary style="cursor:pointer;color:var(--accent);">Other platforms</summary><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"><a href="/downloads/windows/MessengerSetup.exe" class="btn btn-ghost btn-full" download>Windows installer (.exe)</a><a href="/downloads/macos/Messenger.dmg" class="btn btn-ghost btn-full" download>macOS installer (.dmg)</a></div></details><p style="font-size:0.8rem;color:var(--text-muted);margin:0;"> Files not available yet? Check back soon. </p>',2))])])]))}}),vn=I({__name:"ContextMenu",setup(t){const n=J(),{showToast:s}=K(),c=_(!1),a=_(0),y=_(0),l=_(null),d=P(()=>l.value?n.chats.find(b=>b.id===l.value)??null:null);function C(b){l.value=b.detail.chatId,a.value=b.detail.x,y.value=b.detail.y,c.value=!0}function v(){c.value&&(c.value=!1,l.value=null)}z(()=>{window.addEventListener("show-context-menu",C),document.addEventListener("click",v)}),se(()=>{window.removeEventListener("show-context-menu",C),document.removeEventListener("click",v)});async function r(){if(l.value){c.value=!1;try{await n.toggleFavorite(l.value)}catch{s("Failed to update favorite")}}}async function i(){if(l.value){c.value=!1;try{await n.toggleMute(l.value)}catch{s("Failed to update mute")}}}async function h(){if(l.value&&(c.value=!1,!!confirm("Leave this chat?")))try{await n.leave(l.value),s("Left chat")}catch{s("Failed to leave chat")}}return(b,$)=>c.value?(g(),w("div",{key:0,class:"context-menu",style:$e({left:a.value+"px",top:y.value+"px"})},[e("button",{class:"ctx-item",onClick:r},D(d.value?.is_favorite?"â˜… Unstar":"â˜† Star"),1),e("button",{class:"ctx-item",onClick:i},D(d.value?.is_muted?"Unmute":"Mute"),1),d.value&&d.value.type!=="direct"?(g(),w("button",{key:0,class:"ctx-item ctx-leave",onClick:h}," Leave chat ")):T("",!0)],4)):T("",!0)}}),pn=I({__name:"MessengerView",setup(t){const n=Se(),s=fe(),c=q(),a=J(),y=pe(),{showToast:l}=K(),{connect:d,disconnect:C,sendTyping:v}=We();ie("sendTyping",v);const r=_(!1),i=_(!1),h=_(!1),b=_(!1),$=_(null),m=_([]);ie("stickers",m);let k=null;z(async()=>{await y.loadSettings();try{m.value=await Ge()}catch{}await a.loadChats(),d(),k=setInterval(()=>a.loadChats(),5e3),S()}),se(()=>{C(),k&&(clearInterval(k),k=null)}),me(()=>n.path,()=>{S()});async function S(){const U=n.path;if(U.startsWith("/@")){const u=n.params.username;u&&($.value=u)}else if(U.startsWith("/u/")){const u=n.params.id;if(u)try{const o=await Ae(parseInt(u));$.value=o.username}catch{l("User not found")}}else if(U.startsWith("/dm/")){const u=n.params.id;u&&await M(u)}else if(U.startsWith("/c/")){const u=n.params.name;u&&await f(u)}}async function M(U){try{let u;if(U.startsWith("@")){const p=U.substring(1);if(c.user?.username===p){$.value=p;return}u=(await ge(p)).id}else if(u=parseInt(U),c.user?.id===u){l("Cannot open DM with yourself");return}const o=await ne({type:"direct",member_ids:[u]});await a.loadChats(),a.setActiveChat(o.id)}catch{l("Failed to open conversation")}}async function f(U){try{const u=await Le(U);a.chats.find(p=>p.id===u.id)?a.setActiveChat(u.id):l("You are not a member of this channel")}catch{l("Channel not found")}}function x(U){a.setActiveChat(U),s.replace("/app")}function A(){a.setActiveChat(null)}function Y(){r.value=!1,h.value=!0}function Q(U){$.value=U}async function X(U){$.value=null,await M("@"+U)}async function ee(U){i.value=!1,await a.loadChats(),a.setActiveChat(U)}function j(U){if(U.key==="Escape"){if($.value){$.value=null;return}if(i.value){i.value=!1;return}if(h.value){h.value=!1;return}if(b.value){b.value=!1;return}if(r.value){r.value=!1;return}if(a.activeChatId!==null){A();return}}}return z(()=>document.addEventListener("keydown",j)),se(()=>document.removeEventListener("keydown",j)),(U,u)=>(g(),w("div",{class:V(["layout",{"chat-open":!!L(a).activeChatId}])},[O(sa,{open:r.value,onClose:u[0]||(u[0]=o=>r.value=!1),onOpenProfile:Y,onOpenDownload:u[1]||(u[1]=o=>b.value=!0)},null,8,["open"]),e("div",{class:V(["drawer-overlay",{visible:r.value}]),onClick:u[2]||(u[2]=o=>r.value=!1)},null,2),O(ct,{onOpenDrawer:u[3]||(u[3]=o=>r.value=!0),onOpenNewChat:u[4]||(u[4]=o=>i.value=!0),onSelectChat:x}),O(Yt,{onBack:A,onOpenUserProfile:Q}),i.value?(g(),E(Na,{key:0,onClose:u[5]||(u[5]=o=>i.value=!1),onChatCreated:ee})):T("",!0),h.value?(g(),E(Za,{key:1,onClose:u[6]||(u[6]=o=>h.value=!1)})):T("",!0),$.value?(g(),E(ln,{key:2,username:$.value,onClose:u[7]||(u[7]=o=>$.value=null),onMessage:X},null,8,["username"])):T("",!0),b.value?(g(),E(dn,{key:3,onClose:u[8]||(u[8]=o=>b.value=!1)})):T("",!0),O(vn)],2))}});export{pn as default};
